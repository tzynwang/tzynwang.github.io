<!DOCTYPE html><html lang="en"> <head><meta name="astro-view-transitions-enabled" content="true"><meta name="astro-view-transitions-fallback" content="animate"><script type="module" src="/_astro/ClientRouter.astro_astro_type_script_index_0_lang.BScVxmeO.js"></script><!-- Google Tag Manager --><script>(function(){const ga4Id = "G-6QC9CKHCTY";

      (function (w, d, s, l, i) {
        w[l] = w[l] || [];
        w[l].push({ 'gtm.start': new Date().getTime(), event: 'gtm.js' });
        var f = d.getElementsByTagName(s)[0],
          j = d.createElement(s),
          dl = l != 'dataLayer' ? '&l=' + l : '';
        j.async = true;
        j.src = 'https://www.googletagmanager.com/gtm.js?id=' + i + dl;
        f.parentNode.insertBefore(j, f);
      })(window, document, 'script', 'dataLayer', ga4Id);
    })();</script><!-- Google tag (gtag.js) --><script async src="https://www.googletagmanager.com/gtag/js?id=GTM-KM9SGJLK">(function(){const gTagId = "GTM-KM9SGJLK";
})();</script><script>(function(){const ga4Id = "G-6QC9CKHCTY";

      window.dataLayer = window.dataLayer || [];
      function gtag() {
        dataLayer.push(arguments);
      }
      gtag('js', new Date());
      gtag('config', ga4Id);
    })();</script><!-- Global Metadata --><meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1"><link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>🦊</text></svg>"><link rel="sitemap" href="/sitemap-index.xml"><meta name="generator" content="Astro v5.1.2"><!-- Primary Meta Tags --><title>「JavaScript與parser blocking」相關筆記</title><meta name="title" content="「JavaScript與parser blocking」相關筆記"><meta name="description" content="這是一個文組轉職前端工程師的技術部落格"><!-- Open Graph / Facebook --><meta property="og:type" content="website"><meta property="og:url" content="https://tzynwang.github.io/2021/js-blocking"><meta property="og:title" content="「JavaScript與parser blocking」相關筆記"><meta property="og:description" content="這是一個文組轉職前端工程師的技術部落格"><meta property="og:image" content="https://tzynwang.github.io/alexander-andrews-mEdKuPYJe1I.jpg"><!-- Twitter --><meta property="twitter:card" content="summary_large_image"><meta property="twitter:url" content="https://tzynwang.github.io/2021/js-blocking"><meta property="twitter:title" content="「JavaScript與parser blocking」相關筆記"><meta property="twitter:description" content="這是一個文組轉職前端工程師的技術部落格"><meta property="twitter:image" content="https://tzynwang.github.io/alexander-andrews-mEdKuPYJe1I.jpg"><!-- Font --><link rel="preconnect" href="https://fonts.googleapis.com"><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin><link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;700&family=Noto+Sans:wght@400;700&display=swap" rel="stylesheet"><style>.tag[data-astro-cid-2iymvi75]{position:relative;display:inline-flex;align-items:center;padding:2px 8px;font-size:14px;font-weight:400;text-decoration:none;background-color:#8aa6a3;color:#fff;transition:background-color .2s ease-in-out}.tag[data-astro-cid-2iymvi75]:not(:last-of-type){margin-right:8px}.tag[data-astro-cid-2iymvi75]:hover{background-color:#127369}
.astro-route-announcer{position:absolute;left:0;top:0;clip:rect(0 0 0 0);clip-path:inset(50%);overflow:hidden;white-space:nowrap;width:1px;height:1px}.footer[data-astro-cid-qlgq3onj]{padding:36px;text-align:center}.bottom[data-astro-cid-qlgq3onj]{position:absolute;bottom:0;left:50%;transform:translate(-50%)}.side-content[data-astro-cid-75hifxor],.main-content[data-astro-cid-75hifxor]{margin:24px}nav[data-astro-cid-75hifxor]{display:flex;gap:16px}@media screen and (min-width: 800px){body{height:100vh;display:flex;flex-direction:row;overflow-y:hidden}nav[data-astro-cid-75hifxor]{flex-direction:column}.side-content[data-astro-cid-75hifxor]{flex:0 0 240px}.main-content[data-astro-cid-75hifxor]{margin:0;padding:40px 24px 0;flex:1 1 auto;overflow-y:auto;position:relative}}*{margin:0;padding:0;box-sizing:content-box;font-family:sans-serif;text-wrap:pretty;color:#000000e6}html{background-color:#bfbfbf66}a{color:#127369;font-weight:700;text-decoration:underline;text-decoration-color:transparent;transition:text-decoration-color .2s ease-in-out}a:hover{text-decoration-color:#127369}a.link-out{position:absolute;inset:0}ul,li{list-style-position:inside}ul:not(:has(li)){margin-top:16px;margin-bottom:16px}li{margin-top:4px;margin-bottom:4px;line-height:24px}li li{padding-left:16px}img{display:block;max-width:100%}h1,h2{font-size:28px;line-height:42px;margin:16px 0;color:#4c5958}h3,h4{font-size:22px;line-height:34px;margin:16px 0;color:#4c5958}h5{font-size:18px;line-height:28px;margin:4px 0;color:#4c5958}p{font-size:16px;line-height:24px;margin:16px 0}p code{font-size:14px}blockquote{padding-left:16px;border-left:4px solid #4c5958}blockquote *{font-family:Noto Sans,sans-serif}pre{padding:8px 16px}code,code span{font-family:monospace}hr{width:100%;height:1px;margin:16px 0;background-color:#4c5958}del{color:#4c5958e6}ol>li:has(p)>p{display:inline;margin:0}
.post-container[data-astro-cid-qtokga5y] h1[data-astro-cid-qtokga5y]{margin:0 0 16px}.info[data-astro-cid-qtokga5y]{display:flex;flex-direction:column;gap:8px}.toc-container[data-astro-cid-qtokga5y]{margin-bottom:0}.toc-container[data-astro-cid-qtokga5y]>li[data-astro-cid-qtokga5y]:not(:last-of-type){margin-bottom:4px}.toc-2[data-astro-cid-qtokga5y]{margin-left:1rem}.toc-3[data-astro-cid-qtokga5y]{margin-left:2rem}.toc-4[data-astro-cid-qtokga5y]{margin-left:3rem}.toc-5[data-astro-cid-qtokga5y]{margin-left:4rem}@media screen and (min-width: 800px){.post-container[data-astro-cid-qtokga5y]{max-width:600px}}@media screen and (min-width: 1200px){.post-container[data-astro-cid-qtokga5y]{max-width:720px}}
[data-astro-image]{width:100%;height:auto;object-fit:var(--fit);object-position:var(--pos);aspect-ratio:var(--w) / var(--h)}[data-astro-image=responsive]{max-width:calc(var(--w) * 1px);max-height:calc(var(--h) * 1px)}[data-astro-image=fixed]{width:calc(var(--w) * 1px);height:calc(var(--h) * 1px)}
</style></head> <body> <!-- Google Tag Manager (noscript) --> <noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-KM9SGJLK" height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript> <!-- End Google Tag Manager (noscript) --> <section class="side-content" data-astro-cid-75hifxor> <h1 data-astro-cid-75hifxor>普通文組 2.0</h1> <nav data-astro-cid-75hifxor> <a href="/" data-astro-cid-75hifxor>首頁</a> <a href="/archive" data-astro-cid-75hifxor>全文章歸檔</a> <a href="/tag" data-astro-cid-75hifxor>以標籤檢視</a> <a href="/rss.xml" data-astro-cid-75hifxor>RSS</a> </nav> </section> <section class="main-content" data-astro-cid-75hifxor>   <div class="post-container" data-astro-cid-qtokga5y> <h1 data-astro-cid-qtokga5y>「JavaScript與parser blocking」相關筆記</h1> <div class="info" data-astro-cid-qtokga5y> <span data-astro-cid-qtokga5y>2021-09-27 10:50</span> <span data-astro-cid-qtokga5y><a class="tag" href="/tag/JavaScript" data-astro-cid-2iymvi75> JavaScript </a> <a class="tag" href="/tag/Browser" data-astro-cid-2iymvi75> Browser </a> </span> <ul class="toc-container" data-astro-cid-qtokga5y> <li class="toc-2" data-astro-cid-qtokga5y> <a href="#原始問題" data-astro-cid-qtokga5y>原始問題</a> </li><li class="toc-2" data-astro-cid-qtokga5y> <a href="#回答" data-astro-cid-qtokga5y>回答</a> </li><li class="toc-2" data-astro-cid-qtokga5y> <a href="#筆記" data-astro-cid-qtokga5y>筆記</a> </li><li class="toc-3" data-astro-cid-qtokga5y> <a href="#預設行為" data-astro-cid-qtokga5y>預設行為</a> </li><li class="toc-3" data-astro-cid-qtokga5y> <a href="#解決方式" data-astro-cid-qtokga5y>解決方式</a> </li><li class="toc-3" data-astro-cid-qtokga5y> <a href="#async" data-astro-cid-qtokga5y>async</a> </li><li class="toc-3" data-astro-cid-qtokga5y> <a href="#defer" data-astro-cid-qtokga5y>defer</a> </li><li class="toc-3" data-astro-cid-qtokga5y> <a href="#critical-rendering-path" data-astro-cid-qtokga5y>Critical rendering path</a> </li><li class="toc-2" data-astro-cid-qtokga5y> <a href="#參考文件" data-astro-cid-qtokga5y>參考文件</a> </li> </ul> </div> <h2 id="原始問題">原始問題</h2>
<p>要在 HTML 檔案中使用<code>&#x3C;script></code>標籤載入 JavaScript 檔案時，一個常見的作法是「把<code>&#x3C;script></code>標籤放在<code>&#x3C;body></code>的最底部 (也就是<code>&#x3C;/body></code>前)」。請問：</p>
<ol>
<li>這樣做的話，在瀏覽器渲染流程中，會在什麼時機點載入到 JavaScript 程式碼？</li>
<li>為什麼需要這樣做？</li>
<li>如果我們想要「在 DOM 生成的同時，一併載入 JavaScript」，針對<code>script</code>標籤還有什麼其他的處理作法？</li>
</ol>
<h2 id="回答">回答</h2>
<ol>
<li>在瀏覽器完成 HTML parsing，DOM 建立完畢之後</li>
<li>避免 parser blocking，造成 critical rendering path 中的畫面載入延遲</li>
<li>加上<code>async</code>或<code>defer</code>；兩種 attribute 的差異是<code>async</code>會讓 JS 在 parse 完畢後<strong>馬上</strong>執行，而<code>defer</code>會讓 JS 在 HTML 文件 parse 完、<code>DOMContentLoaded</code>前執行</li>
</ol>
<h2 id="筆記">筆記</h2>
<h3 id="預設行為">預設行為</h3>
<blockquote>
<p>When the HTML parser encounters a <code>script</code> tag, it <strong>pauses its process of constructing the DOM</strong> and yields control to the JavaScript engine; after the JavaScript engine finishes running, the browser then picks up where it left off and resumes DOM construction.</p>
</blockquote>
<blockquote>
<p><strong>By default</strong>, JavaScript execution is <strong>parser blocking</strong>: when the browser encounters a script in the document it must pause DOM construction, hand over control to the JavaScript runtime, and let the script execute before proceeding with DOM construction.</p>
</blockquote>
<ul>
<li>在預設狀態下，瀏覽器在解析（parse）HTML 文件時如果遇到<code>script</code>標籤，會暫停解析、改去執行<code>script</code>中的內容；<code>script</code>裡面的內容被執行完畢後，瀏覽器才回頭繼續處理還未完成的 HTML parsing 作業</li>
<li>JavaScript 會造成 parser blocking</li>
</ul>
<blockquote>
<p>Before the browser can render a page it has to build the DOM tree by parsing the HTML markup. During this process, whenever the parser encounters a script it has to stop and execute it before it can continue parsing the HTML. In the case of an external script the parser is also forced to wait for the resource to download, which may incur one or more network roundtrips and <strong>delay the time to first render of the page</strong>.</p>
</blockquote>
<blockquote>
<p>What if the browser hasn’t finished downloading and building the CSSOM when we want to run our script? Answer: the browser <strong>delays script execution and DOM construction</strong> until it has finished downloading and constructing the CSSOM. <strong>JavaScript execution pauses until the CSSOM is ready</strong>.</p>
</blockquote>
<blockquote>
<p>CSS Object Model (CSSOM) is transformed from CSS markup.</p>
</blockquote>
<blockquote>
<p><strong>CSS is render blocking</strong>: the browser blocks page rendering until it receives and processes all of the CSS. CSS is render blocking because rules can be overwritten, so the content can’t be rendered until the CSSOM is complete.</p>
</blockquote>
<ul>
<li>瀏覽器一定會等到 CSS Object Model（CSSOM，瀏覽器透過解析 CSS 樣式表建立之）建立完畢後，才會去執行<code>script</code>中的內容</li>
</ul>
<h3 id="解決方式">解決方式</h3>
<p>在<code>script</code>標籤加上<code>async</code>或<code>defer</code></p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="html"><code><span class="line"><span style="color:#E1E4E8">&#x3C;</span><span style="color:#85E89D">script</span><span style="color:#B392F0"> async</span><span style="color:#B392F0"> src</span><span style="color:#E1E4E8">=</span><span style="color:#9ECBFF">"my.js"</span><span style="color:#E1E4E8">></span></span>
<span class="line"><span style="color:#6A737D">  /* do something */</span></span>
<span class="line"><span style="color:#E1E4E8">&#x3C;/</span><span style="color:#85E89D">script</span><span style="color:#E1E4E8">></span></span>
<span class="line"><span style="color:#E1E4E8">&#x3C;</span><span style="color:#85E89D">script</span><span style="color:#B392F0"> defer</span><span style="color:#B392F0"> src</span><span style="color:#E1E4E8">=</span><span style="color:#9ECBFF">"my.js"</span><span style="color:#E1E4E8">></span></span>
<span class="line"><span style="color:#6A737D">  /* do something */</span></span>
<span class="line"><span style="color:#E1E4E8">&#x3C;/</span><span style="color:#85E89D">script</span><span style="color:#E1E4E8">></span></span></code></pre>
<blockquote>
<p>The difference is that the <code>async</code> scripts will <strong>run as soon as they are available</strong>, in whatever order they download, whereas the <code>defer</code> scripts will not run <strong>until the page has finished loading</strong>, and will <strong>run in the order they appear on the page</strong>.</p>
</blockquote>
<h3 id="async">async</h3>
<p>一旦 JS 解析完畢後，馬上執行</p>
<blockquote>
<p>For classic scripts, if the <code>async</code> attribute is present, then the classic script will be fetched in parallel to parsing and <strong>evaluated as soon as it is available</strong>.</p>
</blockquote>
<blockquote>
<p>For module scripts, if the async attribute is present then the scripts and all their dependencies will be executed in the defer queue, therefore they will get fetched in parallel to parsing and <strong>evaluated as soon as they are available</strong>.</p>
</blockquote>
<blockquote>
<p>This attribute <strong>allows the elimination of parser-blocking JavaScript</strong> where the browser would have to load and evaluate scripts before continuing to parse. defer has a similar effect in this case.</p>
</blockquote>
<h3 id="defer">defer</h3>
<p>在 HTML 文件解析完畢後、<code>DOMContentLoaded</code>之前執行</p>
<blockquote>
<p>This Boolean attribute is set to indicate to a browser that the script is meant to <strong>be executed after the document has been parsed</strong>, but <strong>before firing DOMContentLoaded</strong>.</p>
</blockquote>
<blockquote>
<p>Scripts with the defer attribute will <strong>prevent the DOMContentLoaded event from firing</strong> until the script has loaded and finished evaluating.</p>
</blockquote>
<blockquote>
<p>Scripts with the defer attribute <strong>will execute in the order in which they appear in the document</strong>.</p>
</blockquote>
<blockquote>
<p>This attribute allows the elimination of parser-blocking JavaScript where the browser would have to load and evaluate scripts before continuing to parse. async has a similar effect in this case.</p>
</blockquote>
<blockquote>
<p>The DOMContentLoaded event fires when the initial <strong>HTML document has been completely loaded and parsed</strong>, without waiting for stylesheets, images, and subframes to finish loading.</p>
</blockquote>
<h3 id="critical-rendering-path">Critical rendering path</h3>
<blockquote>
<p>The Critical Rendering Path is the sequence of <strong>steps</strong> the browser goes through to <strong>convert the HTML, CSS, and JavaScript into pixels on the screen</strong>. Optimizing the critical render path improves render performance. The critical rendering path includes the <strong>Document Object Model (DOM), CSS Object Model (CSSOM), render tree and layout</strong>.</p>
</blockquote>
<p><img src="/2021/js-blocking/analysis-dom-css-js-async.png" alt="圖片借自Analyzing Critical Rendering Path Performance一文"></p>
<h2 id="參考文件">參考文件</h2>
<ul>
<li><a href="https://developers.google.com/web/fundamentals/performance/critical-rendering-path/adding-interactivity-with-javascript">Adding Interactivity with JavaScript</a></li>
<li><a href="https://developers.google.com/speed/docs/insights/BlockingJS">Remove Render-Blocking JavaScript</a></li>
<li><a href="https://web.dev/render-blocking-resources/">Eliminate render-blocking resources</a></li>
<li><a href="https://discourse.mozilla.org/t/async-v-s-defer/53819/2">Async v.s. defer</a></li>
<li><a href="https://developers.google.com/web/fundamentals/performance/critical-rendering-path/constructing-the-object-model">Constructing the Object Model</a></li>
<li><a href="https://developers.google.com/web/fundamentals/performance/critical-rendering-path/analyzing-crp">Analyzing Critical Rendering Path Performance</a></li>
<li><a href="https://developer.mozilla.org/en-US/docs/Web/Performance/Critical_rendering_path">Critical rendering path</a></li>
</ul> </div>   <footer class="footer" data-astro-cid-qlgq3onj>
Tzu Yin (Charlie) 🦊 Made in Taiwan
</footer>  </section>  </body></html> 