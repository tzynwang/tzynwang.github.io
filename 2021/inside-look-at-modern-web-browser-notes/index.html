<!DOCTYPE html><html lang="en"> <head><meta name="astro-view-transitions-enabled" content="true"><meta name="astro-view-transitions-fallback" content="animate"><script type="module" src="/_astro/ClientRouter.astro_astro_type_script_index_0_lang.BScVxmeO.js"></script><!-- Google Tag Manager --><script>(function(){const ga4Id = "G-6QC9CKHCTY";

      (function (w, d, s, l, i) {
        w[l] = w[l] || [];
        w[l].push({ 'gtm.start': new Date().getTime(), event: 'gtm.js' });
        var f = d.getElementsByTagName(s)[0],
          j = d.createElement(s),
          dl = l != 'dataLayer' ? '&l=' + l : '';
        j.async = true;
        j.src = 'https://www.googletagmanager.com/gtm.js?id=' + i + dl;
        f.parentNode.insertBefore(j, f);
      })(window, document, 'script', 'dataLayer', ga4Id);
    })();</script><!-- Google tag (gtag.js) --><script async src="https://www.googletagmanager.com/gtag/js?id=GTM-KM9SGJLK">(function(){const gTagId = "GTM-KM9SGJLK";
})();</script><script>(function(){const ga4Id = "G-6QC9CKHCTY";

      window.dataLayer = window.dataLayer || [];
      function gtag() {
        dataLayer.push(arguments);
      }
      gtag('js', new Date());
      gtag('config', ga4Id);
    })();</script><!-- Global Metadata --><meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1"><link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ğŸ¦Š</text></svg>"><link rel="sitemap" href="/sitemap-index.xml"><meta name="generator" content="Astro v5.1.2"><!-- Primary Meta Tags --><title>ã€ŒInside look at modern web browserã€ç›¸é—œç­†è¨˜</title><meta name="title" content="ã€ŒInside look at modern web browserã€ç›¸é—œç­†è¨˜"><meta name="description" content="é€™æ˜¯ä¸€å€‹æ–‡çµ„è½‰è·å‰ç«¯å·¥ç¨‹å¸«çš„æŠ€è¡“éƒ¨è½æ ¼"><!-- Open Graph / Facebook --><meta property="og:type" content="website"><meta property="og:url" content="https://tzynwang.github.io/2021/inside-look-at-modern-web-browser-notes"><meta property="og:title" content="ã€ŒInside look at modern web browserã€ç›¸é—œç­†è¨˜"><meta property="og:description" content="é€™æ˜¯ä¸€å€‹æ–‡çµ„è½‰è·å‰ç«¯å·¥ç¨‹å¸«çš„æŠ€è¡“éƒ¨è½æ ¼"><meta property="og:image" content="https://tzynwang.github.io/alexander-andrews-mEdKuPYJe1I.jpg"><!-- Twitter --><meta property="twitter:card" content="summary_large_image"><meta property="twitter:url" content="https://tzynwang.github.io/2021/inside-look-at-modern-web-browser-notes"><meta property="twitter:title" content="ã€ŒInside look at modern web browserã€ç›¸é—œç­†è¨˜"><meta property="twitter:description" content="é€™æ˜¯ä¸€å€‹æ–‡çµ„è½‰è·å‰ç«¯å·¥ç¨‹å¸«çš„æŠ€è¡“éƒ¨è½æ ¼"><meta property="twitter:image" content="https://tzynwang.github.io/alexander-andrews-mEdKuPYJe1I.jpg"><!-- Font --><link rel="preconnect" href="https://fonts.googleapis.com"><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin><link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;700&family=Noto+Sans:wght@400;700&display=swap" rel="stylesheet"><style>.tag[data-astro-cid-2iymvi75]{position:relative;display:inline-flex;align-items:center;padding:2px 8px;font-size:14px;font-weight:400;text-decoration:none;background-color:#8aa6a3;color:#fff;transition:background-color .2s ease-in-out}.tag[data-astro-cid-2iymvi75]:not(:last-of-type){margin-right:8px}.tag[data-astro-cid-2iymvi75]:hover{background-color:#127369}
.astro-route-announcer{position:absolute;left:0;top:0;clip:rect(0 0 0 0);clip-path:inset(50%);overflow:hidden;white-space:nowrap;width:1px;height:1px}.footer[data-astro-cid-qlgq3onj]{padding:36px;text-align:center}.bottom[data-astro-cid-qlgq3onj]{position:absolute;bottom:0;left:50%;transform:translate(-50%)}.side-content[data-astro-cid-75hifxor],.main-content[data-astro-cid-75hifxor]{margin:24px}nav[data-astro-cid-75hifxor]{display:flex;gap:16px}@media screen and (min-width: 800px){body{height:100vh;display:flex;flex-direction:row;overflow-y:hidden}nav[data-astro-cid-75hifxor]{flex-direction:column}.side-content[data-astro-cid-75hifxor]{flex:0 0 240px}.main-content[data-astro-cid-75hifxor]{margin:0;padding:40px 24px 0;flex:1 1 auto;overflow-y:auto;position:relative}}*{margin:0;padding:0;box-sizing:content-box;font-family:sans-serif;text-wrap:pretty;color:#000000e6}html{background-color:#bfbfbf66}a{color:#127369;font-weight:700;text-decoration:underline;text-decoration-color:transparent;transition:text-decoration-color .2s ease-in-out}a:hover{text-decoration-color:#127369}a.link-out{position:absolute;inset:0}ul,li{list-style-position:inside}ul:not(:has(li)){margin-top:16px;margin-bottom:16px}li{margin-top:4px;margin-bottom:4px;line-height:24px}li li{padding-left:16px}img{display:block;max-width:100%}h1,h2{font-size:28px;line-height:42px;margin:16px 0;color:#4c5958}h3,h4{font-size:22px;line-height:34px;margin:16px 0;color:#4c5958}h5{font-size:18px;line-height:28px;margin:4px 0;color:#4c5958}p{font-size:16px;line-height:24px;margin:16px 0}p code{font-size:14px}blockquote{padding-left:16px;border-left:4px solid #4c5958}blockquote *{font-family:Noto Sans,sans-serif}pre{padding:8px 16px}code,code span{font-family:monospace}hr{width:100%;height:1px;margin:16px 0;background-color:#4c5958}del{color:#4c5958e6}ol>li:has(p)>p{display:inline;margin:0}
.post-container[data-astro-cid-qtokga5y] h1[data-astro-cid-qtokga5y]{margin:0 0 16px}.info[data-astro-cid-qtokga5y]{display:flex;flex-direction:column;gap:8px}.toc-container[data-astro-cid-qtokga5y]{margin-bottom:0}.toc-container[data-astro-cid-qtokga5y]>li[data-astro-cid-qtokga5y]:not(:last-of-type){margin-bottom:4px}.toc-2[data-astro-cid-qtokga5y]{margin-left:1rem}.toc-3[data-astro-cid-qtokga5y]{margin-left:2rem}.toc-4[data-astro-cid-qtokga5y]{margin-left:3rem}.toc-5[data-astro-cid-qtokga5y]{margin-left:4rem}@media screen and (min-width: 800px){.post-container[data-astro-cid-qtokga5y]{max-width:600px}}@media screen and (min-width: 1200px){.post-container[data-astro-cid-qtokga5y]{max-width:720px}}
[data-astro-image]{width:100%;height:auto;object-fit:var(--fit);object-position:var(--pos);aspect-ratio:var(--w) / var(--h)}[data-astro-image=responsive]{max-width:calc(var(--w) * 1px);max-height:calc(var(--h) * 1px)}[data-astro-image=fixed]{width:calc(var(--w) * 1px);height:calc(var(--h) * 1px)}
</style></head> <body> <!-- Google Tag Manager (noscript) --> <noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-KM9SGJLK" height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript> <!-- End Google Tag Manager (noscript) --> <section class="side-content" data-astro-cid-75hifxor> <h1 data-astro-cid-75hifxor>æ™®é€šæ–‡çµ„ 2.0</h1> <nav data-astro-cid-75hifxor> <a href="/" data-astro-cid-75hifxor>é¦–é </a> <a href="/archive" data-astro-cid-75hifxor>å…¨æ–‡ç« æ­¸æª”</a> <a href="/tag" data-astro-cid-75hifxor>ä»¥æ¨™ç±¤æª¢è¦–</a> <a href="/rss.xml" data-astro-cid-75hifxor>RSS</a> </nav> </section> <section class="main-content" data-astro-cid-75hifxor>   <div class="post-container" data-astro-cid-qtokga5y> <h1 data-astro-cid-qtokga5y>ã€ŒInside look at modern web browserã€ç›¸é—œç­†è¨˜</h1> <div class="info" data-astro-cid-qtokga5y> <span data-astro-cid-qtokga5y>2021-04-23 11:54</span> <span data-astro-cid-qtokga5y><a class="tag" href="/tag/Browser" data-astro-cid-2iymvi75> Browser </a> </span> <ul class="toc-container" data-astro-cid-qtokga5y> <li class="toc-2" data-astro-cid-qtokga5y> <a href="#ç¸½çµ" data-astro-cid-qtokga5y>ç¸½çµ</a> </li><li class="toc-2" data-astro-cid-qtokga5y> <a href="#ç¬¬ä¸€éƒ¨æ¶æ§‹-architecture" data-astro-cid-qtokga5y>ç¬¬ä¸€éƒ¨ï¼šæ¶æ§‹ Architecture</a> </li><li class="toc-3" data-astro-cid-qtokga5y> <a href="#process-èˆ‡-thread" data-astro-cid-qtokga5y>Process èˆ‡ Thread</a> </li><li class="toc-3" data-astro-cid-qtokga5y> <a href="#ç€è¦½å™¨æ¶æ§‹" data-astro-cid-qtokga5y>ç€è¦½å™¨æ¶æ§‹</a> </li><li class="toc-2" data-astro-cid-qtokga5y> <a href="#ç¬¬äºŒéƒ¨å°èˆª-navigation" data-astro-cid-qtokga5y>ç¬¬äºŒéƒ¨ï¼šå°èˆª Navigation</a> </li><li class="toc-3" data-astro-cid-qtokga5y> <a href="#browser-process" data-astro-cid-qtokga5y>browser process</a> </li><li class="toc-3" data-astro-cid-qtokga5y> <a href="#æµç¨‹" data-astro-cid-qtokga5y>æµç¨‹</a> </li><li class="toc-3" data-astro-cid-qtokga5y> <a href="#renderer-process-1" data-astro-cid-qtokga5y>renderer process 1</a> </li><li class="toc-3" data-astro-cid-qtokga5y> <a href="#å‰å¾€å¦ä¸€å€‹ç¶²ç«™" data-astro-cid-qtokga5y>å‰å¾€å¦ä¸€å€‹ç¶²ç«™</a> </li><li class="toc-3" data-astro-cid-qtokga5y> <a href="#service-worker" data-astro-cid-qtokga5y>service worker</a> </li><li class="toc-2" data-astro-cid-qtokga5y> <a href="#ç¬¬ä¸‰éƒ¨æ¸²æŸ“-rendering" data-astro-cid-qtokga5y>ç¬¬ä¸‰éƒ¨ï¼šæ¸²æŸ“ Rendering</a> </li><li class="toc-3" data-astro-cid-qtokga5y> <a href="#renderer-process-2" data-astro-cid-qtokga5y>renderer process 2</a> </li><li class="toc-3" data-astro-cid-qtokga5y> <a href="#parsing" data-astro-cid-qtokga5y>parsing</a> </li><li class="toc-3" data-astro-cid-qtokga5y> <a href="#style-calculation" data-astro-cid-qtokga5y>style calculation</a> </li><li class="toc-3" data-astro-cid-qtokga5y> <a href="#layout" data-astro-cid-qtokga5y>layout</a> </li><li class="toc-3" data-astro-cid-qtokga5y> <a href="#paint" data-astro-cid-qtokga5y>paint</a> </li><li class="toc-3" data-astro-cid-qtokga5y> <a href="#compositing" data-astro-cid-qtokga5y>compositing</a> </li><li class="toc-3" data-astro-cid-qtokga5y> <a href="#compositor-only-properties" data-astro-cid-qtokga5y>compositor-only properties</a> </li><li class="toc-2" data-astro-cid-qtokga5y> <a href="#ç¬¬å››éƒ¨ç€è¦½å™¨å¦‚ä½•è™•ç†äº‹ä»¶" data-astro-cid-qtokga5y>ç¬¬å››éƒ¨ï¼šç€è¦½å™¨å¦‚ä½•è™•ç†äº‹ä»¶</a> </li><li class="toc-3" data-astro-cid-qtokga5y> <a href="#non-fast-scrollable-region" data-astro-cid-qtokga5y>non-fast scrollable region</a> </li><li class="toc-2" data-astro-cid-qtokga5y> <a href="#è£œå……" data-astro-cid-qtokga5y>è£œå……</a> </li><li class="toc-2" data-astro-cid-qtokga5y> <a href="#åƒè€ƒæ–‡ä»¶" data-astro-cid-qtokga5y>åƒè€ƒæ–‡ä»¶</a> </li> </ul> </div> <h2 id="ç¸½çµ">ç¸½çµ</h2>
<p>æ­¤ç‚ºã€ŒInside look at modern web browserã€å››éƒ¨æ›²æ–‡ç« çš„ç›¸é—œç­†è¨˜ã€‚
è¨»ï¼šæœ¬ç¯‡ç­†è¨˜å…§çš„åœ–ç‰‡é™¤äº†ä»¥ä¸‹é€™å¼µä¹‹å¤–ï¼Œå…¨éƒ¨éƒ½æ˜¯å¾ã€ŒInside look at modern web browserã€ç³»åˆ—å–å¾—çš„èªªæ˜åœ–ç‰‡ã€‚</p>
<p><img src="/2021/inside-look-at-modern-web-browser-notes/process-in-chrome.png" alt="Chromeåœ¨å‘ˆç¾ç¶²é çµ¦ä½¿ç”¨è€…çœ‹çš„æ™‚å€™ï¼Œå¤§éƒ¨åˆ†çš„å·¥ä½œæ˜¯ç”±browser processèˆ‡renderer processè™•ç†çš„"></p>
<h2 id="ç¬¬ä¸€éƒ¨æ¶æ§‹-architecture">ç¬¬ä¸€éƒ¨ï¼šæ¶æ§‹ Architecture</h2>
<h3 id="process-èˆ‡-thread">Process èˆ‡ Thread</h3>
<ul>
<li>åœ¨é›»è…¦ï¼ˆæˆ–æ‰‹æ©Ÿï¼‰ä¸Šé–‹å•Ÿç€è¦½å™¨æ‡‰ç”¨ç¨‹å¼å¾Œï¼Œé›»è…¦ï¼ˆæˆ–æ‰‹æ©Ÿï¼‰æœƒå»ºç«‹ä¸€å€‹ processï¼Œä¸¦åˆ†é…è¨˜æ†¶é«”ç©ºé–“çµ¦è©² processã€‚</li>
<li>ä¸€å€‹ process è£¡é¢å¯ä»¥åŒ…å«å¤šå€‹ threadã€‚</li>
<li>ä¸€å€‹ process å¯ä»¥è¦æ±‚é›»è…¦ï¼ˆæˆ–æ‰‹æ©Ÿï¼‰å»ºç«‹å¦å¤–ä¸€å€‹ process ä¾†å¹«å¿™ï¼Œè€Œ process ä¹‹é–“é€é IPC ä¾†æºé€šã€‚</li>
</ul>
<blockquote>
<p>A process can be described as an applicationâ€™s executing program.
A <strong>thread</strong> is the one that <strong>lives inside of process</strong> and executes any part of its processâ€™s program.
Wikipedia: In computing, a process is the instance of a computer program that is being executed by one or many threads.</p>
</blockquote>
<p>Process ä¸­å¯èƒ½æœ‰ä¸€å€‹æˆ–è¤‡æ•¸å€‹ Threadã€‚</p>
<blockquote>
<p>When you <strong>start an application</strong>, a <strong>process is created</strong>. The program might create thread(s) to help it do work, but thatâ€™s optional.
The Operating System gives the process a â€œslabâ€ of memory to work with and all application state is kept in that private memory space. When you close the application, the process also goes away and the Operating System frees up the memory.</p>
</blockquote>
<p>ã€Œé–‹å•Ÿæ‡‰ç”¨ç¨‹å¼ã€ä»£è¡¨å»ºç«‹ä¸€å€‹ processï¼Œè€Œè¨ˆç®—æ©Ÿçš„ OS æœƒåˆ†é…è¨˜æ†¶é«”ä¸­çš„ä¸€äº›ç©ºé–“çµ¦è©² processï¼›ç•¶ä½¿ç”¨è€…çµæŸè©²æ‡‰ç”¨ç¨‹åºå¾Œï¼Œé‚£å€‹ process ä½¿ç”¨çš„è¨˜æ†¶é«”ç©ºé–“å°±æœƒè¢«é‡‹æ”¾ã€‚</p>
<blockquote>
<p>A process can ask the Operating System to <strong>spin up another process</strong> to run different tasks. When this happens, different parts of the memory are allocated for the new process.
If two processes need to talk, they can do so by using <strong>Inter Process Communication (IPC)</strong>.</p>
</blockquote>
<p>Process å¯ä»¥è«‹ OS å†å»ºç«‹å¦ä¸€å€‹ process ä¾†è™•ç†å…¶ä»–ä»»å‹™ï¼Œè€Œä¸åŒçš„ process å½¼æ­¤ä½¿ç”¨ IPC ä¾†äº’ç›¸æºé€šã€‚</p>
<h3 id="ç€è¦½å™¨æ¶æ§‹">ç€è¦½å™¨æ¶æ§‹</h3>
<ul>
<li>ä¸åŒå» ç‰Œçš„ç€è¦½å™¨æœƒæœ‰ä¸åŒçš„æ¶æ§‹ã€‚</li>
<li>ä»¥ Chrome ç‚ºä¾‹ï¼Œå…¶æ¶æ§‹å¯æ‹†ç‚º browser processã€renderer processã€plugin process èˆ‡ GPU process ç­‰ç­‰ã€‚
<img src="/2021/inside-look-at-modern-web-browser-notes/browserui.png" alt="processå€‘æœ‰å„è‡ªçš„è² è²¬ç¯„åœ">
<ul>
<li>browser process è² è²¬çš„æ˜¯ã€ŒChrome é€™å€‹æ‡‰ç”¨ç¨‹å¼ä¸­ã€ä¸æ˜¯ web contentã€çš„éƒ¨åˆ†ã€ã€‚å…¶ä¸­åŒ…å« UI threadã€Network thread èˆ‡ Storage thread ç­‰ç­‰ã€‚
<blockquote>
<p>Controls â€œchromeâ€ part of the application including address bar, bookmarks, back and forward buttons. Also handles the invisible, privileged parts of a web browser such as network requests and file access.</p>
</blockquote>
</li>
<li>renderer process è² è²¬çš„æ˜¯ã€ŒChrome é€™å€‹æ‡‰ç”¨ç¨‹å¼ä¸­ã€å±¬æ–¼ web contentã€çš„éƒ¨åˆ†ã€ã€‚
<blockquote>
<p>Controls anything inside of the tab where a website is displayed.</p>
</blockquote>
</li>
<li>ä¸€å€‹ tab å¯èƒ½æœƒæœ‰è¤‡æ•¸å€‹ renderer processesï¼Œå› ç‚º Chrome ç¾è¡Œçš„æ¶æ§‹æ˜¯ï¼šã€Œä¸€å€‹ç¶²ç«™ï¼ˆåŒ…å« iframesï¼‰åˆ†é…ä¸€å€‹ processã€ã€‚
<img src="/2021/inside-look-at-modern-web-browser-notes/isolation.png" alt="processå„è‡ªç¨ç«‹çš„å„ªå‹¢æ˜¯ï¼Œå³ä½¿å…¶ä¸­ä¸€å€‹processä¸å¹¸å‡ºäº†å•é¡Œï¼Œä¹Ÿä¸æœƒå½±éŸ¿ç•«é¢ä¸­çš„å…¶ä»–å…§å®¹"></li>
</ul>
</li>
</ul>
<h2 id="ç¬¬äºŒéƒ¨å°èˆª-navigation">ç¬¬äºŒéƒ¨ï¼šå°èˆª Navigation</h2>
<h3 id="browser-process">browser process</h3>
<blockquote>
<p>The browser process has threads like the <strong>UI thread</strong> which draws buttons and input fields of the browser, the <strong>network thread</strong> which deals with network stack to receive data from the internet, the <strong>storage thread</strong> that controls access to the files and more.</p>
</blockquote>
<ul>
<li>UI threadï¼šè² è²¬è™•ç†ã€Œä½¿ç”¨è€…å¯ä»¥éµå…¥é—œéµå­—ã€æˆ–ç›´æ¥è¼¸å…¥ URL ä¾†å‰å¾€ç‰¹å®šç¶²ç«™ã€çš„è¼¸å…¥å€å¡Šï¼ˆinput fieldsï¼‰ã€‚</li>
<li>Network threadï¼šè™•ç†ã€Œå‘ç¶²è·¯ç´¢å–è³‡æ–™ã€çš„ç›¸é—œå·¥ä½œã€‚</li>
<li>Storage threadï¼šè™•ç†ã€Œæª”æ¡ˆå­˜å–æ¬Šé™ã€çš„ç›¸é—œå·¥ä½œã€‚</li>
</ul>
<blockquote>
<p>When you type a URL into the address bar, your input is handled by browser processâ€™s UI thread.</p>
</blockquote>
<p>ç•¶ä¸€å€‹ä½¿ç”¨è€…åœ¨ç€è¦½å™¨çš„è¼¸å…¥å€å¡Šéµå…¥ URL å¾Œï¼Œã€Œä½¿ç”¨è€…è¼¸å…¥çš„è³‡æ–™ã€å°±æ˜¯ç”± UI threadï¼ˆéš¸å±¬æ–¼ browser processï¼‰è² è²¬è™•ç†çš„ã€‚</p>
<h3 id="æµç¨‹">æµç¨‹</h3>
<ol>
<li>ç•¶ä½¿ç”¨è€…åœ¨è¼¸å…¥å€å¡Šéµå…¥è³‡æ–™å¾Œï¼ŒUI thread é¦–å…ˆè¦è¾¨åˆ¥è©²è³‡æ–™æ˜¯ã€ŒURLï¼ˆä½¿ç”¨è€…è¦å‰å¾€ç‰¹å®šç¶²é ï¼‰ã€é‚„æ˜¯ã€Œé—œéµå­—ï¼ˆä½¿ç”¨è€…è¦æŸ¥æ‰¾è³‡æ–™ï¼‰ã€ã€‚</li>
<li>UI thread è¦æ±ºå®šå®ƒæ‡‰è©²ã€Œå‘ˆç¾ç‰¹å®šç¶²é ã€æˆ–æ˜¯ã€Œå‘ˆç¾æœå°‹çµæœã€çµ¦ä½¿ç”¨è€…çœ‹ã€‚</li>
<li>å¦‚æœä½¿ç”¨è€…è¼¸å…¥çš„æ˜¯ URLï¼ŒUI thread æœƒç™¼èµ· network callï¼Œé€šçŸ¥ Network thread å»å–å¾—ç¶²é å…§å®¹ï¼Œé€™æ™‚ Network thread æœƒä½¿ç”¨ç›¸å°æ‡‰çš„ protocols ä¾†èˆ‡ä¼ºæœå™¨å»ºç«‹é€£ç·šã€‚
<blockquote>
<p>When a user hits enter, the UI thread initiates a network call to get site content.</p>
</blockquote>
</li>
</ol>
<ul>
<li>æ³¨æ„ï¼šå¦‚æœä¼ºæœå™¨å›è¦† HTTP 301ï¼ˆMoved Permanentlyï¼‰çµ¦ Network thread çš„è©±ï¼ŒNetwork thread æœƒé€šçŸ¥ UI threadï¼šã€Œä¼ºæœå™¨è¦æ±‚é‡æ–°å°å‘ã€ï¼Œæ­¤æ™‚ UI thread æœƒç™¼ä¸€å€‹æ–°çš„ URL request çµ¦ Network threadã€‚
<blockquote>
<p>At this point, the network thread may receive a server redirect header like HTTP 301. In that case, the network thread communicates with UI thread that the server is requesting redirect. Then, another URL request will be initiated.</p>
</blockquote>
</li>
</ul>
<ol>
<li>Network thread å¾ä¼ºæœå™¨æ”¶åˆ°è³‡æ–™å¾Œï¼Œå®ƒæœƒæª¢æŸ¥è©²è³‡æ–™çš„ content-Type headerï¼Œä»¥ä¾¿çŸ¥é“ä¼ºæœå™¨ç©¶ç«Ÿæä¾›äº†ä»€éº¼é¡å‹çš„è³‡æ–™ã€‚</li>
</ol>
<ul>
<li>ä½† content-Type header ä¸­è‡ªç¨±çš„è³‡æ–™é¡å‹å¯èƒ½æ˜¯éŒ¯çš„ã€‚</li>
<li>é€™æ™‚å€™éœ€è¦åŸ·è¡Œ MIME Type sniffing ä¾†ç¢ºèªè³‡æ–™é¡å‹ã€‚
<blockquote>
<p><a href="https://en.wikipedia.org/wiki/Content_sniffing">MIME Type sniffering</a>ï¼šinspecting the content of a byte stream to attempt to deduce (æ¨æ–·) the file format of the data within it.</p>
</blockquote>
</li>
</ul>
<ol>
<li>å¦‚æœè³‡æ–™å…§å®¹æ˜¯ HTML æª”æ¡ˆï¼Œä¸”æª”æ¡ˆå…§å®¹ç¶“éæª¢æŸ¥ã€çœ‹èµ·ä¾†å®‰å…¨çš„è©±ï¼ŒNetwork thread æœƒå‘Šè¨´ UI threadã€Œè³‡æ–™å·²ç¶“æº–å‚™å¥½äº†ã€ï¼ˆæ³¨æ„é€™å…©å€‹ threads éƒ½é‚„åœ¨ browser process å…§ï¼‰ï¼Œç„¶å¾Œ UI thread æœƒå»æ‰¾ä¸€å€‹ renderer process ä¾†è™•ç† HTML æ¸²æŸ“çš„å·¥ä½œã€‚
<blockquote>
<p>Once all of the checks are done and Network thread is confident that browser should navigate to the requested site, the Network thread tells UI thread that the data is ready. UI thread then finds a renderer process to carry on rendering of the web page.</p>
</blockquote>
</li>
<li>browser process æœƒé€é IPC ä¾†ã€Œcommit the navigationã€çµ¦ renderer processã€‚
<blockquote>
<p>Now that the data and the renderer process is ready, an IPC is sent from the browser process to the renderer process to commit the navigation.</p>
</blockquote>
</li>
<li>browser process ä¹Ÿæœƒå° renderer process å»ºç«‹ data streamï¼Œä»¥ä¾¿æŠŠæ”¶åˆ°çš„è³‡æ–™äº¤çµ¦ renderer processã€‚
<blockquote>
<p>It also passes on the data stream so the renderer process can keep receiving HTML data.</p>
</blockquote>
</li>
<li>ä¸€æ—¦ browser process ç¢ºèª commit åœ¨ renderer process ç™¼ç”Ÿå¾Œï¼Œnavigation æµç¨‹å°±ç®—æ˜¯çµæŸï¼Œè€Œ document loading æµç¨‹é–‹å§‹ã€‚
<blockquote>
<p>Once the browser process hears confirmation that the <strong>commit has happened</strong> in the <strong>renderer process</strong>, the <strong>navigation is complete</strong> and the <strong>document loading phase begins</strong>.</p>
</blockquote>
</li>
<li>tab çš„ session history æœƒæ›´æ–°ï¼Œé€™æ¨£ç€è¦½å™¨çš„ã€Œä¸Šä¸€é ï¼ä¸‹ä¸€é ã€æŒ‰éˆ•æ‰æœƒè¨˜ä½ç€è¦½éçš„é é¢ï¼Œè€Œ session history æœƒå­˜åœ¨ç¡¬ç¢Ÿä¸­ï¼ˆä¸ç„¶ session åœ¨é—œæ‰ tab å¾Œå°±ä¸è¦‹äº†ï¼‰ã€‚
<blockquote>
<p>The session history for the tab will be updated so back/forward buttons will step through the site that was just navigated to. To facilitate tab/session restore when you close a tab or window, the <strong>session history is stored on disk</strong>.</p>
</blockquote>
</li>
</ol>
<h3 id="renderer-process-1">renderer process 1</h3>
<p><img src="/2021/inside-look-at-modern-web-browser-notes/commit.png" alt="navigation commitå¾Œï¼Œç”±renderer processè² è²¬æ¸²æŸ“ç•«é¢"></p>
<ol>
<li>ã€Œnavigation commitã€ç™¼ç”Ÿå¾Œï¼Œç”± renderer process æ¥æ‰‹è™•ç†æ¸²æŸ“ç•«é¢çš„å·¥ä½œã€‚</li>
<li>ç„¶å¾Œç•¶ renderer process çµæŸæ¸²æŸ“å·¥ä½œå¾Œï¼Œå®ƒæœƒé€é IPC å‘Šè¨´ browser process æ¸²æŸ“å®Œæˆäº†ï¼Œé€™æ™‚å€™ browser process å…§çš„ UI thread æœƒæŠŠ tag ä¸Šçš„ spinning åœ–ç¤ºåœä¸‹ä¾†ã€‚</li>
<li>æ‰€è¬‚çš„ã€Œæ¸²æŸ“çµæŸã€æŒ‡çš„æ˜¯ã€Œæ‰€æœ‰çš„<code>onload</code>äº‹ä»¶éƒ½å·²ç¶“è§¸ç™¼ä¸”å®Œæˆäº†ã€ã€‚</li>
</ol>
<h3 id="å‰å¾€å¦ä¸€å€‹ç¶²ç«™">å‰å¾€å¦ä¸€å€‹ç¶²ç«™</h3>
<p>å¦‚æœè¦å¾ã€Œç›®å‰æ­£åœ¨ç€è¦½çš„ç¶²ç«™ã€ç§»å‹•åˆ°ã€Œå¦ä¸€å€‹ç¶²ç«™ã€ï¼Œæµç¨‹åˆæ˜¯å¦‚ä½•ï¼Ÿ</p>
<ol>
<li>å¾ä¸€å€‹ç¶²é  navigate åˆ°å¦å¤–ä¸€ç¶²é ã€Œå‰ã€ï¼Œè¦å…ˆæª¢æŸ¥ç¾åœ¨çš„ç¶²é æœ‰æ²’æœ‰<code>beforeunload</code>è¦è™•ç†ã€‚
<blockquote>
<p>Well, the browser process goes through the same steps to navigate to the different site. But <strong>before</strong> it can do that, it needs to check with the currently rendered site if they care about <code>beforeunload</code> event.</p>
</blockquote>
</li>
<li>web content æ‰€æœ‰çš„å…§å®¹éƒ½æ­¸ renderer process ç®¡ï¼Œæ‰€ä»¥ browser process åœ¨å°å‘æ–°çš„ç¶²é å‰ï¼Œè¦å…ˆé€é renderer process ç¢ºèªæœ‰æ²’æœ‰<code>beforeunload</code>è¦è™•ç†ã€‚
<blockquote>
<p><code>beforeunload</code> can create â€œLeave this site?â€ alert when you try to navigate away or close the tab. Everything inside of a tab including your JavaScript code is handled by the renderer process, so the browser process has to check with current renderer process when new navigation request comes in.</p>
</blockquote>
</li>
<li>èˆŠçš„ renderer process æœƒè™•ç†<code>unload</code>ä¹‹é¡çš„äº‹ä»¶ï¼Œæ–°çš„ renderer process æœƒè² è²¬æ¸²æŸ“é é¢çš„å·¥ä½œã€‚
<blockquote>
<p>When the new navigation is made to a different site than currently rendered one, a separate render process is called in to handle the new navigation while current render process is kept around to handle events like <code>unload</code>.
<img src="/2021/inside-look-at-modern-web-browser-notes/unload.png" alt="å…©å€‹renderer processåˆ†åˆ¥è™•ç†æ—¢æœ‰ç¶²é çš„unloadäº‹ä»¶ï¼Œèˆ‡æ–°ç¶²é çš„æ¸²æŸ“å·¥ä½œ"></p>
</blockquote>
</li>
</ol>
<h3 id="service-worker">service worker</h3>
<p>service worker æ­é…<code>Cache API</code>å¯ä»¥è®“æ‡‰ç”¨ç¨‹å¼å³ä½¿è™•åœ¨<strong>æ²’æœ‰ç¶²è·¯</strong>çš„ç’°å¢ƒä¸‹ï¼Œä¹Ÿèƒ½é€²è¡Œä¸€å®šç¨‹åº¦çš„æ“ä½œã€‚</p>
<blockquote>
<p>Service worker is a way to <strong>write network proxy in your application code</strong>; allowing web developers to have more control over what to cache locally and when to get new data from the network. If service worker is set to <strong>load the page from the cache</strong>, there is <strong>no need to request the data from the network</strong>.</p>
</blockquote>
<p>é‚£éº¼ï¼Œæå•ï¼š
service worker æ˜¯ JavaScript codeï¼ˆç”± renderer process ç®¡è½„ï¼‰ï¼Œbrowser process æ€éº¼çŸ¥é“æŸç¶²ç«™æœƒç”¨åˆ° service workerï¼Ÿ</p>
<blockquote>
<p>The important part to remember is that service worker is JavaScript code that runs in a <strong>renderer process</strong>. But when the navigation request comes in, <strong>how does a browser process know the site has a service worker?</strong></p>
</blockquote>
<p>å›ç­”å¦‚ä¸‹ï¼š</p>
<ol>
<li>é€é JavaScript è¨»å†Š service worker æ™‚ï¼ˆç™¼ç”Ÿåœ¨ renderer process ä¸­ï¼‰ï¼Œservice worker çš„ã€Œscopeã€æœƒè¢«è¨˜éŒ„ä¸‹ä¾†ã€‚</li>
<li>ç•¶ä½¿ç”¨è€…è¦å°è¦½åˆ°æŸå€‹ç¶²ç«™æ™‚ï¼Œbrowser process å…§çš„ Network thread æœƒæª¢æŸ¥æŸç¶²ç«™ã€Œæ˜¯å¦æœ‰è¨»å†Šé service workerã€ï¼Ÿ</li>
<li>ã€Œæœ‰ã€çš„è©±ï¼ŒUI threadï¼ˆå±¬æ–¼ browser processï¼‰æœƒæ‰¾ä¸€å€‹ renderer process ä¾†é‹è¡Œ service workerã€‚</li>
<li>render process å…§çš„ worker thread æœƒæ±ºå®šè¦å‘ç¶²è·¯é‚„æ˜¯å¿«å–æ‹¿è³‡æ–™ã€‚</li>
</ol>
<blockquote>
<p>When a service worker is registered, the <strong>scope</strong> of the service worker is kept as a reference. When a navigation happens, <strong>network thread checks the domain against registered service worker scopes</strong>, if a service worker is registered for that URL, the UI thread finds a renderer process in order to execute the service worker code.</p>
</blockquote>
<blockquote>
<p>The service worker may <strong>load data from cache</strong>, eliminating the need to request data from the network, or it may <strong>request new resources from the network</strong>.</p>
</blockquote>
<h2 id="ç¬¬ä¸‰éƒ¨æ¸²æŸ“-rendering">ç¬¬ä¸‰éƒ¨ï¼šæ¸²æŸ“ Rendering</h2>
<h3 id="renderer-process-2">renderer process 2</h3>
<blockquote>
<p>The renderer processâ€™s core job is to turn HTML, CSS, and JavaScript into a web page that the user can interact with.</p>
</blockquote>
<p>renderer process çš„å·¥ä½œï¼šæŠŠåŸå§‹ç¢¼è½‰æ›æˆä½¿ç”¨è€…å¯ä»¥äº’å‹•çš„ç¶²é ã€‚</p>
<blockquote>
<p>The renderer process is responsible for <strong>everything that happens inside of a tab</strong>. In a renderer process, the main thread handles most of the code you send to the user. Sometimes parts of your JavaScript is handled by worker threads if you use a web worker or a service worker. Compositor and raster threads are also run inside of a renderer processes to render a page efficiently and smoothly.</p>
</blockquote>
<p>renderer process åŒ…å«ä»¥ä¸‹å¹¾ç¨® threadï¼š</p>
<ul>
<li>main threadï¼šè™•ç†å¤§éƒ¨åˆ†çš„ç¨‹å¼ç¢¼</li>
<li>worker threadï¼šå¦‚æœæœ‰ä½¿ç”¨ web worker æˆ– service worker çš„è©±ï¼Œworker thread æœƒè² è²¬è™•ç†é€™äº›éƒ¨ä½çš„ JavaScript</li>
<li>compositor threadï¼šæŠŠç•«é¢åˆ†æ‹†ç‚ºä¸åŒçš„åœ–å±¤ï¼ˆlayersï¼‰</li>
<li>raster threadï¼šè² è²¬æŠŠå‘é‡åœ–è½‰æ›æˆåƒç´ åœ–</li>
</ul>
<h3 id="parsing">parsing</h3>
<p>é‡é»ï¼šï¼ˆrenderer process ä¸­çš„ï¼‰main thread å°‡ HTML è½‰æ›ç‚º DOM çš„éç¨‹å°±æ˜¯ parsingã€‚</p>
<ol>
<li>å»ºç«‹ DOMï¼šç”± main thread æŠŠ text string (HTML)è½‰æ›ç‚º Document Object Model (DOM)ã€‚
<blockquote>
<p>When the renderer process receives a commit message for a navigation and starts to receive HTML data, the main thread begins to parse the text string (HTML) and turn it into a Document Object Model (DOM).</p>
</blockquote>
</li>
<li>å°å…¥å¤–éƒ¨è³‡æºï¼šå¤–éƒ¨è³‡æºåŒ…æ‹¬ä»»ä½•ç¶²é ä¸Šæœƒç”¨åˆ°çš„åœ–ç‰‡ã€CSS æ¨£å¼æˆ– JavaScript ç¨‹å¼ç¢¼ã€‚é€™äº›è³‡æ–™æœƒç”± preload scanner çµ±æ•´èµ·ä¾†ï¼Œç„¶å¾Œé€å» browser processï¼Œè«‹ network thread å¹«å¿™è™•ç†ï¼ˆè€Œä¸æ˜¯ç”± renderer process çš„ main thread ä¾†è«‹æ±‚é€™äº›è³‡æ–™ï¼‰ã€‚
<blockquote>
<p>A website usually uses external resources like images, CSS, and JavaScript. Those files need to be loaded from network or cache. The main thread could request them one by one as they find them while parsing to build a DOM, but in order to speed up, â€œpreload scannerâ€ is run concurrently. If there are things like <code>&#x3C;img></code> or <code>&#x3C;link></code> in the HTML document, preload scanner peeks at tokens generated by HTML parser and <strong>sends requests to the network thread in the browser process</strong>.</p>
</blockquote>
</li>
<li>ä¸è¦è®“ JavaScript é˜»æ“‹æ¸²æŸ“æµç¨‹ï¼šå› ç‚º JavaScript ç¨‹å¼ç¢¼ä¸­å¯èƒ½åŒ…å«æ”¹è®Š DOM çš„å…§å®¹ï¼Œæ‰€ä»¥ç€è¦½å™¨ä¸€å®šè¦æŠŠ JavaScript ç›¸é—œçš„å…§å®¹è§£æå®Œç•¢å¾Œã€æ‰èƒ½ç¹¼çºŒé€²è¡Œç•«é¢æ¸²æŸ“çš„æµç¨‹ã€‚
<blockquote>
<p>When the HTML parser finds a <code>&#x3C;script></code> tag, it pauses the parsing of the HTML document and has to load, parse, and execute the JavaScript code. Why? because JavaScript can change the shape of the document using things like <code>document.write()</code> which changes the entire DOM structure (overview of the parsing model in the HTML spec has a nice diagram). This is why the HTML parser has to wait for JavaScript to run before it can resume parsing of the HTML document.</p>
</blockquote>
</li>
<li>æ›å¥è©±èªªï¼Œå¦‚æœæ˜¯èˆ‡ç•«é¢æ¸²æŸ“æ²’æœ‰é—œè¯çš„è³‡æºï¼Œå¯é€éåŠ ä¸Š<code>async</code>æˆ–<code>defer</code>é—œéµå­—ä¾†æé†’ç€è¦½å™¨ã€Œä¸ç”¨æ€¥è‘—è¼‰å…¥é€™äº›è³‡æ–™ã€ï¼Œé¿å…å¡ä½ç€è¦½å™¨é€²è¡Œç•«é¢æ¸²æŸ“ã€‚
<blockquote>
<p>There are many ways web developers can send hints to the browser in order to load resources nicely. If your JavaScript does not use <code>document.write()</code>, you can add async or defer attribute to the <code>&#x3C;script></code> tag. The browser then loads and runs the JavaScript code asynchronously and does not block the parsing. You may also use JavaScript module if thatâ€™s suitable. <code>&#x3C;link rel="preload"></code> is a way to inform browser that the resource is definitely needed for current navigation and you would like to download as soon as possible.</p>
</blockquote>
</li>
</ol>
<h3 id="style-calculation">style calculation</h3>
<p>é‡é»ï¼šå»ºæ§‹å®Œ DOM å¾Œï¼Œmain thread æœƒé–‹å§‹è§£æ CSS æ¨£å¼å…§å®¹ã€‚</p>
<ol>
<li>å°‡ DOM å»ºæ§‹å®Œç•¢å¾Œï¼Œmain thread æœƒé–‹å§‹è§£æ CSS æ¨£å¼ã€‚
<blockquote>
<p>Having a DOM is not enough to know what the page would look like because we can style page elements in CSS. The <strong>main thread parses CSS</strong> and determines the computed style for each DOM node.</p>
</blockquote>
</li>
<li>Chrome æœƒæä¾› user agent stylesheetï¼ˆå¯ç†è§£ç‚ºç¶²é å¥—ç”¨é è¨­æ¨£å¼ï¼Œä¸åŒå“ç‰Œçš„ç€è¦½å™¨ï¼Œå…¶ user agent stylesheet å…§å®¹ä¹Ÿæœƒä¸åŒï¼‰ï¼Œæ‰€ä»¥å³ä½¿ä¸€ä»½ HTML æª”æ¡ˆæ²’æœ‰è¢«çµ¦å®šä»»ä½• CSS æ¨£å¼ï¼Œè©²ç¶²é ä¹Ÿä¸æœƒä»¥ã€Œå®Œå…¨æ²’æœ‰ä»»ä½•æ¨£å¼ã€çš„æ¨¡æ¨£å‘ˆç¾åœ¨ä½¿ç”¨è€…é¢å‰ã€‚
<blockquote>
<p>Even if you do not provide any CSS, each DOM node has a computed style. <code>&#x3C;h1></code> tag is displayed bigger than <code>&#x3C;h2></code> tag and margins are defined for each element. This is because the browser has a default style sheet.</p>
</blockquote>
</li>
</ol>
<ul>
<li>Chrome çš„ user agent stylesheet åŸå§‹ç¢¼å¯<a href="https://source.chromium.org/chromium/chromium/src/+/master:third_party/blink/renderer/core/html/resources/html.css">åœ¨æ­¤æŸ¥çœ‹</a>ã€‚</li>
</ul>
<h3 id="layout">layout</h3>
<p>é‡é»ï¼šCSS æ¨£å¼è§£æå®Œç•¢å¾Œï¼Œmain thread é–‹å§‹å»ºç«‹ layout treeï¼Œlayout tree åªæœƒåŒ…å«ã€Œè¦è¢«å®‰æ’åœ¨ç•«é¢ä¸Šçš„å…§å®¹ã€ã€‚</p>
<ol>
<li>è§£æå®Œ CSS æ¨£å¼å¾Œï¼Œmain thread æœƒæ ¹æ“š DOM èˆ‡ CSS æ¨£å¼å…§å®¹ä¾†å»ºæ§‹ layout treeã€‚
<blockquote>
<p>The layout is a process to find the geometry of elements. The <strong>main thread</strong> walks through the DOM and computed styles and creates the <strong>layout tree</strong> which has information like x y coordinates and bounding box sizes.</p>
</blockquote>
</li>
<li>layout tree åªæœƒåˆ—å‡ºçœŸæ­£è¦é¡¯ç¤ºåœ¨ç•«é¢ä¸Šçš„å…ƒç´ ï¼Œäº¦å³ï¼Œå¦‚æœæœ‰æŸå€‹<code>&#x3C;div></code>çš„ CSS æ¨£å¼è¢«è¨­å®šç‚º<code>display: none</code>çš„è©±ï¼Œè©²<code>&#x3C;div></code>æ˜¯ä¸æœƒå‡ºç¾åœ¨ layout tree ä¸­çš„ã€‚
<blockquote>
<p>Layout tree may be similar structure to the DOM tree, but it <strong>only contains</strong> information related to whatâ€™s <strong>visible</strong> on the page. If <code>display: none</code> is applied, that element is not part of the layout tree (however, an element with <code>visibility: hidden</code> is in the layout tree).</p>
</blockquote>
</li>
</ol>
<h3 id="paint">paint</h3>
<blockquote>
<p>At this paint step, the <strong>main thread</strong> walks the layout tree to create <strong>paint records</strong>. Paint record is a note of painting process like â€œbackground first, then text, then rectangleâ€.</p>
</blockquote>
<p>paint recordsï¼šã€Œæ ¹æ“šç‰¹å®šé †åºåˆ†åˆ¥ç¹ªè£½ä¸åŒå…ƒç´ ã€çš„æŒ‡ä»¤ã€‚</p>
<blockquote>
<p>The most important thing to grasp in rendering pipeline is that at each step the result of the previous operation is used to create new data. For example, if something changes in the layout tree, then the Paint order needs to be regenerated for affected parts of the document.</p>
</blockquote>
<p>é ˆæ³¨æ„ rendering pipeline ä¸­çš„è³‡æ–™éƒ½æ˜¯<strong>æ‰¿å…ˆå•Ÿå¾Œ</strong>çš„ï¼Œä¸€æ—¦ä¿®æ”¹äº† layout treeï¼Œpaint record çš„è³‡æ–™ä¹Ÿéœ€è¦è·Ÿè‘—è®Šå‹•ã€‚</p>
<h3 id="compositing">compositing</h3>
<blockquote>
<p>Compositing is a technique to <strong>separate parts of a page into layers</strong>, rasterize them separately, and composite as a page in a separate thread called <strong>compositor thread</strong>. If scroll happens, since layers are already rasterized, all it has to do is to composite a new frame. Animation can be achieved in the same way by moving layers and composite a new frame.</p>
</blockquote>
<p>compositing çš„å·¥ä½œï¼šæŠŠä¸€å€‹ç•«é¢åˆ†æ‹†ç‚ºä¸åŒçš„ layersï¼Œä¸¦è®“æ¯å€‹ layer å„è‡ª rasterizeã€‚</p>
<blockquote>
<p>Turning this information into pixels on the screen is called rasterizing.</p>
</blockquote>
<p>rasterizingï¼šæŠŠå‘é‡è³‡è¨Šç¹ªè£½æˆé¡¯ç¤ºè£ç½®ä¸Šçš„åƒç´ é»ã€‚</p>
<blockquote>
<p>In order to find out which elements need to be in which layers, the <strong>main thread</strong> walks through the layout tree to <strong>create the layer tree</strong>. If certain parts of a page that should be separate layer (like slide-in side menu) is not getting one, then you can hint to the browser by using will-change attribute in CSS.</p>
</blockquote>
<blockquote>
<p>Once the layer tree is created and paint orders are determined, the main thread commits that information to the compositor thread. The compositor thread then rasterizes each layer. A layer could be large like the entire length of a page, so the compositor thread divides them into <strong>tiles</strong> and sends each tile off to raster threads. Raster threads rasterize each tile and store them in GPU memory.</p>
</blockquote>
<p>æµç¨‹å¦‚ä¸‹ï¼š</p>
<ol>
<li>renderer process çš„ main thread è¨ˆç®—å‡º layer treeã€‚</li>
<li>main thread æŠŠ layer tree çš„è³‡è¨Šäº¤çµ¦ compositor threadã€‚</li>
<li>compositor thread å°æ¯ä¸€å€‹ layer é€²è¡Œ rasterizationï¼ˆå‘é‡è®Šåƒç´ ï¼‰ã€‚</li>
<li>layer å¦‚æœå¤ªå¤§ï¼Œcompositor thread æœƒæŠŠ layer åˆ‡æˆ tiles å¾Œï¼Œå†é€é€² raster thread é€²è¡Œ rasterizationã€‚</li>
</ol>
<blockquote>
<p>Once tiles are rastered, compositor thread gathers tile information called <strong>draw quads</strong> to create a compositor frame.</p>
</blockquote>
<p><img src="/2021/inside-look-at-modern-web-browser-notes/draw-quads-compositor-frame.png" alt="draw quadsèˆ‡compositor frame"></p>
<p>tiles å¾å‘é‡è®Šåƒç´ ï¼ˆrasterizationï¼‰å¾Œï¼Œcompositor thread æœƒæ”¶é›†é—œæ–¼ tiles çš„è³‡è¨Šï¼ˆç¨±ç‚º draw quadsï¼‰ï¼Œä»¥ä¾¿å»ºç«‹ compositor frameã€‚</p>
<ul>
<li>draw quadsï¼šåŒ…å«ã€Œtile åœ¨è¨˜æ†¶é«”ä¸­çš„ä½ç½®ã€ä»¥åŠã€Œtile è¦è¢«ç¹ªè£½åœ¨ç•«é¢ä¸Šçš„ä»€éº¼ä½ç½®ã€çš„è³‡è¨Šã€‚</li>
<li>compositor frameï¼šç•«é¢çš„ä¸€å€‹ frameã€‚</li>
</ul>
<blockquote>
<p>A compositor frame is then submitted to the <strong>browser process</strong> via IPC. At this point, another compositor frame could be added from UI thread for the browser UI change or from other renderer processes for extensions. These <strong>compositor frames are sent to the GPU to display it on a screen</strong>. If a scroll event comes in, compositor thread creates another compositor frame to be sent to the GPU.</p>
</blockquote>
<p><img src="/2021/inside-look-at-modern-web-browser-notes/composit.png" alt="Compositor thread creating compositing frame. Frame is sent to the browser process then to GPU"></p>
<p>compositor frame å¾ renderer process é€é IPC å‚³éåˆ° browser process å¾Œï¼Œæœƒè¢«è½‰äº¤çµ¦ GPU ä¾†ã€Œå‘ˆç¾åœ¨ä½¿ç”¨è€…çš„è£ç½®ä¸Šã€ï¼Œç›´åˆ°é€™ä¸€æ­¥ä½¿ç”¨è€…æ‰çœŸçš„æœƒã€Œçœ‹åˆ°ç¶²é ã€ã€‚</p>
<h3 id="compositor-only-properties">compositor-only properties</h3>
<blockquote>
<p>The benefit of compositing is that it is done <strong>without involving the main thread</strong>. Compositor thread does not need to wait on style calculation or JavaScript execution. This is why compositing only animations are considered the best for smooth performance. If layout or paint needs to be <strong>calculated again</strong> then the <strong>main thread has to be involved</strong>.</p>
</blockquote>
<p><img src="/2021/inside-look-at-modern-web-browser-notes/frame-no-layout-paint.jpg" alt="The best-performing version of the pixel pipeline avoids both layout and paint, and only requires compositing changes"></p>
<ul>
<li>ä¸ç¶“é layout èˆ‡ paintï¼ˆä¸éœ€è¦ main threadï¼‰ï¼Œå…¨éƒ¨éƒ½ç”± compositing thread è™•ç†çš„ CSS æ¨£å¼ï¼š
<ul>
<li><code>transform</code></li>
<li><code>opacity</code>ï¼šé ˆæ³¨æ„ Blink åœ¨è™•ç†<code>opacity</code>æ™‚æœƒé€²å…¥ painting éšæ®µ</li>
<li>ä¸åŒçš„ CSS æ¨£å¼å„è‡ªæœƒè§¸ç™¼ä¸åŒå» ç‰Œç€è¦½å™¨çš„å“ªäº›éšæ®µï¼Œå¯åƒè€ƒï¼š<a href="https://csstriggers.com/">CSS Triggers</a></li>
</ul>
</li>
</ul>
<h2 id="ç¬¬å››éƒ¨ç€è¦½å™¨å¦‚ä½•è™•ç†äº‹ä»¶">ç¬¬å››éƒ¨ï¼šç€è¦½å™¨å¦‚ä½•è™•ç†äº‹ä»¶</h2>
<blockquote>
<p>From the browserâ€™s point of view, <strong>input</strong> means <strong>any gesture from the user</strong>. Mouse wheel scroll is an input event and touch or mouse over is also an input event.</p>
</blockquote>
<p>äº‹ä»¶ï¼ˆinputï¼‰ï¼šç€è¦½å™¨å°‡ã€Œä½¿ç”¨è€…å°ç¶²é é€²è¡Œæ“ä½œçš„è¡Œç‚ºã€è¦–ç‚ºäº‹ä»¶ï¼ˆinputï¼‰ã€‚</p>
<ol>
<li>browser process æœƒæ³¨æ„åˆ°ã€Œæœ‰ input event åœ¨ web content ä¸Šçš„æŸè™•ç™¼ç”Ÿã€ã€‚
<blockquote>
<p>When user gesture like touch on a screen occurs, the <strong>browser process</strong> is the one that <strong>receives the gesture</strong> at first. However, the browser process is only aware of <strong>where</strong> that gesture occurred since content inside of a tab is handled by the renderer process.</p>
</blockquote>
</li>
<li>browser process æœƒæŠŠ event type ä»¥åŠ event type çš„ coordinatesï¼ˆåº§æ¨™ï¼‰è³‡è¨Šç™¼çµ¦ renderer processã€‚
<blockquote>
<p>So the browser process sends the event type (like <code>touchstart</code>) and its coordinates to the <strong>renderer process</strong>.</p>
</blockquote>
</li>
<li>renderer process æœƒè¨ˆç®—å‡º event target æ˜¯å°æ‡‰åˆ°ç•«é¢ä¸Šçš„å“ªä¸€å€‹å…ƒç´ ï¼Œä»¥åŠé…åˆè©²å…ƒç´  event listener çš„ functionã€‚
<blockquote>
<p>Renderer process handles the event appropriately by finding the event target and running event listeners that are attached.</p>
</blockquote>
</li>
</ol>
<p><img src="/2021/inside-look-at-modern-web-browser-notes/input.png" alt="ç”±renderer processä¾†ç¢ºèªå“ªä¸€å€‹å…ƒç´ èˆ‡ä½¿ç”¨è€…ç™¼ç”Ÿäº’å‹•"></p>
<h3 id="non-fast-scrollable-region">non-fast scrollable region</h3>
<ol>
<li>compositor thread æœƒæŠŠå¸¶æœ‰äº‹ä»¶ç›£è½å™¨çš„ç•«é¢å€å¡Šæ¨™è¨˜ç‚ºã€Œnon-fast scrollable regionã€ã€‚
<blockquote>
<p>Since <strong>running JavaScript is the main threadâ€™s job</strong>, when a page is composited, the compositor thread marks a region of the page that <strong>has event handlers attached</strong> as â€œ<strong>Non-Fast Scrollable Region</strong>â€.</p>
</blockquote>
</li>
<li>å¦‚æœè©²å€åŸŸæœ‰èˆ‡ä½¿ç”¨è€…ç™¼ç”Ÿäº’å‹•ï¼Œcompositor thread æœƒæŠŠäº’å‹•äº‹ä»¶ç™¼çµ¦ main thread è™•ç†ã€‚
<blockquote>
<p>By having this information, the compositor thread can make sure to send input event to the main thread if the event occurs in that region.</p>
</blockquote>
</li>
</ol>
<ul>
<li>å¦‚æœäº’å‹•äº‹ä»¶æ˜¯åœ¨ã€Œnon-fast scrollable regionã€ä»¥å¤–çš„åœ°æ–¹ç™¼ç”Ÿï¼Œcompositor thread æœƒè² è²¬ç”¢ç”Ÿä¸€å€‹æ–°çš„ frameã€‚
<blockquote>
<p>If input event comes from <strong>outside</strong> of this region, then the compositor thread carries on <strong>compositing new frame</strong> without waiting for the main thread.</p>
</blockquote>
</li>
</ul>
<ol>
<li>äº‹ä»¶é€åˆ° main thread å¾Œï¼ŒæœƒåŸ·è¡Œ hit test ä¾†ç¢ºèª event targetã€‚hit test æœƒæŸ¥è©¢ renderer process åœ¨ paint éšæ®µçš„è³‡æ–™ï¼Œä¾†çŸ¥é“äº‹ä»¶åˆ°åº•æ˜¯åœ¨å“ªä¸€å€‹å…ƒç´ ä¸Šç™¼ç”Ÿçš„ã€‚
<blockquote>
<p>When the compositor thread sends an input event to the main thread, the first thing to run is a <strong>hit test</strong> to find the <strong>event target</strong>. Hit test uses <strong>paint records data</strong> that was generated in the rendering process to find out what is underneath the point coordinates in which the event occurred.</p>
</blockquote>
</li>
</ol>
<h2 id="è£œå……">è£œå……</h2>
<ul>
<li>æœ¬æ–‡åƒ…è¨˜éŒ„ã€ŒInside look at modern web browserã€ç³»åˆ—æ–‡ä¸­ç›®å‰èƒ½ç†è§£çš„éƒ¨åˆ†ï¼Œæœ‰æ©Ÿæœƒé‚„æ˜¯è«‹é–±è®€åŸæ–‡ã€‚</li>
<li>é—œæ–¼ã€Œæ¸²æŸ“ Renderingã€çš„ç´°éƒ¨åˆ†è§£å¯åƒè€ƒä»¥ä¸‹å½±ç‰‡ï¼š
<iframe width="560" height="315" src="https://www.youtube.com/embed/m-J-tbAlFic" title="YouTube video player" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>
</li>
</ul>
<h2 id="åƒè€ƒæ–‡ä»¶">åƒè€ƒæ–‡ä»¶</h2>
<ul>
<li>Inside look at modern web browser
<ul>
<li><a href="https://developers.google.com/web/updates/2018/09/inside-browser-part1">Inside look at modern web browser (part 1)</a></li>
<li><a href="https://developers.google.com/web/updates/2018/09/inside-browser-part2">Inside look at modern web browser (part 2)</a></li>
<li><a href="https://developers.google.com/web/updates/2018/09/inside-browser-part3">Inside look at modern web browser (part 3)</a></li>
<li><a href="https://developers.google.com/web/updates/2018/09/inside-browser-part4">Inside look at modern web browser (part 4)</a></li>
</ul>
</li>
<li>Wikipedia
<ul>
<li><a href="https://en.wikipedia.org/wiki/Process_(computing)">Process (computing)</a></li>
<li><a href="https://zh.wikipedia.org/wiki/%E8%A1%8C%E7%A8%8B">è¡Œç¨‹</a></li>
<li><a href="https://zh.wikipedia.org/wiki/%E8%A1%8C%E7%A8%8B%E9%96%93%E9%80%9A%E8%A8%8A">è¡Œç¨‹é–“é€šè¨Š</a></li>
</ul>
</li>
<li><a href="https://csstriggers.com/">CSS Triggers</a></li>
<li><a href="https://developers.google.com/web/fundamentals/performance/rendering/stick-to-compositor-only-properties-and-manage-layer-count">Stick to Compositor-Only Properties and Manage Layer Count</a></li>
</ul> </div>   <footer class="footer" data-astro-cid-qlgq3onj>
Tzu Yin (Charlie) ğŸ¦Š Made in Taiwan
</footer>  </section>  </body></html> 