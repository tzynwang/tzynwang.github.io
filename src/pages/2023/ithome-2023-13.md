---
layout: '@Components/pages/SinglePostLayout.astro'
title: æ¨æ£„ create-react-app ä¹‹é¤˜é‚„æ¶äº†å€‹ astro blog æ˜­å‘Šå¤©ä¸‹ï¼šæ­£å¼ç’°å¢ƒç”¨çš„ webpack è¨­å®š
date: 2023-09-28 11:14:14
tag:
	- [2023éµäººè³½]
banner: 2023/ithome-2023-13/patrick-campanale-oCsQLKENz34-unsplash.jpg
summary: çœ¼çœ‹å°ˆæ¡ˆæœ‰å€‹åŸºæœ¬èƒ½å‹•çš„æ¨£å­ï¼Œä½ æ‰“ç®—éƒ¨ç½²ä¸€å€‹å¯ä»¥è®“å…¶ä»–äººç©ç©çœ‹çš„æ¸¬è©¦ç«™ã€‚ç›¸è¼ƒæ–¼é–‹ç™¼ç”¨çš„ç‰ˆæœ¬ï¼Œéƒ¨ç½²ï¼ˆä¸Šç·šï¼‰ç”¨çš„ webpack è¨­å®šæœƒæ¯”è¼ƒå¼·èª¿å„ªåŒ–èˆ‡å£“ç¸®çš„éƒ¨åˆ†ï¼Œä»Šå¤©æœƒä¾†èŠèŠé€™ä¸€å¡Š
draft: true
---

å¿™äº†å¹¾å¤©ä¹‹å¾Œï¼Œä½ æ„Ÿè¦ºå°ˆæ¡ˆç¨å¾®æœ‰æ¨¡æœ‰æ¨£äº†ï¼Œæ‰“ç®—å…ˆéƒ¨ç½²ä¸€ç‰ˆæ¸¬è©¦ç«™è®“å…¶ä»–äººçœ‹çœ‹ï¼Œæ‰€ä»¥â€”â€”ä»Šå¤©çš„ä¸»é¡Œå°±æ˜¯åˆ†äº«å€‹äººåœ¨æ­£å¼ç’°å¢ƒç”¨çš„ webpack è¨­å®šã€‚

ç›¸è¼ƒæ–¼é–‹ç™¼ç‰ˆï¼Œéƒ¨ç½²ç”¨çš„è¨­å®šç§»é™¤äº† source map ä¸¦å°å…¥å£“ç¸®ã€åˆ†å¡Šï¼ˆchunkingï¼‰çš„åŠŸèƒ½ã€‚æœ‰èˆˆè¶£æ­¡è¿åƒè€ƒï¼Œç•¶ç„¶ä¹Ÿå¾ˆæ­¡è¿ä½ ç•™è¨€åˆ†äº«è‡ªå·±çš„æ„›ç”¨è¨­å®šæˆ– plugin å”· (ãƒ»âˆ€ãƒ»)

## å®Œæ•´è¨­å®š

```ts
/* Package */
import { EsbuildPlugin } from 'esbuild-loader';
import HtmlWebpackPlugin from 'html-webpack-plugin';
import MiniCssExtractPlugin from 'mini-css-extract-plugin';
import Webpack from 'webpack';

/* Tool */
import { resolvePath } from '@/tool/resolvePath';

/* Data */
import alias from './data/alias';
import env from './data/env';
import type { WebpackConfiguration, EnvForBuildApp } from './data/types';

const envForBuildApp = env['process.env'] as EnvForBuildApp;

/* Main */
const webpackProductionConfig: WebpackConfiguration = {
  mode: 'production',
  entry: resolvePath('src/index'),
  output: {
    filename: 'static/js/[name].[contenthash:8].js',
    path: resolvePath(JSON.parse(envForBuildApp.BUILD_DESTINATION)),
    clean: true,
  },
  optimization: {
    splitChunks: {
      chunks: 'all',
      maxSize: 20000, // å–®ä½ bytes ï¼Œé€™è£¡æ˜¯ 20kb
      cacheGroups: {
        defaultVendors: {
          test: /[\\/]node_modules[\\/]/,
          priority: -10,
        },
        default: {
          minChunks: 10,
        },
      },
    },
    minimizer: [
      new EsbuildPlugin({
        target: 'es2015',
        css: true,
      }),
    ],
  },
  module: {
    rules: [
      {
        test: /\.(js|ts|tsx)$/,
        loader: 'esbuild-loader',
        options: {
          loader: 'tsx',
          target: 'es2015',
        },
      },
      {
        test: /\.(png|svg|jpg)$/i,
        type: 'asset/resource',
        resourceQuery: /url/,
      },
      {
        test: /\.svg$/i,
        issuer: /\.tsx?$/,
        resourceQuery: { not: [/url/] },
        use: [
          {
            loader: '@svgr/webpack',
            options: {
              svgo: false,
              ref: true,
            },
          },
        ],
      },
      {
        test: /\.css$/,
        exclude: /\.module\.css$/,
        use: [
          {
            loader: MiniCssExtractPlugin.loader,
          },
          {
            loader: 'css-loader',
            options: {
              sourceMap: false,
            },
          },
        ],
      },
      {
        test: /\.module\.css$/,
        use: [
          {
            loader: MiniCssExtractPlugin.loader,
          },
          {
            loader: 'css-loader',
            options: {
              sourceMap: false,
              modules: {
                mode: 'local',
                localIdentName: '[hash:base64]',
              },
            },
          },
        ],
      },
    ],
  },
  plugins: [
    new HtmlWebpackPlugin({
      inject: true,
      template: resolvePath('public/index.html'),
      publicPath: '/',
    }),
    new Webpack.DefinePlugin({ ...env }),
    new MiniCssExtractPlugin({
      filename: 'static/css/[name].[contenthash:8].css',
      chunkFilename: 'static/css/[name].[contenthash:8].chunk.css',
    }),
  ],
  resolve: {
    extensions: ['.js', '.ts', '.tsx'],
    alias,
  },
};

export default webpackProductionConfig;
```

### è§£èªª

Package å€å¡Šï¼š

æ­¤å€åˆ—å‡ºéƒ¨ç½²æ™‚æœƒç”¨åˆ°çš„å¥—ä»¶ã€‚ç›¸è¼ƒæ–¼é–‹ç™¼ç”¨è¨­å®šï¼Œè¿½åŠ äº† `mini-css-extract-plugin` å”åŠ©è™•ç† css ç›¸é—œå…§å®¹ã€‚

---

Tool å€å¡Šï¼š

ä½¿ç”¨[ç¬¬ 8 å¤©](/2023/ithome-2023-8)å¯«å¥½çš„å°å·¥å…· `resolvePath` ä¾†è™•ç†æª”æ¡ˆè·¯å¾‘ã€‚

---

Data å€å¡Šï¼š

å¼•ç”¨[ç¬¬ 7 å¤©](/2023/ithome-2023-7) èˆ‡ [ç¬¬ 8 å¤©](/2023/ithome-2023-8)è™•ç†å¥½çš„ `env` èˆ‡ `alias` å…§å®¹ï¼Œä¸¦é€é `const envForBuildApp = env['process.env'] as EnvForBuildApp;` å–ç”¨é©—è­‰éçš„éƒ¨ç½²ç”¨ç’°å¢ƒè®Šæ•¸ã€‚

---

Main éƒ¨åˆ†ï¼š

è¨­å®š `mode: production` ä¸¦æŒ‡å®šæ‰“åŒ…å…¥å£é»ç‚º `entry: resolvePath('src/index')`ã€‚

åœ¨ `output` å…§é€é `path` è¨­å®šæœ€çµ‚è¼¸å‡ºç›®çš„åœ°ï¼Œä¸Šæ–¹è¨­å®šç¿»è­¯æˆç™½è©±æ–‡å°±æ˜¯ï¼šé€é `resolvePath()` è§£å‡ºç’°å¢ƒè®Šæ•¸ `BUILD_DESTINATION` çš„çµ•å°è·¯å¾‘ï¼Œæ‰“åŒ…å®Œç•¢çš„æ±è¥¿è«‹é€åˆ°é€™å€‹è³‡æ–™å¤¾ã€‚

è€Œå› ç‚ºæ‰“ç®—åš code splittingï¼Œæ‰€ä»¥æŒ‡å®šè¼¸å‡ºçš„ bundle æª”æ¡ˆåç¨±ç‚º `static/js/[name].[contenthash:8].js`ã€‚è©³ç´°èªªæ˜å¯åƒè€ƒ [webpack 5 output.filename](https://webpack.js.org/configuration/output/#outputfilename) çš„å…§å®¹ã€‚

è¨­å®š `output.clean: true` ä»£è¡¨æ¯æ¬¡æ‰“åŒ…å‰éƒ½å…ˆ[æ¸…ç©ºç›®çš„åœ°è³‡æ–™å¤¾](https://webpack.js.org/configuration/output/#outputclean)ã€‚å€‹äººé¸æ“‡é€™æ¨£è¨­å®šæ˜¯å› ç‚ºï¼š

1. é¿å…ä»»ä½•æª”æ¡ˆæ®˜ç•™å½±éŸ¿çš„å¯èƒ½æ€§
2. è©•ä¼°ç•¶ä¸‹å°ˆæ¡ˆçš„éœæ…‹æª”æ¡ˆæ²’æœ‰å¤šåˆ°éœ€è¦åšæª”æ¡ˆå¿«å–ä¾†åŠ é€Ÿæ‰“åŒ…æµç¨‹ï¼Œæ•…é¸æ“‡å…¨åˆª

`optimization` åˆ†æˆ `splitChunks` èˆ‡ `minimizer` å…©éƒ¨åˆ†ã€‚åˆ†å¡Šè¨­å®šå¤§éƒ¨åˆ†åƒè€ƒè‡ª [webpack 5: optimization.splitChunks](https://webpack.js.org/plugins/split-chunks-plugin/#optimizationsplitchunks) å…§å®¹ã€‚

è¨­å®š `chunks: 'all'` ä»£è¡¨æ‰€æœ‰çš„åˆ†å¡Šéƒ½æœƒè¢«[ç´å…¥å„ªåŒ–è™•ç†](https://webpack.js.org/plugins/split-chunks-plugin/#splitchunkschunks)ã€‚å› è¨­å®šå¾Œå¯¦æ¸¬æ‰“åŒ…é€Ÿåº¦é‚„èƒ½ç¶­æŒ 5 ç§’å·¦å³çµæŸï¼Œæ•…é€™è£¡é¸æ“‡ä½¿ç”¨æ¥µé™å„ªåŒ–ã€‚

`maxSize: 20000`ï¼ˆå–®ä½ç‚º bytes æ‰€ä»¥å¯¦éš›ä¸Šä»£è¡¨ 20kbï¼‰æŒ‡ç¤º webpack ç›¡é‡å°‡å¤§æ–¼é€™å€‹å°ºå¯¸çš„åˆ†å¡Šç¹¼çºŒå¾€ä¸‹åˆ†è§£ã€‚

> Using [`maxSize`](https://webpack.js.org/plugins/split-chunks-plugin/#splitchunksmaxsize) tells webpack to try to split chunks bigger than `maxSize` **bytes** into smaller parts.

`minChunks: 10` ä»£è¡¨ã€Œè‡³å°‘è¦æœ‰ 10 è™•ä»¥ä¸Šçš„å¼•ç”¨ï¼Œæ‰æœƒè¢«åˆ†å¡Šã€ï¼š

> [splitChunks.minChunks](https://webpack.js.org/plugins/split-chunks-plugin/#splitchunksminchunks): The minimum times must a module be shared among chunks before splitting.

è€Œ `minimizer` ä¸­é¸æ“‡ä½¿ç”¨æ—¢æœ‰çš„ `EsbuildPlugin` ä¾†å”åŠ©å£“ç¸® css è¼¸å‡ºå…§å®¹ã€ä¸å†å¦å¤–å®‰è£å¥—ä»¶ã€‚å®Œæ•´ä»‹ç´¹å¯åƒè€ƒ[å®˜æ–¹èªªæ˜](https://github.com/esbuild-kit/esbuild-loader#css-minification)ã€‚

`module.rules` èˆ‡é–‹ç™¼è¨­å®šä¸åŒçš„åœ°æ–¹åœ¨æ–¼å–æ¶ˆ sourceMapï¼Œä¸¦æ­é… `MiniCssExtractPlugin.loader` å°‡ `.css` å…§å®¹ç¨ç«‹ç‚ºä¸€ä»½æª”æ¡ˆã€‚

> [mini-css-extract-plugin](https://github.com/webpack-contrib/mini-css-extract-plugin#mini-css-extract-plugin-1): This plugin extracts CSS into separate files.

å¯çœ‹åˆ° `plugins` ç´å…¥äº† `new MiniCssExtractPlugin({ ... })` è¨­å®šã€‚èˆ‡æœ€ä¸Šæ–¹çš„ `output` é¡ä¼¼ï¼Œé€™è£¡é€é `mini-css-extract-plugin` æŒ‡å®š `.css`æª”æ¡ˆéƒ½è¦åŒ…é€²è¼¸å‡ºè³‡æ–™å¤¾ä¸­çš„ `./static/css` ä¸­ã€‚

## è¼¸å‡ºçµæœ

åŸ·è¡Œï¼ˆæ˜å¤©æœƒèªªæ˜ç´°ç¯€ï¼‰ä»¥ä¸Šæ‰“åŒ…è¨­å®šå¾Œï¼Œå°ˆæ¡ˆæ ¹ç›®éŒ„æœƒå‡ºç¾ä¸€å€‹ `./build` è³‡æ–™å¤¾ï¼Œçµæ§‹åŸºæœ¬å¦‚ä¸‹ï¼š

```bash
./build
â”œâ”€â”€ index.html
â”œâ”€â”€ ï¼ˆè¼¸å‡ºå¾Œçš„æ ¹ç›®éŒ„æœƒåŒ…å«ä¸€äº›è¢« index.html å¼•ç”¨çš„éœæ…‹æª”æ¡ˆï¼Œæœƒæ–¼å¾ŒçºŒéµäººè³½ä¸­èªªæ˜ï¼‰
â””â”€â”€ static
    â”œâ”€â”€ css
    â”‚   â””â”€â”€ main-31743c5a.b5b18614.css
    â””â”€â”€ js
        â”œâ”€â”€ ï¼ˆçœç•¥äº†éå¸¸å¤šçš„åˆ†å¡Šæª”æ¡ˆï¼Œä¸ç„¶å…§å®¹æœƒå¤ªé•·ï¼‰
        â”œâ”€â”€ main-f16aa68b.5879c5ca.js
        â””â”€â”€ main-f6eac33a.2dac1962.js
```

é€™æ™‚å·²ç¶“å¯ä»¥é€é vs code çš„ [Live Server](https://marketplace.visualstudio.com/items?itemName=ritwickdey.LiveServer) æˆ– npm å¥—ä»¶ [http-server](https://www.npmjs.com/package/http-server) ä¾†é è¦½æ‰“åŒ…æˆæœäº†ã€‚

æœ€å¾Œï¼Œè¬è¬ä½ æ’éä»Šå¤©çš„è§£èªª ğŸ‘

![Speedwagon](/2023/ithome-2023-13/Speedwagon.jpeg)
