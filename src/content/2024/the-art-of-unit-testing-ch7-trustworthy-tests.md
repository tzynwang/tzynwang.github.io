---
title: é–±è®€ç­†è¨˜ï¼šThe Art of Unit Testing Chapter 7 Trustworthy tests
date: 2024-01-21 10:45:50
tag:
	- [Testing]
banner: /2024/the-art-of-unit-testing-ch7-trustworthy-tests/hannah-busing-Zyx1bK9mqmA-unsplash.jpg
summary: æœ¬æ›¸ç¬¬ä¸€ç« æ›¾æéï¼Œå¥½çš„å–®å…ƒæ¸¬è©¦æ‡‰æœ‰ä¸‰ç¨®ç‰¹å¾µâ€”â€”å¥½è®€ã€å€¼å¾—ä¿¡ä»»ã€å¥½ç¶­è­·ã€‚ç¬¬äºŒåˆ°å…­ç« èªªæ˜äº†å¦‚ä½•å¯«å‡ºã€Œå¥½è®€ã€çš„æ¸¬è©¦ï¼Œè€Œé€™ä¸€ç« å‰‡æœƒèªªæ˜ã€Œä¿¡ä»»æ„Ÿã€åœ¨å–®å…ƒæ¸¬è©¦ä¸­æ‰®æ¼”ä»€éº¼è§’è‰²ã€‚
draft: 
---

## intro

æœ¬æ›¸ç¬¬ä¸€ç« æ›¾æéï¼Œå¥½çš„å–®å…ƒæ¸¬è©¦æ‡‰æœ‰ä¸‰ç¨®ç‰¹å¾µâ€”â€”å¥½è®€ã€å€¼å¾—ä¿¡ä»»ã€å¥½ç¶­è­·ã€‚ç¬¬äºŒåˆ°å…­ç« èªªæ˜äº†å¦‚ä½•å¯«å‡ºã€Œå¥½è®€ã€çš„æ¸¬è©¦ï¼Œè€Œé€™ä¸€ç« å‰‡æœƒèªªæ˜ã€Œä¿¡ä»»æ„Ÿã€åœ¨å–®å…ƒæ¸¬è©¦ä¸­æ‰®æ¼”ä»€éº¼è§’è‰²ã€‚

## ä½•è¬‚ä¿¡ä»»æ„Ÿ

ä¸€å€‹å–®å…ƒæ¸¬è©¦å¦‚æœå€¼å¾—ä¿¡ä»»ï¼Œå°±ä»£è¡¨æˆ‘å€‘å…¨å¿ƒç›¸ä¿¡è©²æ¸¬è©¦æ¯ä¸€æ¬¡åŸ·è¡Œçš„çµæœã€‚

> We accept the test results with confidence.

ç•¶æˆ‘å€‘ä¿¡ä»»çš„æ¸¬è©¦ç´…ç‡ˆæ™‚ï¼Œæˆ‘å€‘æœƒèªçœŸé™¤éŒ¯ï¼Œè€Œä¸æ˜¯æ©Ÿæ¢°æ€§åœ°å†è·‘ä¸€æ¬¡æ¸¬è©¦ï¼ŒæœŸå¾…çµæœè®Šç¶ ç‡ˆã€‚ç•¶æˆ‘å€‘ä¿¡ä»»çš„æ¸¬è©¦ç¶ ç‡ˆæ™‚ï¼Œæˆ‘å€‘ä¾¿ç¢ºä¿¡è©²å–®å…ƒ 100% åŠŸèƒ½æ­£å¸¸ï¼Œä¸éœ€è¦å†ã€Œæ‰‹å‹•æª¢æŸ¥ä¸€ä¸‹ï¼Œä»¥é˜²è¬ä¸€ã€ã€‚

## ç‚ºä½•æ¸¬è©¦æœƒç´…ç‡ˆ

- ğŸ‘ å› ç‚ºç¨‹å¼ç¢¼çœŸçš„æœ‰å•é¡Œï¼šé€™å¾ˆæ­£ç•¶çš„ç´…ç‡ˆåŸå› ï¼Œç•¢ç«Ÿå–®å…ƒæ¸¬è©¦æœ¬ä¾†å°±æ˜¯ç‚ºäº†å¹«å¿™æª¢æŸ¥ç¨‹å¼ç¢¼çš„åŠŸèƒ½æ˜¯å¦æ­£å¸¸
- âŒ å› ç‚ºæ¸¬è©¦å·²ç¶“å’Œç¾è¡Œå¯¦ä½œè„«é‰¤ï¼šå¦‚æœæ˜¯é€™å€‹ç†ç”±ï¼Œè«‹åˆªæ‰éæ™‚çš„æ¸¬è©¦ï¼Œä¸¦æ ¹æ“šç•¶ä¸‹çš„å¯¦ä½œå…§å®¹æ’°å¯«æ–°çš„å–®å…ƒæ¸¬è©¦
- âŒ éŒ¯çš„æ˜¯æ¸¬è©¦ï¼šè©³è¦‹ä¸‹æ–¹ç­†è¨˜
- âŒ åè¦†ç„¡å¸¸çš„æ¸¬è©¦ï¼ˆflaky Testï¼‰ï¼šè©³è¦‹ä¸‹æ–¹ç­†è¨˜

### éŒ¯çš„æ˜¯æ¸¬è©¦

è¢«æª¢é©—çš„å–®å…ƒæ²’æœ‰ä»»ä½•åŠŸèƒ½ç‘•ç–µï¼Œåè€Œæ˜¯å–®å…ƒæ¸¬è©¦é©—è­‰çš„å…§å®¹æœ‰èª¤ï¼Œæˆ–èª¤æœƒå–®å…ƒçš„ä½¿ç”¨æ–¹å¼ï¼Œå°è‡´æ¸¬è©¦å¤±æ•—â€”â€”é€™å°±æ˜¯å¯«å£çš„æ¸¬è©¦ã€‚å¯ä»¥é€éã€Œå…ˆå¯«æ¸¬è©¦ï¼Œå†å¯¦ä½œã€ï¼ˆæ¸¬è©¦é©…å‹•é–‹ç™¼ / TDDï¼‰çš„é–‹ç™¼æµç¨‹ä¾†æ¸›å°‘é€™é¡å•é¡Œï¼ˆåƒè€ƒ[ç¬¬ä¸€ç« çš„ç­†è¨˜](/2023/the-art-of-unit-testing-ch1-the-basic-of-unit-testing#110-test-driven-development)ï¼‰ã€‚

æˆ‘å€‘ä¹Ÿè¦é¿å…åœ¨æ¸¬è©¦ä¸­ä½¿ç”¨é‚è¼¯ï¼Œæ¯”å¦‚ä¸‹åˆ—ä¸è‰¯ç¤ºç¯„ï¼š

```js
const makeGreeting = (name) => {
  return 'hello' + name;
};

describe('makeGreeting', () => {
  it('should return string hello with name', () => {
    const name = 'abc';
    const result = trust.makeGreeting(name);
    expect(result).toBe('hello' + name);
  });
});
```

å¦‚æœä¸€æ®µé‚è¼¯å·²ç¶“æœ‰å•é¡Œï¼Œé‚£éº¼ï¼ŒæŠŠè©²é‚è¼¯ç…§æ¬åˆ°å–®å…ƒæ¸¬è©¦è£¡åªæœƒè®“å•é¡Œç¹¼çºŒè¢«åŸ‹æ²’ã€‚ä¸Šè¿°æ¸¬è©¦ç„¡æ³•å¹«å¿™æŸ¥å‡ºã€Œè¼¸å‡ºçš„ `hello` èˆ‡åƒæ•¸ `name` ä¹‹é–“ä¸¦æ²’æœ‰ç©ºç™½ã€çš„å•é¡Œã€‚

ç›´æ¥é©—è­‰å¯«æ­»çš„å€¼ï¼Œåè€Œèƒ½æ­£ç¢ºåæ‡‰è©²å–®å…ƒçš„å•é¡Œï¼š

```js
describe('makeGreeting', () => {
  it('should return `hello ${name}`', () => {
    const result = trust.makeGreeting('abc');
    expect(result).toBe('hello abc');
  });
});
```

---

ä»¥ä¸‹æ˜¯å¦ä¸€å€‹è² é¢æ•™æï¼š

```js
const isName = (input) => {
  return input.split(' ').length === 2;
};

describe('isName', () => {
  const namesToTest = ['firstOnly', 'firstÂ second', ''];
  it('correctlyÂ findsÂ outÂ ifÂ itÂ isÂ aÂ name', () => {
    namesToTest.forEach((name) => {
      const result = trust.isName(name);
      if (name.includes('Â ')) {
        expect(result).toBe(true);
      } else {
        expect(result).toBe(false);
      }
    });
  });
});
```

ä½¿ç”¨è¿´åœˆèˆ‡æ¢ä»¶åˆ¤æ–·é™¤äº†è®“æ¸¬è©¦æœ¬èº«è®Šå¾—ä¸æ˜“é–±è®€ä»¥å¤–ï¼Œç•¶æ¸¬è©¦ç´…ç‡ˆæ™‚ï¼Œé€™ç¨®å¯«æ³•ä¹Ÿæœƒæå‡é™¤éŒ¯çš„å›°é›£åº¦ã€‚Jest é›–ç„¶æœƒæç¤ºå‡ºéŒ¯æ¸¬è©¦çš„åç¨±ï¼Œä½†é€™ä¸¦ä¸æœƒè®“æˆ‘å€‘çŸ¥é“ã€Œæ˜¯é™£åˆ—ä¸­çš„å“ªä¸€å€‹é …ç›®å°è‡´æ¸¬è©¦å¤±æ•—ã€ã€‚å·¥ç¨‹å¸«åªèƒ½è€è‘—æ€§å­ä¸€è¡Œä¸€è¡Œåœ°è®€ï¼Œä¸¦åœ¨è…¦ä¸­é‹è¡Œæ¯ä¸€çµ„è¿´åœˆçš„åŸ·è¡Œçµæœã€‚

çµè«–ï¼šè¡¨é¢ä¸Šçœ‹èµ·ä¾†æ˜¯å°‘å¯«äº†å¹¾è¡Œç¨‹å¼ç¢¼ï¼Œä½†å‡ºåŒ…æ™‚çš„ä¿®ç¹•æˆæœ¬æ¯”å¤šå¯«å¹¾çµ„æ¸¬è©¦é«˜å¤ªå¤šäº†ã€‚

### åè¦†ç„¡å¸¸çš„æ¸¬è©¦

æŒ‡é‚£äº›åœ¨ç¨‹å¼ç¢¼æˆ–å–®å…ƒæ¸¬è©¦æ²’æœ‰ä»»ä½•æ”¹å‹•æ™‚ï¼ŒåŸ·è¡Œçµæœä¾¿æ™‚å¥½æ™‚å£çš„è©­ç•°æ¸¬è©¦ã€‚

![åè¦†è©¦æ¢](/2024/the-art-of-unit-testing-ch7-trustworthy-tests/åè¦†è©¦æ¢.png)

ä»¥å¸¸ç†è€Œè¨€ï¼Œæ¸¬è©¦ä¸­çš„ä¾è³´ï¼ˆä¸å¯æ§çš„éƒ¨åˆ†ï¼‰è¶Šå¤šï¼Œæ¸¬è©¦æ™‚å¥½æ™‚å£çš„å¯èƒ½æ€§å°±è¶Šé«˜ã€‚ä½†é€™æ˜¯ e2e èˆ‡ç³»çµ±æ¸¬è©¦ï¼ˆsystem testingï¼‰ç„¡æ³•é¿å…çš„ä¸€éƒ¨åˆ†â€”â€”ç•¢ç«Ÿæˆ‘å€‘åŸ·è¡Œé€™äº›æ¸¬è©¦ï¼Œå°±æ˜¯ç‚ºäº†ç›¡å¯èƒ½è²¼è¿‘çœŸå¯¦æƒ…æ³ã€‚è€Œç¾å¯¦ä¸–ç•Œä¸­çš„ä¾è³´ï¼ˆreal dependency / moving partï¼‰ç•¢ç«Ÿæ²’æœ‰é‚£éº¼å¥½æ§åˆ¶ï¼šè³‡æ–™åº«çš„å…§å®¹æœƒè®Šã€ç¶²è·¯å¯èƒ½ä¸ç©©ã€ä½¿ç”¨è€…çš„è£ç½®ç‰ˆæœ¬å¯èƒ½å‡ºä¹æ„æ–™çš„èˆŠ â‹¯â‹¯ã€‚

![flakiness chart](/2024/the-art-of-unit-testing-ch7-trustworthy-tests/flakiness-chart.png)

ä½†å°å–®å…ƒæ¸¬è©¦è€Œè¨€ï¼Œçµæœåè¦†ç„¡å¸¸æ˜¯ä¸å¯å®¹å¿çš„ã€‚é™¤äº†åƒè€ƒæœ¬æ›¸é—œæ–¼ stub/mock çš„ç« ç¯€ä¾†å¢å‰å°æ¸¬è©¦ç’°å¢ƒçš„æ§åˆ¶å¤–ï¼Œå°æ–¼é‚£äº›å¯¦åœ¨ç„¡æ³•æ”¶ç·¨çš„æ¸¬è©¦ï¼Œè«‹è€ƒæ…®åˆªé™¤ä¹‹ã€‚

## ä¸å¯ä¿¡çš„ç¶ ç‡ˆ

å¦‚æœå–®å…ƒæ¸¬è©¦æœ‰å¯èƒ½å› ç‚ºæœ¬èº«çš„é‚è¼¯éŒ¯èª¤å°è‡´èª¤å ±ï¼ˆç´…ç‡ˆï¼‰ï¼Œé‚£è‡ªç„¶ä¹Ÿæœƒæœ‰ä¸€äº›ç†ç”±å°è‡´å–®å…ƒæ¸¬è©¦çµ¦å‡ºè™›å‡çš„ç¶ ç‡ˆã€‚é€™é¡æ‡‰å¤±æ•—ä½†æœªå¤±æ•—çš„æ¸¬è©¦åŸºæœ¬ä¸Šï¼š

1. æ ¹æœ¬æ²’æœ‰åŸ·è¡Œé©—è­‰ï¼ˆassertï¼‰
2. åŸ·è¡Œäº†æ¨¡ç¨œå…©å¯çš„åé¢é©—è­‰ï¼Œæ¯”å¦‚ä»¥ä¸‹ç¯„ä¾‹ï¼š

```js
expect(() => someFunction()).not.toThrow(error);
```

é€™å€‹æ¸¬è©¦åªè®“æˆ‘å€‘çŸ¥é“ `someFunction` æ²’æœ‰æ‹‹éŒ¯ï¼Œä½†æˆ‘å€‘ä¹Ÿç„¡æ³•çŸ¥é“é€™å€‹åŠŸèƒ½çš„ã€Œè¡¨ç¾æ­£å¸¸ã€åˆ°åº•æ˜¯ä»€éº¼ã€‚é€™å€‹ç¶ ç‡ˆåªæ˜¯æ¶ˆæ¥µåœ°ç¢ºä¿ã€ŒæŸåŠŸèƒ½æ²’æœ‰å‡ºéŒ¯ã€ã€‚

è«‹ä½¿ç”¨ `.toBe()` `.toEqual()` é€™é¡æ­£é¢çš„æ¯”å°åŠŸèƒ½ï¼ˆMatcherï¼‰å’Œé€€å‡ºé»ä¸€æ±ºå‹è² ã€‚

![jojo-approach.png](/2024/the-art-of-unit-testing-ch7-trustworthy-tests/jojo-approach.png)

## å…¶ä»–æ³¨æ„äº‹é …

ä¸è¦åœ¨ä¸€å€‹å–®å…ƒæ¸¬è©¦è£¡åŸ·è¡Œå¤šæ¬¡é©—è­‰ï¼ˆ`expect()`ï¼‰â€”â€”ç•¶æ¸¬è©¦å¤±æ•—æ™‚ï¼Œä½ æœƒéœ€è¦å¤šèŠ±æ™‚é–“ç¢ºèªåˆ°åº•æ˜¯å“ªä¸€çµ„ `expect()` å¤±æ•—ã€‚

å¦‚æœæœ‰è¤‡æ•¸ç¨®æƒ…å¢ƒéœ€è¦é©—è­‰ï¼Œå°±ç‚ºä¸åŒçš„æƒ…å¢ƒæ’°å¯«å°æ‡‰çš„å–®å…ƒæ¸¬è©¦ã€‚é€™ä¹Ÿèƒ½é¿å…æˆ‘å€‘ç”¨å¤ªæ”çµ±çš„åç¨±ä¾†æè¿°ä¸€å€‹æ¸¬è©¦ã€‚æ¯”å¦‚ä»¥ä¸‹ç¯„ä¾‹ï¼š

```js
describe('trigger', () => {
  it('should work as expect', () => {
    const callback = jest.fn();
    const result = trigger(1, 2, callback);
    expect(result).toBe(3);
    expect(callback).toHaveBeenCalledWith("I'mÂ triggered");
  });
});
```

å¯ä»¥æ‹†ç‚ºå…©çµ„å‘½åæ›´å…·é«”çš„å–®å…ƒæ¸¬è©¦ï¼š

```js
describe('trigger', () => {
  it('should run the callback', () => {
    const callback = jest.fn();
    trigger(1, 2, callback);
    expect(callback).toHaveBeenCalledWith("I'mÂ triggered");
  });
  it('should return the sumÂ from theÂ givenÂ values', () => {
    const result = trigger(1, 2, jest.fn());
    expect(result).toBe(3);
  });
});
```

## åƒè€ƒæ–‡ä»¶

- [Manning: The Art of Unit Testing, Third Edition](https://www.manning.com/books/the-art-of-unit-testing-third-edition)
- [Stack Overflow: What does â€œDAMP not DRYâ€ mean when talking about unit tests?](https://stackoverflow.com/a/11837973)
- [Enterprise Craftsmanship: DRY vs DAMP in Unit Tests](https://enterprisecraftsmanship.com/posts/dry-damp-unit-tests/)
