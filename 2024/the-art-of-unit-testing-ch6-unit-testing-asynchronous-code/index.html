<!DOCTYPE html><html lang="en"> <head><meta name="astro-view-transitions-enabled" content="true"><meta name="astro-view-transitions-fallback" content="animate"><script type="module" src="/_astro/ClientRouter.astro_astro_type_script_index_0_lang.BScVxmeO.js"></script><!-- Google Tag Manager --><script>(function(){const ga4Id = "G-6QC9CKHCTY";

      (function (w, d, s, l, i) {
        w[l] = w[l] || [];
        w[l].push({ 'gtm.start': new Date().getTime(), event: 'gtm.js' });
        var f = d.getElementsByTagName(s)[0],
          j = d.createElement(s),
          dl = l != 'dataLayer' ? '&l=' + l : '';
        j.async = true;
        j.src = 'https://www.googletagmanager.com/gtm.js?id=' + i + dl;
        f.parentNode.insertBefore(j, f);
      })(window, document, 'script', 'dataLayer', ga4Id);
    })();</script><!-- Google tag (gtag.js) --><script async src="https://www.googletagmanager.com/gtag/js?id=GTM-KM9SGJLK">(function(){const gTagId = "GTM-KM9SGJLK";
})();</script><script>(function(){const ga4Id = "G-6QC9CKHCTY";

      window.dataLayer = window.dataLayer || [];
      function gtag() {
        dataLayer.push(arguments);
      }
      gtag('js', new Date());
      gtag('config', ga4Id);
    })();</script><!-- Global Metadata --><meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1"><link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ğŸ¦Š</text></svg>"><link rel="sitemap" href="/sitemap-index.xml"><meta name="generator" content="Astro v5.1.2"><!-- Primary Meta Tags --><title>é–±è®€ç­†è¨˜ï¼šThe Art of Unit Testing Chapter 6 Unit testing asynchronous code</title><meta name="title" content="é–±è®€ç­†è¨˜ï¼šThe Art of Unit Testing Chapter 6 Unit testing asynchronous code"><meta name="description" content="æœ¬ç« æä¾›å…©ç¨®å¯¦ä½œæŠ€å·§è®“æˆ‘å€‘èƒ½ç‚ºã€ŒåŒ…å«éåŒæ­¥åŠŸèƒ½ã€çš„å–®å…ƒå¯«å‡ºè‰¯å¥½çš„å–®å…ƒæ¸¬è©¦ï¼Œå…¶ç‚ºã€Œåˆ†é›¢é€²å…¥é»ï¼ˆextracting an entry pointï¼‰ã€èˆ‡ã€Œé…æ¥å™¨æ¨¡å¼ï¼ˆadapter patternï¼‰ã€"><!-- Open Graph / Facebook --><meta property="og:type" content="website"><meta property="og:url" content="https://tzynwang.github.io/2024/the-art-of-unit-testing-ch6-unit-testing-asynchronous-code"><meta property="og:title" content="é–±è®€ç­†è¨˜ï¼šThe Art of Unit Testing Chapter 6 Unit testing asynchronous code"><meta property="og:description" content="æœ¬ç« æä¾›å…©ç¨®å¯¦ä½œæŠ€å·§è®“æˆ‘å€‘èƒ½ç‚ºã€ŒåŒ…å«éåŒæ­¥åŠŸèƒ½ã€çš„å–®å…ƒå¯«å‡ºè‰¯å¥½çš„å–®å…ƒæ¸¬è©¦ï¼Œå…¶ç‚ºã€Œåˆ†é›¢é€²å…¥é»ï¼ˆextracting an entry pointï¼‰ã€èˆ‡ã€Œé…æ¥å™¨æ¨¡å¼ï¼ˆadapter patternï¼‰ã€"><meta property="og:image" content="https://tzynwang.github.io/2024/the-art-of-unit-testing-ch6-unit-testing-asynchronous-code/age-barros-rBPOfVqROzY-unsplash.jpg"><!-- Twitter --><meta property="twitter:card" content="summary_large_image"><meta property="twitter:url" content="https://tzynwang.github.io/2024/the-art-of-unit-testing-ch6-unit-testing-asynchronous-code"><meta property="twitter:title" content="é–±è®€ç­†è¨˜ï¼šThe Art of Unit Testing Chapter 6 Unit testing asynchronous code"><meta property="twitter:description" content="æœ¬ç« æä¾›å…©ç¨®å¯¦ä½œæŠ€å·§è®“æˆ‘å€‘èƒ½ç‚ºã€ŒåŒ…å«éåŒæ­¥åŠŸèƒ½ã€çš„å–®å…ƒå¯«å‡ºè‰¯å¥½çš„å–®å…ƒæ¸¬è©¦ï¼Œå…¶ç‚ºã€Œåˆ†é›¢é€²å…¥é»ï¼ˆextracting an entry pointï¼‰ã€èˆ‡ã€Œé…æ¥å™¨æ¨¡å¼ï¼ˆadapter patternï¼‰ã€"><meta property="twitter:image" content="https://tzynwang.github.io/2024/the-art-of-unit-testing-ch6-unit-testing-asynchronous-code/age-barros-rBPOfVqROzY-unsplash.jpg"><!-- Font --><link rel="preconnect" href="https://fonts.googleapis.com"><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin><link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;700&family=Noto+Sans:wght@400;700&display=swap" rel="stylesheet"><style>.tag[data-astro-cid-2iymvi75]{position:relative;display:inline-flex;align-items:center;padding:2px 8px;font-size:14px;font-weight:400;text-decoration:none;background-color:#8aa6a3;color:#fff;transition:background-color .2s ease-in-out}.tag[data-astro-cid-2iymvi75]:not(:last-of-type){margin-right:8px}.tag[data-astro-cid-2iymvi75]:hover{background-color:#127369}
.astro-route-announcer{position:absolute;left:0;top:0;clip:rect(0 0 0 0);clip-path:inset(50%);overflow:hidden;white-space:nowrap;width:1px;height:1px}.footer[data-astro-cid-qlgq3onj]{padding:36px;text-align:center}.bottom[data-astro-cid-qlgq3onj]{position:absolute;bottom:0;left:50%;transform:translate(-50%)}.side-content[data-astro-cid-75hifxor],.main-content[data-astro-cid-75hifxor]{margin:24px}nav[data-astro-cid-75hifxor]{display:flex;gap:16px}@media screen and (min-width: 800px){body{height:100vh;display:flex;flex-direction:row;overflow-y:hidden}nav[data-astro-cid-75hifxor]{flex-direction:column}.side-content[data-astro-cid-75hifxor]{flex:0 0 240px}.main-content[data-astro-cid-75hifxor]{margin:0;padding:40px 24px 0;flex:1 1 auto;overflow-y:auto;position:relative}}*{margin:0;padding:0;box-sizing:content-box;font-family:sans-serif;text-wrap:pretty;color:#000000e6}html{background-color:#bfbfbf66}a{color:#127369;font-weight:700;text-decoration:underline;text-decoration-color:transparent;transition:text-decoration-color .2s ease-in-out}a:hover{text-decoration-color:#127369}a.link-out{position:absolute;inset:0}ul,li{list-style-position:inside}ul:not(:has(li)){margin-top:16px;margin-bottom:16px}li{margin-top:4px;margin-bottom:4px;line-height:24px}li li{padding-left:16px}img{display:block;max-width:100%}h1,h2{font-size:28px;line-height:42px;margin:16px 0;color:#4c5958}h3,h4{font-size:22px;line-height:34px;margin:16px 0;color:#4c5958}h5{font-size:18px;line-height:28px;margin:4px 0;color:#4c5958}p{font-size:16px;line-height:24px;margin:16px 0}p code{font-size:14px}blockquote{padding-left:16px;border-left:4px solid #4c5958}blockquote *{font-family:Noto Sans,sans-serif}pre{padding:8px 16px}code,code span{font-family:monospace}hr{width:100%;height:1px;margin:16px 0;background-color:#4c5958}del{color:#4c5958e6}ol>li:has(p)>p{display:inline;margin:0}
.post-container[data-astro-cid-qtokga5y] h1[data-astro-cid-qtokga5y]{margin:0 0 16px}.info[data-astro-cid-qtokga5y]{display:flex;flex-direction:column;gap:8px}.toc-container[data-astro-cid-qtokga5y]{margin-bottom:0}.toc-container[data-astro-cid-qtokga5y]>li[data-astro-cid-qtokga5y]:not(:last-of-type){margin-bottom:4px}.toc-2[data-astro-cid-qtokga5y]{margin-left:1rem}.toc-3[data-astro-cid-qtokga5y]{margin-left:2rem}.toc-4[data-astro-cid-qtokga5y]{margin-left:3rem}.toc-5[data-astro-cid-qtokga5y]{margin-left:4rem}@media screen and (min-width: 800px){.post-container[data-astro-cid-qtokga5y]{max-width:600px}}@media screen and (min-width: 1200px){.post-container[data-astro-cid-qtokga5y]{max-width:720px}}
[data-astro-image]{width:100%;height:auto;object-fit:var(--fit);object-position:var(--pos);aspect-ratio:var(--w) / var(--h)}[data-astro-image=responsive]{max-width:calc(var(--w) * 1px);max-height:calc(var(--h) * 1px)}[data-astro-image=fixed]{width:calc(var(--w) * 1px);height:calc(var(--h) * 1px)}
</style></head> <body> <!-- Google Tag Manager (noscript) --> <noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-KM9SGJLK" height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript> <!-- End Google Tag Manager (noscript) --> <section class="side-content" data-astro-cid-75hifxor> <h1 data-astro-cid-75hifxor>æ™®é€šæ–‡çµ„ 2.0</h1> <nav data-astro-cid-75hifxor> <a href="/" data-astro-cid-75hifxor>é¦–é </a> <a href="/archive" data-astro-cid-75hifxor>å…¨æ–‡ç« æ­¸æª”</a> <a href="/tag" data-astro-cid-75hifxor>ä»¥æ¨™ç±¤æª¢è¦–</a> <a href="/rss.xml" data-astro-cid-75hifxor>RSS</a> </nav> </section> <section class="main-content" data-astro-cid-75hifxor>   <div class="post-container" data-astro-cid-qtokga5y> <h1 data-astro-cid-qtokga5y>é–±è®€ç­†è¨˜ï¼šThe Art of Unit Testing Chapter 6 Unit testing asynchronous code</h1> <div class="info" data-astro-cid-qtokga5y> <span data-astro-cid-qtokga5y>2024-01-14 18:26</span> <span data-astro-cid-qtokga5y><a class="tag" href="/tag/Testing" data-astro-cid-2iymvi75> Testing </a> </span> <ul class="toc-container" data-astro-cid-qtokga5y> <li class="toc-2" data-astro-cid-qtokga5y> <a href="#intro" data-astro-cid-qtokga5y>intro</a> </li><li class="toc-2" data-astro-cid-qtokga5y> <a href="#61-dealing-with-async-data-fetching" data-astro-cid-qtokga5y>6.1 Dealing with async data fetching</a> </li><li class="toc-2" data-astro-cid-qtokga5y> <a href="#62-making-our-code-unit-test-friendly" data-astro-cid-qtokga5y>6.2 Making our code unit-test friendly</a> </li><li class="toc-3" data-astro-cid-qtokga5y> <a href="#extracting-an-entry-point" data-astro-cid-qtokga5y>Extracting an entry point</a> </li><li class="toc-3" data-astro-cid-qtokga5y> <a href="#extract-adapter-pattern" data-astro-cid-qtokga5y>Extract adapter pattern</a> </li><li class="toc-4" data-astro-cid-qtokga5y> <a href="#module-solution" data-astro-cid-qtokga5y>module solution</a> </li><li class="toc-4" data-astro-cid-qtokga5y> <a href="#function-parameter-solution" data-astro-cid-qtokga5y>function parameter solution</a> </li><li class="toc-4" data-astro-cid-qtokga5y> <a href="#interface-based-solution" data-astro-cid-qtokga5y>interface based solution</a> </li><li class="toc-2" data-astro-cid-qtokga5y> <a href="#63-dealing-with-timers" data-astro-cid-qtokga5y>6.3 Dealing with timers</a> </li><li class="toc-3" data-astro-cid-qtokga5y> <a href="#monkey-patching" data-astro-cid-qtokga5y>Monkey patching</a> </li><li class="toc-3" data-astro-cid-qtokga5y> <a href="#faking-timer-with-jest" data-astro-cid-qtokga5y>Faking timer with Jest</a> </li><li class="toc-4" data-astro-cid-qtokga5y> <a href="#for-settimeout" data-astro-cid-qtokga5y>for setTimeout()</a> </li><li class="toc-4" data-astro-cid-qtokga5y> <a href="#for-setinterval" data-astro-cid-qtokga5y>for setInterval()</a> </li><li class="toc-2" data-astro-cid-qtokga5y> <a href="#64-dealing-with-common-events" data-astro-cid-qtokga5y>6.4 Dealing with common events</a> </li><li class="toc-3" data-astro-cid-qtokga5y> <a href="#dealing-with-event-emitters" data-astro-cid-qtokga5y>Dealing with event emitters</a> </li><li class="toc-3" data-astro-cid-qtokga5y> <a href="#dealing-with-click-events" data-astro-cid-qtokga5y>Dealing with click events</a> </li><li class="toc-2" data-astro-cid-qtokga5y> <a href="#åƒè€ƒæ–‡ä»¶" data-astro-cid-qtokga5y>åƒè€ƒæ–‡ä»¶</a> </li> </ul> </div> <h2 id="intro">intro</h2>
<p>é‚„è¨˜å¾—ä¾è³´ï¼ˆdependencyï¼‰çš„å®šç¾©å—ï¼Ÿæ‰€æœ‰ç„¡æ³•ã€å¾ˆé›£æ§åˆ¶çš„è¦ç´ éƒ½æ˜¯ä¾è³´ï¼Œæ‰€ä»¥éåŒæ­¥åŠŸèƒ½ï¼ˆasync functionï¼‰è‡ªç„¶ä¹Ÿæ˜¯ä¸€ç¨®ä¾è³´â€”â€”ç•¢ç«Ÿæˆ‘å€‘ç„¡æ³•æ§åˆ¶éåŒæ­¥åŠŸèƒ½çš„å®Œæˆæ™‚é–“ã€‚</p>
<p>æœ‰é‘’æ–¼æ­¤ä¸å¯æ§æ€§ï¼Œæœ¬ç« æä¾›å…©ç¨®å¯¦ä½œæŠ€å·§ä¾†è®“æˆ‘å€‘å¯«å‡ºè‰¯å¥½çš„å–®å…ƒæ¸¬è©¦ï¼š</p>
<ol>
<li>åˆ†é›¢é€²å…¥é»ï¼ˆextracting an entry pointï¼‰</li>
<li>æ¡ç”¨é…æ¥å™¨æ¨¡å¼ï¼ˆadapter patternï¼‰åˆ†é›¢éåŒæ­¥çš„éƒ¨åˆ†</li>
</ol>
<h2 id="61-dealing-with-async-data-fetching">6.1 Dealing with async data fetching</h2>
<p>éåŒæ­¥åŠŸèƒ½ç‚ºå–®å…ƒæ¸¬è©¦å¸¶ä¾†çš„å›°æ“¾æ˜¯â€”â€”ç”¢ç”Ÿçµæœæ‰€éœ€çš„æ™‚é–“ã€çµæœæ˜¯æˆåŠŸæˆ–å¤±æ•—â€”â€”é€™äº›éƒ½æ˜¯æˆ‘å€‘ç„¡æ³•æ§åˆ¶çš„éƒ¨åˆ†ã€‚ä»¥ä¸‹æ–¹çš„ <code>isWebsiteAlive</code> ç‚ºä¾‹ï¼š</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="js"><code><span class="line"><span style="color:#F97583">const</span><span style="color:#79B8FF"> fetch</span><span style="color:#F97583"> =</span><span style="color:#B392F0"> require</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">'node-fetch'</span><span style="color:#E1E4E8">);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">const</span><span style="color:#B392F0"> isWebsiteAlive</span><span style="color:#F97583"> =</span><span style="color:#F97583"> async</span><span style="color:#E1E4E8"> () </span><span style="color:#F97583">=></span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#F97583">  try</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#F97583">    const</span><span style="color:#79B8FF"> resp</span><span style="color:#F97583"> =</span><span style="color:#F97583"> await</span><span style="color:#B392F0"> fetch</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">'http://example.com'</span><span style="color:#E1E4E8">);</span></span>
<span class="line"><span style="color:#F97583">    if</span><span style="color:#E1E4E8"> (</span><span style="color:#F97583">!</span><span style="color:#E1E4E8">resp.ok) {</span></span>
<span class="line"><span style="color:#6A737D">      // exit point 1</span></span>
<span class="line"><span style="color:#F97583">      throw</span><span style="color:#E1E4E8"> resp.statusText;</span></span>
<span class="line"><span style="color:#E1E4E8">    }</span></span>
<span class="line"><span style="color:#F97583">    const</span><span style="color:#79B8FF"> text</span><span style="color:#F97583"> =</span><span style="color:#F97583"> await</span><span style="color:#E1E4E8"> resp.</span><span style="color:#B392F0">text</span><span style="color:#E1E4E8">();</span></span>
<span class="line"><span style="color:#F97583">    if</span><span style="color:#E1E4E8"> (text.</span><span style="color:#B392F0">includes</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">'illustrative'</span><span style="color:#E1E4E8">)) {</span></span>
<span class="line"><span style="color:#6A737D">      // exit point 2</span></span>
<span class="line"><span style="color:#F97583">      return</span><span style="color:#E1E4E8"> { success: </span><span style="color:#79B8FF">true</span><span style="color:#E1E4E8">, status: </span><span style="color:#9ECBFF">'ok'</span><span style="color:#E1E4E8"> };</span></span>
<span class="line"><span style="color:#E1E4E8">    }</span></span>
<span class="line"><span style="color:#6A737D">    // exit point 3</span></span>
<span class="line"><span style="color:#F97583">    throw</span><span style="color:#9ECBFF"> 'textÂ missing'</span><span style="color:#E1E4E8">;</span></span>
<span class="line"><span style="color:#E1E4E8">  } </span><span style="color:#F97583">catch</span><span style="color:#E1E4E8"> (err) {</span></span>
<span class="line"><span style="color:#6A737D">    // exit point 4</span></span>
<span class="line"><span style="color:#F97583">    return</span><span style="color:#E1E4E8"> { success: </span><span style="color:#79B8FF">false</span><span style="color:#E1E4E8">, status: err };</span></span>
<span class="line"><span style="color:#E1E4E8">  }</span></span>
<span class="line"><span style="color:#E1E4E8">};</span></span></code></pre>
<ol>
<li>æˆ‘å€‘ç„¡æ³•æ§åˆ¶ <code>await fetch("http://example.com")</code> ä½•æ™‚å›æ‡‰ï¼Œæ¸¬è©¦å¯èƒ½è®Šå¾—è€—æ™‚</li>
<li>æˆ‘å€‘ç„¡æ³•æ§åˆ¶ <code>http://example.com</code> é€™å€‹æœå‹™æ˜¯å¦åœ¨ç·šä¸Š ï¼ŒåŸ·è¡Œæ¸¬è©¦æ™‚ï¼Œæˆ‘å€‘ç„¡æ³•æ§åˆ¶è¦é€²å…¥å“ªä¸€å€‹é€€å‡ºé»</li>
<li>æ‰¿ä¸Šï¼Œå› ç‚ºç„¡æ³•æ§åˆ¶ç¶²ç«™çš„ä¸Šç·šèˆ‡å¦ï¼Œç•¶æ¸¬è©¦äº®ç´…ç‡ˆæ™‚ï¼Œæˆ‘å€‘è¦æª¢æŸ¥åˆ°åº•æ˜¯ç¶²ç«™æ›æ‰ï¼Œé‚„æ˜¯æ¸¬è©¦å£æ‰â€”â€”å¤šä¾†å¹¾æ¬¡ä»¥å¾Œï¼Œæˆ‘å€‘å°±ä¸å†ä¿¡è³´é€™å€‹æ¸¬è©¦ï¼Œä¹Ÿä¸æœƒä¿¡ä»»åŸ·è¡Œçµæœäº†</li>
</ol>
<p>ç¶œä¸Šæ‰€è¿°ï¼Œç‚ºäº†èƒ½å¯«å‡ºç©©å›ºã€èƒ½å…¨å¿ƒä¿¡è³´çš„å–®å…ƒæ¸¬è©¦ï¼Œåœ¨å¯¦ä½œåŠŸèƒ½æ™‚è«‹é€éä»¥ä¸‹æŠ€å·§è£½é€ <strong>æ¥ç¸«</strong>ï¼ˆseamï¼Œå¯è¤‡ç¿’<a href="/2023/the-art-of-unit-testing-ch3-breaking-dependencies-with-stubs#332-dependencies-injections-and-control">ç¬¬ä¸‰ç« çš„ç­†è¨˜</a>ï¼‰ï¼š</p>
<ol>
<li>åˆ†é›¢é€²å…¥é»ï¼ˆextracting and entry pointï¼‰ï¼šæ„æ€æ˜¯æŠŠä¸€å€‹å–®å…ƒè£¡ã€Œç´”é‚è¼¯ã€çš„éƒ¨åˆ†ç¨ç«‹æˆä¸€å€‹åŠŸèƒ½ï¼Œä¸¦æŠŠé€™å€‹åŠŸèƒ½ç•¶æˆæ–°çš„é€²å…¥é»ï¼Œå°å…¶åŸ·è¡Œå–®å…ƒæ¸¬è©¦</li>
<li>æ¡ç”¨é…æ¥å™¨æ¨¡å¼ï¼ˆadapter patterï¼‰ï¼šå·¥ç¨‹å¸«åªè¦éµå®ˆå®šç¾©å¥½çš„ä»‹é¢ï¼Œå°±èƒ½æ›¿æ›æ‰éåŒæ­¥çš„éƒ¨åˆ†</li>
</ol>
<h2 id="62-making-our-code-unit-test-friendly">6.2 Making our code unit-test friendly</h2>
<h3 id="extracting-an-entry-point">Extracting an entry point</h3>
<p>æˆ‘å€‘å¯ä»¥å°‡ <code>isWebsiteAlive</code> è£¡ï¼Œåªé€²è¡Œé‚è¼¯åˆ¤æ–·ï¼ˆç´”ï¼‰çš„éƒ¨ä»½æŠ½å‡ºï¼ˆ<code>throwIfResponseNotOK</code> / <code>processFetchContent</code> / <code>processFetchError</code>ï¼‰ï¼š</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="js"><code><span class="line"><span style="color:#F97583">const</span><span style="color:#79B8FF"> fetch</span><span style="color:#F97583"> =</span><span style="color:#B392F0"> require</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">'node-fetch'</span><span style="color:#E1E4E8">);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">const</span><span style="color:#B392F0"> throwIfResponseNotOK</span><span style="color:#F97583"> =</span><span style="color:#E1E4E8"> (</span><span style="color:#FFAB70">resp</span><span style="color:#E1E4E8">) </span><span style="color:#F97583">=></span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#F97583">  if</span><span style="color:#E1E4E8"> (</span><span style="color:#F97583">!</span><span style="color:#E1E4E8">resp.ok) {</span></span>
<span class="line"><span style="color:#F97583">    throw</span><span style="color:#E1E4E8"> resp.statusText;</span></span>
<span class="line"><span style="color:#E1E4E8">  }</span></span>
<span class="line"><span style="color:#E1E4E8">};</span></span>
<span class="line"><span style="color:#F97583">const</span><span style="color:#B392F0"> processFetchContent</span><span style="color:#F97583"> =</span><span style="color:#E1E4E8"> (</span><span style="color:#FFAB70">text</span><span style="color:#E1E4E8">) </span><span style="color:#F97583">=></span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#F97583">  const</span><span style="color:#79B8FF"> included</span><span style="color:#F97583"> =</span><span style="color:#E1E4E8"> text.</span><span style="color:#B392F0">includes</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">'illustrative'</span><span style="color:#E1E4E8">);</span></span>
<span class="line"><span style="color:#F97583">  if</span><span style="color:#E1E4E8"> (included) {</span></span>
<span class="line"><span style="color:#F97583">    return</span><span style="color:#E1E4E8"> { success: </span><span style="color:#79B8FF">true</span><span style="color:#E1E4E8">, status: </span><span style="color:#9ECBFF">'ok'</span><span style="color:#E1E4E8"> };</span></span>
<span class="line"><span style="color:#E1E4E8">  }</span></span>
<span class="line"><span style="color:#F97583">  return</span><span style="color:#E1E4E8"> { success: </span><span style="color:#79B8FF">false</span><span style="color:#E1E4E8">, status: </span><span style="color:#9ECBFF">'missingÂ text'</span><span style="color:#E1E4E8"> };</span></span>
<span class="line"><span style="color:#E1E4E8">};</span></span>
<span class="line"><span style="color:#F97583">const</span><span style="color:#B392F0"> processFetchError</span><span style="color:#F97583"> =</span><span style="color:#E1E4E8"> (</span><span style="color:#FFAB70">err</span><span style="color:#E1E4E8">) </span><span style="color:#F97583">=></span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#F97583">  return</span><span style="color:#E1E4E8"> { success: </span><span style="color:#79B8FF">false</span><span style="color:#E1E4E8">, status: err };</span></span>
<span class="line"><span style="color:#E1E4E8">};</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D">//Â AwaitÂ version</span></span>
<span class="line"><span style="color:#F97583">const</span><span style="color:#B392F0"> isWebsiteAlive</span><span style="color:#F97583"> =</span><span style="color:#F97583"> async</span><span style="color:#E1E4E8"> () </span><span style="color:#F97583">=></span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#F97583">  try</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#F97583">    const</span><span style="color:#79B8FF"> resp</span><span style="color:#F97583"> =</span><span style="color:#F97583"> await</span><span style="color:#B392F0"> fetch</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">'http://example.com'</span><span style="color:#E1E4E8">);</span></span>
<span class="line"><span style="color:#6A737D">    // exit point 1</span></span>
<span class="line"><span style="color:#B392F0">    throwIfResponseNotOK</span><span style="color:#E1E4E8">(resp);</span></span>
<span class="line"><span style="color:#F97583">    const</span><span style="color:#79B8FF"> text</span><span style="color:#F97583"> =</span><span style="color:#F97583"> await</span><span style="color:#E1E4E8"> resp.</span><span style="color:#B392F0">text</span><span style="color:#E1E4E8">();</span></span>
<span class="line"><span style="color:#6A737D">    // exit point 2</span></span>
<span class="line"><span style="color:#F97583">    return</span><span style="color:#B392F0"> processFetchContent</span><span style="color:#E1E4E8">(text);</span></span>
<span class="line"><span style="color:#E1E4E8">  } </span><span style="color:#F97583">catch</span><span style="color:#E1E4E8"> (err) {</span></span>
<span class="line"><span style="color:#6A737D">    // exit point 3</span></span>
<span class="line"><span style="color:#F97583">    return</span><span style="color:#B392F0"> processFetchError</span><span style="color:#E1E4E8">(err);</span></span>
<span class="line"><span style="color:#E1E4E8">  }</span></span>
<span class="line"><span style="color:#E1E4E8">};</span></span></code></pre>
<p>é›–ç„¶æˆ‘å€‘ä¾èˆŠç„¡æ³•æ§åˆ¶ <code>const resp = await fetch("http://example.com");</code> çš„çµæœï¼Œä½†èƒ½é€éå–®å…ƒæ¸¬è©¦ç¢ºä¿ã€Œé€™ä¸‰å€‹æ–°å–®å…ƒæœƒæ ¹æ“š <code>resp</code> å…§å®¹æ¡å–æ­£ç¢ºçš„è¡Œå‹•ã€ï¼š</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="js"><code><span class="line"><span style="color:#B392F0">describe</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">'throwIfResponseNotOK'</span><span style="color:#E1E4E8">, () </span><span style="color:#F97583">=></span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#B392F0">  it</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">'should not throw an error if response is ok'</span><span style="color:#E1E4E8">, () </span><span style="color:#F97583">=></span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#F97583">    const</span><span style="color:#79B8FF"> response</span><span style="color:#F97583"> =</span><span style="color:#E1E4E8"> { ok: </span><span style="color:#79B8FF">true</span><span style="color:#E1E4E8"> };</span></span>
<span class="line"><span style="color:#B392F0">    expect</span><span style="color:#E1E4E8">(() </span><span style="color:#F97583">=></span><span style="color:#B392F0"> throwIfResponseNotOK</span><span style="color:#E1E4E8">(response)).not.</span><span style="color:#B392F0">toThrow</span><span style="color:#E1E4E8">();</span></span>
<span class="line"><span style="color:#E1E4E8">  });</span></span>
<span class="line"><span style="color:#B392F0">  it</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">'should throw an error with response status text if response is not ok'</span><span style="color:#E1E4E8">, () </span><span style="color:#F97583">=></span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#F97583">    const</span><span style="color:#79B8FF"> response</span><span style="color:#F97583"> =</span><span style="color:#E1E4E8"> { ok: </span><span style="color:#79B8FF">false</span><span style="color:#E1E4E8">, statusText: </span><span style="color:#9ECBFF">'Not Found'</span><span style="color:#E1E4E8"> };</span></span>
<span class="line"><span style="color:#B392F0">    expect</span><span style="color:#E1E4E8">(() </span><span style="color:#F97583">=></span><span style="color:#B392F0"> throwIfResponseNotOK</span><span style="color:#E1E4E8">(response)).</span><span style="color:#B392F0">toThrowError</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">'Not Found'</span><span style="color:#E1E4E8">);</span></span>
<span class="line"><span style="color:#E1E4E8">  });</span></span>
<span class="line"><span style="color:#E1E4E8">});</span></span>
<span class="line"></span>
<span class="line"><span style="color:#B392F0">describe</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">'processFetchContent'</span><span style="color:#E1E4E8">, () </span><span style="color:#F97583">=></span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#B392F0">  it</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">"should return success true and status 'ok' when text includes 'illustrative'"</span><span style="color:#E1E4E8">, () </span><span style="color:#F97583">=></span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#F97583">    const</span><span style="color:#79B8FF"> text</span><span style="color:#F97583"> =</span><span style="color:#9ECBFF"> 'This is illustrative content'</span><span style="color:#E1E4E8">;</span></span>
<span class="line"><span style="color:#B392F0">    expect</span><span style="color:#E1E4E8">(</span><span style="color:#B392F0">processFetchContent</span><span style="color:#E1E4E8">(text)).</span><span style="color:#B392F0">toEqual</span><span style="color:#E1E4E8">({</span></span>
<span class="line"><span style="color:#6A737D">      //</span></span>
<span class="line"><span style="color:#E1E4E8">      success: </span><span style="color:#79B8FF">true</span><span style="color:#E1E4E8">,</span></span>
<span class="line"><span style="color:#E1E4E8">      status: </span><span style="color:#9ECBFF">'ok'</span><span style="color:#E1E4E8">,</span></span>
<span class="line"><span style="color:#E1E4E8">    });</span></span>
<span class="line"><span style="color:#E1E4E8">  });</span></span>
<span class="line"><span style="color:#B392F0">  it</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">"should return success false and status 'missing text' when text does not include 'illustrative'"</span><span style="color:#E1E4E8">, () </span><span style="color:#F97583">=></span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#F97583">    const</span><span style="color:#79B8FF"> text</span><span style="color:#F97583"> =</span><span style="color:#9ECBFF"> 'Some random content'</span><span style="color:#E1E4E8">;</span></span>
<span class="line"><span style="color:#B392F0">    expect</span><span style="color:#E1E4E8">(</span><span style="color:#B392F0">processFetchContent</span><span style="color:#E1E4E8">(text)).</span><span style="color:#B392F0">toEqual</span><span style="color:#E1E4E8">({</span></span>
<span class="line"><span style="color:#6A737D">      //</span></span>
<span class="line"><span style="color:#E1E4E8">      success: </span><span style="color:#79B8FF">false</span><span style="color:#E1E4E8">,</span></span>
<span class="line"><span style="color:#E1E4E8">      status: </span><span style="color:#9ECBFF">'missing text'</span><span style="color:#E1E4E8">,</span></span>
<span class="line"><span style="color:#E1E4E8">    });</span></span>
<span class="line"><span style="color:#E1E4E8">  });</span></span>
<span class="line"><span style="color:#E1E4E8">});</span></span>
<span class="line"></span>
<span class="line"><span style="color:#B392F0">describe</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">'processFetchError'</span><span style="color:#E1E4E8">, () </span><span style="color:#F97583">=></span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#B392F0">  test</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">'should return an object with success false and provided error message'</span><span style="color:#E1E4E8">, () </span><span style="color:#F97583">=></span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#F97583">    const</span><span style="color:#79B8FF"> errorMessage</span><span style="color:#F97583"> =</span><span style="color:#9ECBFF"> 'Failed to fetch'</span><span style="color:#E1E4E8">;</span></span>
<span class="line"><span style="color:#B392F0">    expect</span><span style="color:#E1E4E8">(</span><span style="color:#B392F0">processFetchError</span><span style="color:#E1E4E8">(errorMessage)).</span><span style="color:#B392F0">toEqual</span><span style="color:#E1E4E8">({</span></span>
<span class="line"><span style="color:#E1E4E8">      success: </span><span style="color:#79B8FF">false</span><span style="color:#E1E4E8">,</span></span>
<span class="line"><span style="color:#E1E4E8">      status: </span><span style="color:#9ECBFF">'Failed to fetch'</span><span style="color:#E1E4E8">,</span></span>
<span class="line"><span style="color:#E1E4E8">    });</span></span>
<span class="line"><span style="color:#E1E4E8">  });</span></span>
<span class="line"><span style="color:#E1E4E8">});</span></span></code></pre>
<p>ä»¥ä¸Šå°±æ˜¯ç”¨ã€Œåˆ†é›¢é€²å…¥é»ã€çš„æ¦‚å¿µé‡æ§‹ <code>isWebsiteAlive</code>ï¼Œä»¥ä¾¿æå‡æ¸¬è©¦è¦†è“‹ç‡çš„æ–¹æ³•ã€‚</p>
<h3 id="extract-adapter-pattern">Extract adapter pattern</h3>
<p>é…æ¥å™¨æ¨¡å¼èªªç™½äº†ï¼Œå°±æ˜¯æŠŠã€Œå‘¼å«éåŒæ­¥åŠŸèƒ½çš„ä»‹é¢ã€èˆ‡ã€ŒåŠŸèƒ½çš„å¯¦ä½œæ–¹å¼ã€åˆ†é–‹ä¾†ã€‚é€™ç¨®è¨­è¨ˆçš„å¥½è™•æ˜¯ï¼Œæˆ‘å€‘èƒ½åœ¨æ¸¬è©¦æ™‚ä½¿ç”¨åŒæ­¥ï¼ˆsynchronousï¼‰çš„å‡æ¨¡çµ„ã€å‡åŠŸèƒ½ã€å‡å¯¦ä¾‹ã€‚</p>
<h4 id="module-solution">module solution</h4>
<p>ç¬¬ä¸€ç¨®ä½œæ³•ï¼šä»¥æ¨¡çµ„ä½œç‚ºä»‹é¢ï¼ŒæŠŠéåŒæ­¥åŠŸèƒ½ç¨ç«‹åˆ°å¦ä¸€åŒ…æª”æ¡ˆä¸­ã€‚</p>
<p>æ¯”å¦‚æŠŠ <code>isWebsiteAlive</code> ä¸­çš„ <code>await fetch</code> æ‹†é€² <code>network.js</code> ä¸­ï¼Œè®Šæˆä¸€å€‹ç¨ç«‹çš„åŠŸèƒ½ <code>fetchUrlText</code>ã€‚å‰©ä¸‹çš„å°±ç•™åœ¨ <code>index.js</code> è£¡ï¼š</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="js"><code><span class="line"><span style="color:#6A737D">// network.js</span></span>
<span class="line"><span style="color:#F97583">const</span><span style="color:#B392F0"> fetchUrlText</span><span style="color:#F97583"> =</span><span style="color:#F97583"> async</span><span style="color:#E1E4E8"> (</span><span style="color:#FFAB70">url</span><span style="color:#E1E4E8">) </span><span style="color:#F97583">=></span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#F97583">  const</span><span style="color:#79B8FF"> resp</span><span style="color:#F97583"> =</span><span style="color:#F97583"> await</span><span style="color:#B392F0"> fetch</span><span style="color:#E1E4E8">(url);</span></span>
<span class="line"><span style="color:#F97583">  if</span><span style="color:#E1E4E8"> (resp.ok) {</span></span>
<span class="line"><span style="color:#F97583">    const</span><span style="color:#79B8FF"> text</span><span style="color:#F97583"> =</span><span style="color:#F97583"> await</span><span style="color:#E1E4E8"> resp.</span><span style="color:#B392F0">text</span><span style="color:#E1E4E8">();</span></span>
<span class="line"><span style="color:#F97583">    return</span><span style="color:#E1E4E8"> { ok: </span><span style="color:#79B8FF">true</span><span style="color:#E1E4E8">, text: text };</span></span>
<span class="line"><span style="color:#E1E4E8">  }</span></span>
<span class="line"><span style="color:#F97583">  return</span><span style="color:#E1E4E8"> { ok: </span><span style="color:#79B8FF">false</span><span style="color:#E1E4E8">, text: resp.statusText };</span></span>
<span class="line"><span style="color:#E1E4E8">};</span></span></code></pre>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="js"><code><span class="line"><span style="color:#6A737D">// index.js</span></span>
<span class="line"><span style="color:#F97583">const</span><span style="color:#E1E4E8"> { </span><span style="color:#79B8FF">fetchUrlText</span><span style="color:#E1E4E8"> } </span><span style="color:#F97583">=</span><span style="color:#B392F0"> require</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">'./network'</span><span style="color:#E1E4E8">);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">const</span><span style="color:#B392F0"> processFetchSuccess</span><span style="color:#F97583"> =</span><span style="color:#E1E4E8"> (</span><span style="color:#FFAB70">text</span><span style="color:#E1E4E8">) </span><span style="color:#F97583">=></span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#F97583">  const</span><span style="color:#79B8FF"> included</span><span style="color:#F97583"> =</span><span style="color:#E1E4E8"> text.</span><span style="color:#B392F0">includes</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">'illustrative'</span><span style="color:#E1E4E8">);</span></span>
<span class="line"><span style="color:#F97583">  if</span><span style="color:#E1E4E8"> (included) {</span></span>
<span class="line"><span style="color:#F97583">    return</span><span style="color:#E1E4E8"> { success: </span><span style="color:#79B8FF">true</span><span style="color:#E1E4E8">, status: </span><span style="color:#9ECBFF">'ok'</span><span style="color:#E1E4E8"> };</span></span>
<span class="line"><span style="color:#E1E4E8">  }</span></span>
<span class="line"><span style="color:#F97583">  return</span><span style="color:#E1E4E8"> { success: </span><span style="color:#79B8FF">false</span><span style="color:#E1E4E8">, status: </span><span style="color:#9ECBFF">'missing text'</span><span style="color:#E1E4E8"> };</span></span>
<span class="line"><span style="color:#E1E4E8">};</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">const</span><span style="color:#B392F0"> processFetchFail</span><span style="color:#F97583"> =</span><span style="color:#E1E4E8"> (</span><span style="color:#FFAB70">err</span><span style="color:#E1E4E8">) </span><span style="color:#F97583">=></span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#F97583">  return</span><span style="color:#E1E4E8"> { success: </span><span style="color:#79B8FF">false</span><span style="color:#E1E4E8">, status: err };</span></span>
<span class="line"><span style="color:#E1E4E8">};</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">const</span><span style="color:#B392F0"> isWebsiteAlive</span><span style="color:#F97583"> =</span><span style="color:#F97583"> async</span><span style="color:#E1E4E8"> () </span><span style="color:#F97583">=></span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#F97583">  try</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#F97583">    const</span><span style="color:#79B8FF"> result</span><span style="color:#F97583"> =</span><span style="color:#F97583"> await</span><span style="color:#B392F0"> fetchUrlText</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">'http://example.com'</span><span style="color:#E1E4E8">);</span></span>
<span class="line"><span style="color:#F97583">    if</span><span style="color:#E1E4E8"> (</span><span style="color:#F97583">!</span><span style="color:#E1E4E8">result.ok) {</span></span>
<span class="line"><span style="color:#F97583">      return</span><span style="color:#B392F0"> processFetchFail</span><span style="color:#E1E4E8">(result.text);</span></span>
<span class="line"><span style="color:#E1E4E8">    }</span></span>
<span class="line"><span style="color:#F97583">    const</span><span style="color:#79B8FF"> text</span><span style="color:#F97583"> =</span><span style="color:#E1E4E8"> result.text;</span></span>
<span class="line"><span style="color:#F97583">    return</span><span style="color:#B392F0"> processFetchSuccess</span><span style="color:#E1E4E8">(text);</span></span>
<span class="line"><span style="color:#E1E4E8">  } </span><span style="color:#F97583">catch</span><span style="color:#E1E4E8"> (err) {</span></span>
<span class="line"><span style="color:#F97583">    throw</span><span style="color:#F97583"> new</span><span style="color:#B392F0"> Error</span><span style="color:#E1E4E8">(err);</span></span>
<span class="line"><span style="color:#E1E4E8">  }</span></span>
<span class="line"><span style="color:#E1E4E8">};</span></span></code></pre>
<p>åœ¨æ¸¬è©¦ <code>isWebsiteAlive</code> æ™‚ï¼Œæˆ‘å€‘å°±èƒ½é€é <code>jest.mock()</code> èˆ‡ <code>.mockResolvedValue()</code> æ§åˆ¶éåŒæ­¥åŠŸèƒ½ <code>fetchUrlText()</code> å›å‚³çš„å€¼ï¼Œé€²è€Œæ±ºå®šæˆ‘å€‘åœ¨æ¯ä¸€å€‹å–®å…ƒæ¸¬è©¦ä¸­è¦é€šéå“ªä¸€å€‹é€€å‡ºé»ï¼š</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="js"><code><span class="line"><span style="color:#E1E4E8">jest.</span><span style="color:#B392F0">mock</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">'./network'</span><span style="color:#E1E4E8">);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">const</span><span style="color:#79B8FF"> stub</span><span style="color:#F97583"> =</span><span style="color:#B392F0"> require</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">'./network'</span><span style="color:#E1E4E8">);</span></span>
<span class="line"><span style="color:#F97583">const</span><span style="color:#E1E4E8"> { </span><span style="color:#79B8FF">isWebsiteAlive</span><span style="color:#E1E4E8"> } </span><span style="color:#F97583">=</span><span style="color:#B392F0"> require</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">'./index'</span><span style="color:#E1E4E8">);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#B392F0">describe</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">'isWebsiteAlive'</span><span style="color:#E1E4E8">, () </span><span style="color:#F97583">=></span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#B392F0">  beforeEach</span><span style="color:#E1E4E8">(() </span><span style="color:#F97583">=></span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#E1E4E8">    jest.</span><span style="color:#B392F0">clearAllMocks</span><span style="color:#E1E4E8">();</span></span>
<span class="line"><span style="color:#E1E4E8">  });</span></span>
<span class="line"><span style="color:#B392F0">  it</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">'should return success: true, status: ok when fetchUrlText returns ok and text include `illustrative`'</span><span style="color:#E1E4E8">, </span><span style="color:#F97583">async</span><span style="color:#E1E4E8"> () </span><span style="color:#F97583">=></span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#6A737D">    // arrange</span></span>
<span class="line"><span style="color:#E1E4E8">    stub.fetchUrlText.</span><span style="color:#B392F0">mockResolvedValue</span><span style="color:#E1E4E8">({</span></span>
<span class="line"><span style="color:#E1E4E8">      ok: </span><span style="color:#79B8FF">true</span><span style="color:#E1E4E8">,</span></span>
<span class="line"><span style="color:#E1E4E8">      text: </span><span style="color:#9ECBFF">'This is illustrative text'</span><span style="color:#E1E4E8">,</span></span>
<span class="line"><span style="color:#E1E4E8">    });</span></span>
<span class="line"><span style="color:#6A737D">    // act</span></span>
<span class="line"><span style="color:#F97583">    const</span><span style="color:#79B8FF"> result</span><span style="color:#F97583"> =</span><span style="color:#F97583"> await</span><span style="color:#B392F0"> isWebsiteAlive</span><span style="color:#E1E4E8">();</span></span>
<span class="line"><span style="color:#6A737D">    // assert</span></span>
<span class="line"><span style="color:#B392F0">    expect</span><span style="color:#E1E4E8">(result).</span><span style="color:#B392F0">toEqual</span><span style="color:#E1E4E8">({ success: </span><span style="color:#79B8FF">true</span><span style="color:#E1E4E8">, status: </span><span style="color:#9ECBFF">'ok'</span><span style="color:#E1E4E8"> });</span></span>
<span class="line"><span style="color:#E1E4E8">  });</span></span>
<span class="line"><span style="color:#B392F0">  it</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">'should return success: false, status: missing text when fetchUrlText returns ok but text not include `illustrative`'</span><span style="color:#E1E4E8">, </span><span style="color:#F97583">async</span><span style="color:#E1E4E8"> () </span><span style="color:#F97583">=></span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#6A737D">    // arrange</span></span>
<span class="line"><span style="color:#E1E4E8">    stub.fetchUrlText.</span><span style="color:#B392F0">mockResolvedValue</span><span style="color:#E1E4E8">({</span></span>
<span class="line"><span style="color:#E1E4E8">      ok: </span><span style="color:#79B8FF">true</span><span style="color:#E1E4E8">,</span></span>
<span class="line"><span style="color:#E1E4E8">      text: </span><span style="color:#9ECBFF">'Some random text'</span><span style="color:#E1E4E8">,</span></span>
<span class="line"><span style="color:#E1E4E8">    });</span></span>
<span class="line"><span style="color:#6A737D">    // act</span></span>
<span class="line"><span style="color:#F97583">    const</span><span style="color:#79B8FF"> result</span><span style="color:#F97583"> =</span><span style="color:#F97583"> await</span><span style="color:#B392F0"> isWebsiteAlive</span><span style="color:#E1E4E8">();</span></span>
<span class="line"><span style="color:#6A737D">    // assert</span></span>
<span class="line"><span style="color:#B392F0">    expect</span><span style="color:#E1E4E8">(result).</span><span style="color:#B392F0">toEqual</span><span style="color:#E1E4E8">({ success: </span><span style="color:#79B8FF">false</span><span style="color:#E1E4E8">, status: </span><span style="color:#9ECBFF">'missing text'</span><span style="color:#E1E4E8"> });</span></span>
<span class="line"><span style="color:#E1E4E8">  });</span></span>
<span class="line"><span style="color:#B392F0">  it</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">'should throw success: false and status with error text when fetchUrlText return ok: false'</span><span style="color:#E1E4E8">, </span><span style="color:#F97583">async</span><span style="color:#E1E4E8"> () </span><span style="color:#F97583">=></span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#6A737D">    // arrange</span></span>
<span class="line"><span style="color:#E1E4E8">    stub.fetchUrlText.</span><span style="color:#B392F0">mockResolvedValue</span><span style="color:#E1E4E8">({</span></span>
<span class="line"><span style="color:#E1E4E8">      ok: </span><span style="color:#79B8FF">false</span><span style="color:#E1E4E8">,</span></span>
<span class="line"><span style="color:#E1E4E8">      text: </span><span style="color:#9ECBFF">'Failed to fetch'</span><span style="color:#E1E4E8">,</span></span>
<span class="line"><span style="color:#E1E4E8">    });</span></span>
<span class="line"><span style="color:#6A737D">    // act</span></span>
<span class="line"><span style="color:#F97583">    const</span><span style="color:#79B8FF"> result</span><span style="color:#F97583"> =</span><span style="color:#F97583"> await</span><span style="color:#B392F0"> isWebsiteAlive</span><span style="color:#E1E4E8">();</span></span>
<span class="line"><span style="color:#6A737D">    // assert</span></span>
<span class="line"><span style="color:#B392F0">    expect</span><span style="color:#E1E4E8">(result).</span><span style="color:#B392F0">toEqual</span><span style="color:#E1E4E8">({ success: </span><span style="color:#79B8FF">false</span><span style="color:#E1E4E8">, status: </span><span style="color:#9ECBFF">'Failed to fetch'</span><span style="color:#E1E4E8"> });</span></span>
<span class="line"><span style="color:#E1E4E8">  });</span></span>
<span class="line"><span style="color:#E1E4E8">});</span></span></code></pre>
<h4 id="function-parameter-solution">function parameter solution</h4>
<p>ç¬¬äºŒç¨®ä½œæ³•ï¼šä»¥åƒæ•¸ä½œç‚ºä»‹é¢ä¾†å‚³å…¥éåŒæ­¥åŠŸèƒ½â€”â€”é€™æ¨£åœ¨æ¸¬è©¦æ™‚ï¼Œæˆ‘å€‘å°±èƒ½é€éåƒæ•¸å‚³å…¥å‡çš„åŒæ­¥åŠŸèƒ½ã€‚</p>
<p>æ¯”å¦‚ä»¥ä¸‹é‡æ§‹å¾Œçš„ <code>isWebsiteAlive</code> å°±å…è¨±æˆ‘å€‘é€éåƒæ•¸æ³¨å…¥ <code>fetchUrlText()</code>ï¼š</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="js"><code><span class="line"><span style="color:#F97583">const</span><span style="color:#B392F0"> processFetchSuccess</span><span style="color:#F97583"> =</span><span style="color:#E1E4E8"> (</span><span style="color:#FFAB70">text</span><span style="color:#E1E4E8">) </span><span style="color:#F97583">=></span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#F97583">  const</span><span style="color:#79B8FF"> included</span><span style="color:#F97583"> =</span><span style="color:#E1E4E8"> text.</span><span style="color:#B392F0">includes</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">'illustrative'</span><span style="color:#E1E4E8">);</span></span>
<span class="line"><span style="color:#F97583">  if</span><span style="color:#E1E4E8"> (included) {</span></span>
<span class="line"><span style="color:#F97583">    return</span><span style="color:#E1E4E8"> { success: </span><span style="color:#79B8FF">true</span><span style="color:#E1E4E8">, status: </span><span style="color:#9ECBFF">'ok'</span><span style="color:#E1E4E8"> };</span></span>
<span class="line"><span style="color:#E1E4E8">  }</span></span>
<span class="line"><span style="color:#F97583">  return</span><span style="color:#E1E4E8"> { success: </span><span style="color:#79B8FF">false</span><span style="color:#E1E4E8">, status: </span><span style="color:#9ECBFF">'missing text'</span><span style="color:#E1E4E8"> };</span></span>
<span class="line"><span style="color:#E1E4E8">};</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">const</span><span style="color:#B392F0"> processFetchFail</span><span style="color:#F97583"> =</span><span style="color:#E1E4E8"> (</span><span style="color:#FFAB70">err</span><span style="color:#E1E4E8">) </span><span style="color:#F97583">=></span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#F97583">  return</span><span style="color:#E1E4E8"> { success: </span><span style="color:#79B8FF">false</span><span style="color:#E1E4E8">, status: err };</span></span>
<span class="line"><span style="color:#E1E4E8">};</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">const</span><span style="color:#B392F0"> isWebsiteAlive</span><span style="color:#F97583"> =</span><span style="color:#F97583"> async</span><span style="color:#E1E4E8"> (</span><span style="color:#FFAB70">fetchUrlText</span><span style="color:#E1E4E8">) </span><span style="color:#F97583">=></span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#F97583">  const</span><span style="color:#79B8FF"> result</span><span style="color:#F97583"> =</span><span style="color:#F97583"> await</span><span style="color:#B392F0"> fetchUrlText</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">'http://exa-mple.com'</span><span style="color:#E1E4E8">);</span></span>
<span class="line"><span style="color:#F97583">  if</span><span style="color:#E1E4E8"> (</span><span style="color:#F97583">!</span><span style="color:#E1E4E8">result.ok) {</span></span>
<span class="line"><span style="color:#F97583">    return</span><span style="color:#B392F0"> processFetchFail</span><span style="color:#E1E4E8">(result.text);</span></span>
<span class="line"><span style="color:#E1E4E8">  }</span></span>
<span class="line"><span style="color:#F97583">  const</span><span style="color:#79B8FF"> text</span><span style="color:#F97583"> =</span><span style="color:#E1E4E8"> result.text;</span></span>
<span class="line"><span style="color:#F97583">  return</span><span style="color:#B392F0"> processFetchSuccess</span><span style="color:#E1E4E8">(text);</span></span>
<span class="line"><span style="color:#E1E4E8">};</span></span></code></pre>
<p>åœ¨æ’°å¯«æ¸¬è©¦æ™‚ï¼Œå°±èƒ½é€éå·¥å» åŠŸèƒ½ <code>getStubResult()</code> æ§åˆ¶ç’°å¢ƒäº†ï¼š</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="js"><code><span class="line"><span style="color:#F97583">const</span><span style="color:#E1E4E8"> { </span><span style="color:#79B8FF">isWebsiteAlive</span><span style="color:#E1E4E8"> } </span><span style="color:#F97583">=</span><span style="color:#B392F0"> require</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">'./index'</span><span style="color:#E1E4E8">);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D">// arrange</span></span>
<span class="line"><span style="color:#F97583">const</span><span style="color:#B392F0"> getStubResult</span><span style="color:#F97583"> =</span><span style="color:#E1E4E8"> (</span><span style="color:#FFAB70">ok</span><span style="color:#E1E4E8">, </span><span style="color:#FFAB70">text</span><span style="color:#E1E4E8">) </span><span style="color:#F97583">=></span><span style="color:#E1E4E8"> () </span><span style="color:#F97583">=></span><span style="color:#E1E4E8"> ({</span></span>
<span class="line"><span style="color:#E1E4E8">  ok,</span></span>
<span class="line"><span style="color:#E1E4E8">  text,</span></span>
<span class="line"><span style="color:#E1E4E8">});</span></span>
<span class="line"></span>
<span class="line"><span style="color:#B392F0">describe</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">'isWebsiteAlive'</span><span style="color:#E1E4E8">, () </span><span style="color:#F97583">=></span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#B392F0">  it</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">'should return success: true, status: ok when fetchUrlText returns ok and text include `illustrative`'</span><span style="color:#E1E4E8">, </span><span style="color:#F97583">async</span><span style="color:#E1E4E8"> () </span><span style="color:#F97583">=></span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#6A737D">    // act</span></span>
<span class="line"><span style="color:#F97583">    const</span><span style="color:#79B8FF"> result</span><span style="color:#F97583"> =</span><span style="color:#F97583"> await</span><span style="color:#B392F0"> isWebsiteAlive</span><span style="color:#E1E4E8">(</span></span>
<span class="line"><span style="color:#B392F0">      getStubResult</span><span style="color:#E1E4E8">(</span><span style="color:#79B8FF">true</span><span style="color:#E1E4E8">, </span><span style="color:#9ECBFF">'This is illustrative text'</span><span style="color:#E1E4E8">)</span></span>
<span class="line"><span style="color:#E1E4E8">    );</span></span>
<span class="line"><span style="color:#6A737D">    // assert</span></span>
<span class="line"><span style="color:#B392F0">    expect</span><span style="color:#E1E4E8">(result).</span><span style="color:#B392F0">toEqual</span><span style="color:#E1E4E8">({ success: </span><span style="color:#79B8FF">true</span><span style="color:#E1E4E8">, status: </span><span style="color:#9ECBFF">'ok'</span><span style="color:#E1E4E8"> });</span></span>
<span class="line"><span style="color:#E1E4E8">  });</span></span>
<span class="line"><span style="color:#B392F0">  it</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">'should return success: false, status: missing text when fetchUrlText returns ok but text not include `illustrative`'</span><span style="color:#E1E4E8">, </span><span style="color:#F97583">async</span><span style="color:#E1E4E8"> () </span><span style="color:#F97583">=></span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#6A737D">    // act</span></span>
<span class="line"><span style="color:#F97583">    const</span><span style="color:#79B8FF"> result</span><span style="color:#F97583"> =</span><span style="color:#F97583"> await</span><span style="color:#B392F0"> isWebsiteAlive</span><span style="color:#E1E4E8">(</span></span>
<span class="line"><span style="color:#B392F0">      getStubResult</span><span style="color:#E1E4E8">(</span><span style="color:#79B8FF">true</span><span style="color:#E1E4E8">, </span><span style="color:#9ECBFF">'Some random text'</span><span style="color:#E1E4E8">)</span></span>
<span class="line"><span style="color:#E1E4E8">    );</span></span>
<span class="line"><span style="color:#6A737D">    // assert</span></span>
<span class="line"><span style="color:#B392F0">    expect</span><span style="color:#E1E4E8">(result).</span><span style="color:#B392F0">toEqual</span><span style="color:#E1E4E8">({ success: </span><span style="color:#79B8FF">false</span><span style="color:#E1E4E8">, status: </span><span style="color:#9ECBFF">'missing text'</span><span style="color:#E1E4E8"> });</span></span>
<span class="line"><span style="color:#E1E4E8">  });</span></span>
<span class="line"><span style="color:#B392F0">  it</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">'should throw success: false and status with error text when fetchUrlText return ok: false'</span><span style="color:#E1E4E8">, </span><span style="color:#F97583">async</span><span style="color:#E1E4E8"> () </span><span style="color:#F97583">=></span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#6A737D">    // act</span></span>
<span class="line"><span style="color:#F97583">    const</span><span style="color:#79B8FF"> result</span><span style="color:#F97583"> =</span><span style="color:#F97583"> await</span><span style="color:#B392F0"> isWebsiteAlive</span><span style="color:#E1E4E8">(</span></span>
<span class="line"><span style="color:#B392F0">      getStubResult</span><span style="color:#E1E4E8">(</span><span style="color:#79B8FF">false</span><span style="color:#E1E4E8">, </span><span style="color:#9ECBFF">'Failed to fetch'</span><span style="color:#E1E4E8">)</span></span>
<span class="line"><span style="color:#E1E4E8">    );</span></span>
<span class="line"><span style="color:#6A737D">    // assert</span></span>
<span class="line"><span style="color:#B392F0">    expect</span><span style="color:#E1E4E8">(result).</span><span style="color:#B392F0">toEqual</span><span style="color:#E1E4E8">({ success: </span><span style="color:#79B8FF">false</span><span style="color:#E1E4E8">, status: </span><span style="color:#9ECBFF">'Failed to fetch'</span><span style="color:#E1E4E8"> });</span></span>
<span class="line"><span style="color:#E1E4E8">  });</span></span>
<span class="line"><span style="color:#E1E4E8">});</span></span></code></pre>
<h4 id="interface-based-solution">interface based solution</h4>
<p>ç¬¬ä¸‰ç¨®ä½œæ³•ï¼šä»¥ç‰©ä»¶å°å‘é¢¨æ ¼é€²è¡Œé–‹ç™¼æ™‚ï¼Œå¯ä»¥é€éå®šç¾©ä»‹é¢ï¼ˆinterfaceï¼‰ä¾†åˆ†é›¢å¯¦ä½œç´°ç¯€â€”â€”ç•¶æˆ‘å€‘æƒ³ç‚ºè©²å–®å…ƒæ’°å¯«æ¸¬è©¦æ™‚ï¼Œåªè¦æ ¹æ“šä»‹é¢è¦å‰‡å¯¦ä½œå‡å¯¦ä¾‹å³å¯ã€‚</p>
<p>ä»¥ <code>WebsiteVerifier</code> ç‚ºä¾‹ï¼Œæˆ‘å€‘æœƒå®šç¾©ä»¥ä¸‹ä¸‰ç¨®ä»‹é¢ï¼š</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="ts"><code><span class="line"><span style="color:#F97583">export</span><span style="color:#F97583"> interface</span><span style="color:#B392F0"> FetchAdapter</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#B392F0">  fetchUrlText</span><span style="color:#E1E4E8">(</span><span style="color:#FFAB70">url</span><span style="color:#F97583">:</span><span style="color:#79B8FF"> string</span><span style="color:#E1E4E8">)</span><span style="color:#F97583">:</span><span style="color:#B392F0"> Promise</span><span style="color:#E1E4E8">&#x3C;</span><span style="color:#B392F0">FetchResult</span><span style="color:#E1E4E8">>;</span></span>
<span class="line"><span style="color:#E1E4E8">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">export</span><span style="color:#F97583"> type</span><span style="color:#B392F0"> FetchResult</span><span style="color:#F97583"> =</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#FFAB70">  ok</span><span style="color:#F97583">:</span><span style="color:#79B8FF"> boolean</span><span style="color:#E1E4E8">;</span></span>
<span class="line"><span style="color:#FFAB70">  text</span><span style="color:#F97583">:</span><span style="color:#79B8FF"> string</span><span style="color:#E1E4E8">;</span></span>
<span class="line"><span style="color:#E1E4E8">};</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">export</span><span style="color:#F97583"> type</span><span style="color:#B392F0"> WebsiteAliveResult</span><span style="color:#F97583"> =</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#FFAB70">  success</span><span style="color:#F97583">:</span><span style="color:#79B8FF"> boolean</span><span style="color:#E1E4E8">;</span></span>
<span class="line"><span style="color:#FFAB70">  status</span><span style="color:#F97583">:</span><span style="color:#79B8FF"> string</span><span style="color:#E1E4E8">;</span></span>
<span class="line"><span style="color:#E1E4E8">};</span></span></code></pre>
<p>åœ¨æ­£å¼ç’°å¢ƒè£¡ï¼Œæˆ‘å€‘æœƒæ ¹æ“š <code>FetchAdapter</code> å¯¦ä½œä¸€å€‹ã€ŒçœŸã€çš„ <code>NetworkAdapter</code> å¯¦ä¾‹ï¼Œä¸¦åœ¨å»ºæ§‹ <code>class WebsiteVerifier</code> æ™‚ï¼Œå‚³å…¥é€™å€‹ <code>NetworkAdapter</code> ä½œç‚ºåƒæ•¸ï¼š</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="ts"><code><span class="line"><span style="color:#F97583">import</span><span style="color:#F97583"> type</span><span style="color:#E1E4E8"> { FetchAdapter, FetchResult } </span><span style="color:#F97583">from</span><span style="color:#9ECBFF"> './types'</span><span style="color:#E1E4E8">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">export</span><span style="color:#F97583"> class</span><span style="color:#B392F0"> NetworkAdapter</span><span style="color:#F97583"> implements</span><span style="color:#B392F0"> FetchAdapter</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#F97583">  async</span><span style="color:#B392F0"> fetchUrlText</span><span style="color:#E1E4E8">(</span><span style="color:#FFAB70">url</span><span style="color:#F97583">:</span><span style="color:#79B8FF"> string</span><span style="color:#E1E4E8">)</span><span style="color:#F97583">:</span><span style="color:#B392F0"> Promise</span><span style="color:#E1E4E8">&#x3C;</span><span style="color:#B392F0">FetchResult</span><span style="color:#E1E4E8">> {</span></span>
<span class="line"><span style="color:#F97583">    const</span><span style="color:#79B8FF"> resp</span><span style="color:#F97583"> =</span><span style="color:#F97583"> await</span><span style="color:#B392F0"> fetch</span><span style="color:#E1E4E8">(url);</span></span>
<span class="line"><span style="color:#F97583">    if</span><span style="color:#E1E4E8"> (resp.ok) {</span></span>
<span class="line"><span style="color:#F97583">      const</span><span style="color:#79B8FF"> text</span><span style="color:#F97583"> =</span><span style="color:#F97583"> await</span><span style="color:#E1E4E8"> resp.</span><span style="color:#B392F0">text</span><span style="color:#E1E4E8">();</span></span>
<span class="line"><span style="color:#F97583">      return</span><span style="color:#E1E4E8"> { ok: </span><span style="color:#79B8FF">true</span><span style="color:#E1E4E8">, text: text };</span></span>
<span class="line"><span style="color:#E1E4E8">    }</span></span>
<span class="line"><span style="color:#F97583">    return</span><span style="color:#E1E4E8"> { ok: </span><span style="color:#79B8FF">false</span><span style="color:#E1E4E8">, text: resp.statusText };</span></span>
<span class="line"><span style="color:#E1E4E8">  }</span></span>
<span class="line"><span style="color:#E1E4E8">}</span></span></code></pre>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="ts"><code><span class="line"><span style="color:#F97583">import</span><span style="color:#F97583"> type</span><span style="color:#E1E4E8"> { FetchAdapter, WebsiteAliveResult } </span><span style="color:#F97583">from</span><span style="color:#9ECBFF"> './types'</span><span style="color:#E1E4E8">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">export</span><span style="color:#F97583"> class</span><span style="color:#B392F0"> WebsiteVerifier</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#FFAB70">  network</span><span style="color:#F97583">:</span><span style="color:#B392F0"> FetchAdapter</span><span style="color:#E1E4E8">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">  constructor</span><span style="color:#E1E4E8">(</span><span style="color:#FFAB70">network</span><span style="color:#F97583">:</span><span style="color:#B392F0"> FetchAdapter</span><span style="color:#E1E4E8">) {</span></span>
<span class="line"><span style="color:#79B8FF">    this</span><span style="color:#E1E4E8">.network </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> network;</span></span>
<span class="line"><span style="color:#E1E4E8">  }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#B392F0">  isWebsiteAlive</span><span style="color:#F97583"> =</span><span style="color:#F97583"> async</span><span style="color:#E1E4E8"> ()</span><span style="color:#F97583">:</span><span style="color:#B392F0"> Promise</span><span style="color:#E1E4E8">&#x3C;</span><span style="color:#B392F0">WebsiteAliveResult</span><span style="color:#E1E4E8">> </span><span style="color:#F97583">=></span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#F97583">    try</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#F97583">      const</span><span style="color:#79B8FF"> result</span><span style="color:#F97583"> =</span><span style="color:#F97583"> await</span><span style="color:#79B8FF"> this</span><span style="color:#E1E4E8">.network.</span><span style="color:#B392F0">fetchUrlText</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">'http://example.com'</span><span style="color:#E1E4E8">);</span></span>
<span class="line"><span style="color:#F97583">      return</span><span style="color:#E1E4E8"> result.ok</span></span>
<span class="line"><span style="color:#F97583">        ?</span><span style="color:#79B8FF"> this</span><span style="color:#E1E4E8">.</span><span style="color:#B392F0">processFetchSuccess</span><span style="color:#E1E4E8">(result.text)</span></span>
<span class="line"><span style="color:#F97583">        :</span><span style="color:#79B8FF"> this</span><span style="color:#E1E4E8">.</span><span style="color:#B392F0">processFetchFail</span><span style="color:#E1E4E8">(result.text);</span></span>
<span class="line"><span style="color:#E1E4E8">    } </span><span style="color:#F97583">catch</span><span style="color:#E1E4E8"> (</span><span style="color:#FFAB70">err</span><span style="color:#F97583">:</span><span style="color:#79B8FF"> any</span><span style="color:#E1E4E8">) {</span></span>
<span class="line"><span style="color:#F97583">      throw</span><span style="color:#F97583"> new</span><span style="color:#B392F0"> Error</span><span style="color:#E1E4E8">(err);</span></span>
<span class="line"><span style="color:#E1E4E8">    }</span></span>
<span class="line"><span style="color:#E1E4E8">  };</span></span>
<span class="line"></span>
<span class="line"><span style="color:#B392F0">  processFetchSuccess</span><span style="color:#F97583"> =</span><span style="color:#E1E4E8"> (</span><span style="color:#FFAB70">text</span><span style="color:#F97583">:</span><span style="color:#79B8FF"> string</span><span style="color:#E1E4E8">)</span><span style="color:#F97583">:</span><span style="color:#B392F0"> WebsiteAliveResult</span><span style="color:#F97583"> =></span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#F97583">    const</span><span style="color:#79B8FF"> included</span><span style="color:#F97583"> =</span><span style="color:#E1E4E8"> text.</span><span style="color:#B392F0">includes</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">'illustrative'</span><span style="color:#E1E4E8">);</span></span>
<span class="line"><span style="color:#F97583">    return</span><span style="color:#E1E4E8"> included</span></span>
<span class="line"><span style="color:#F97583">      ?</span><span style="color:#E1E4E8"> { success: </span><span style="color:#79B8FF">true</span><span style="color:#E1E4E8">, status: </span><span style="color:#9ECBFF">'ok'</span><span style="color:#E1E4E8"> }</span></span>
<span class="line"><span style="color:#F97583">      :</span><span style="color:#E1E4E8"> { success: </span><span style="color:#79B8FF">false</span><span style="color:#E1E4E8">, status: </span><span style="color:#9ECBFF">'missing text'</span><span style="color:#E1E4E8"> };</span></span>
<span class="line"><span style="color:#E1E4E8">  };</span></span>
<span class="line"></span>
<span class="line"><span style="color:#B392F0">  processFetchFail</span><span style="color:#F97583"> =</span><span style="color:#E1E4E8"> (</span><span style="color:#FFAB70">err</span><span style="color:#F97583">:</span><span style="color:#79B8FF"> any</span><span style="color:#E1E4E8">)</span><span style="color:#F97583">:</span><span style="color:#B392F0"> WebsiteAliveResult</span><span style="color:#F97583"> =></span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#F97583">    return</span><span style="color:#E1E4E8"> { success: </span><span style="color:#79B8FF">false</span><span style="color:#E1E4E8">, status: err };</span></span>
<span class="line"><span style="color:#E1E4E8">  };</span></span>
<span class="line"><span style="color:#E1E4E8">}</span></span></code></pre>
<p>ä½†æ˜¯â€”â€”åœ¨ç‚º <code>class WebsiteVerifier</code> å¯«æ¸¬è©¦æ™‚ï¼Œæˆ‘å€‘å¤§å¯ç›´æ¥æ ¹æ“š <code>interface FetchAdapter</code> å¯¦ä½œä¸€å€‹æ¸¬è©¦å°ˆç”¨çš„ <code>StubNetworkAdapter</code> ä¾†æ§åˆ¶ <code>fetchUrlText()</code> çš„å›å‚³çµæœï¼Œé€²è€Œç‚ºæ‰€æœ‰çš„æƒ…å¢ƒæ’°å¯«å°æ‡‰æ¸¬è©¦ï¼š</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="ts"><code><span class="line"><span style="color:#F97583">import</span><span style="color:#F97583"> type</span><span style="color:#E1E4E8"> { FetchAdapter, FetchResult } </span><span style="color:#F97583">from</span><span style="color:#9ECBFF"> './types'</span><span style="color:#E1E4E8">;</span></span>
<span class="line"><span style="color:#F97583">import</span><span style="color:#E1E4E8"> { describe, it, expect } </span><span style="color:#F97583">from</span><span style="color:#9ECBFF"> '@jest/globals'</span><span style="color:#E1E4E8">;</span></span>
<span class="line"><span style="color:#F97583">import</span><span style="color:#E1E4E8"> { WebsiteVerifier } </span><span style="color:#F97583">from</span><span style="color:#9ECBFF"> './index'</span><span style="color:#E1E4E8">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">class</span><span style="color:#B392F0"> StubNetworkAdapter</span><span style="color:#F97583"> implements</span><span style="color:#B392F0"> FetchAdapter</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#FFAB70">  ok</span><span style="color:#F97583">:</span><span style="color:#79B8FF"> boolean</span><span style="color:#E1E4E8">;</span></span>
<span class="line"><span style="color:#FFAB70">  text</span><span style="color:#F97583">:</span><span style="color:#79B8FF"> string</span><span style="color:#E1E4E8">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">  constructor</span><span style="color:#E1E4E8">(</span><span style="color:#FFAB70">ok</span><span style="color:#F97583">:</span><span style="color:#79B8FF"> boolean</span><span style="color:#E1E4E8">, </span><span style="color:#FFAB70">text</span><span style="color:#F97583">:</span><span style="color:#79B8FF"> string</span><span style="color:#E1E4E8">) {</span></span>
<span class="line"><span style="color:#79B8FF">    this</span><span style="color:#E1E4E8">.ok </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> ok;</span></span>
<span class="line"><span style="color:#79B8FF">    this</span><span style="color:#E1E4E8">.text </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> text;</span></span>
<span class="line"><span style="color:#E1E4E8">  }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#B392F0">  fetchUrlText</span><span style="color:#E1E4E8">()</span><span style="color:#F97583">:</span><span style="color:#B392F0"> Promise</span><span style="color:#E1E4E8">&#x3C;</span><span style="color:#B392F0">FetchResult</span><span style="color:#E1E4E8">> {</span></span>
<span class="line"><span style="color:#F97583">    return</span><span style="color:#79B8FF"> this</span><span style="color:#E1E4E8">.ok</span></span>
<span class="line"><span style="color:#F97583">      ?</span><span style="color:#79B8FF"> Promise</span><span style="color:#E1E4E8">.</span><span style="color:#B392F0">resolve</span><span style="color:#E1E4E8">({ ok: </span><span style="color:#79B8FF">this</span><span style="color:#E1E4E8">.ok, text: </span><span style="color:#79B8FF">this</span><span style="color:#E1E4E8">.text })</span></span>
<span class="line"><span style="color:#F97583">      :</span><span style="color:#79B8FF"> Promise</span><span style="color:#E1E4E8">.</span><span style="color:#B392F0">reject</span><span style="color:#E1E4E8">(</span><span style="color:#F97583">new</span><span style="color:#B392F0"> Error</span><span style="color:#E1E4E8">(</span><span style="color:#79B8FF">this</span><span style="color:#E1E4E8">.text));</span></span>
<span class="line"><span style="color:#E1E4E8">  }</span></span>
<span class="line"><span style="color:#E1E4E8">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">const</span><span style="color:#B392F0"> getVerifierWithStubAdapter</span><span style="color:#F97583"> =</span><span style="color:#E1E4E8"> (</span></span>
<span class="line"><span style="color:#FFAB70">  ok</span><span style="color:#F97583">:</span><span style="color:#79B8FF"> boolean</span><span style="color:#E1E4E8">,</span></span>
<span class="line"><span style="color:#FFAB70">  text</span><span style="color:#F97583">:</span><span style="color:#79B8FF"> string</span></span>
<span class="line"><span style="color:#E1E4E8">)</span><span style="color:#F97583">:</span><span style="color:#B392F0"> WebsiteVerifier</span><span style="color:#F97583"> =></span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#F97583">  const</span><span style="color:#79B8FF"> stubAdapter</span><span style="color:#F97583"> =</span><span style="color:#F97583"> new</span><span style="color:#B392F0"> StubNetworkAdapter</span><span style="color:#E1E4E8">(ok, text);</span></span>
<span class="line"><span style="color:#F97583">  return</span><span style="color:#F97583"> new</span><span style="color:#B392F0"> WebsiteVerifier</span><span style="color:#E1E4E8">(stubAdapter);</span></span>
<span class="line"><span style="color:#E1E4E8">};</span></span>
<span class="line"></span>
<span class="line"><span style="color:#B392F0">describe</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">'WebsiteVerifier'</span><span style="color:#E1E4E8">, () </span><span style="color:#F97583">=></span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#B392F0">  it</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">'should return success: true, status: ok when fetchUrlText returns ok and text include `illustrative`'</span><span style="color:#E1E4E8">, </span><span style="color:#F97583">async</span><span style="color:#E1E4E8"> () </span><span style="color:#F97583">=></span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#6A737D">    // arrange</span></span>
<span class="line"><span style="color:#F97583">    const</span><span style="color:#79B8FF"> verifier</span><span style="color:#F97583"> =</span><span style="color:#B392F0"> getVerifierWithStubAdapter</span><span style="color:#E1E4E8">(</span></span>
<span class="line"><span style="color:#79B8FF">      true</span><span style="color:#E1E4E8">,</span></span>
<span class="line"><span style="color:#9ECBFF">      'This is illustrative text'</span></span>
<span class="line"><span style="color:#E1E4E8">    );</span></span>
<span class="line"><span style="color:#6A737D">    // act</span></span>
<span class="line"><span style="color:#F97583">    const</span><span style="color:#79B8FF"> result</span><span style="color:#F97583"> =</span><span style="color:#F97583"> await</span><span style="color:#E1E4E8"> verifier.</span><span style="color:#B392F0">isWebsiteAlive</span><span style="color:#E1E4E8">();</span></span>
<span class="line"><span style="color:#6A737D">    // assert</span></span>
<span class="line"><span style="color:#B392F0">    expect</span><span style="color:#E1E4E8">(result).</span><span style="color:#B392F0">toEqual</span><span style="color:#E1E4E8">({ success: </span><span style="color:#79B8FF">true</span><span style="color:#E1E4E8">, status: </span><span style="color:#9ECBFF">'ok'</span><span style="color:#E1E4E8"> });</span></span>
<span class="line"><span style="color:#E1E4E8">  });</span></span>
<span class="line"><span style="color:#B392F0">  it</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">'should return success: false, status: missing text when fetchUrlText returns ok but text not include `illustrative`'</span><span style="color:#E1E4E8">, </span><span style="color:#F97583">async</span><span style="color:#E1E4E8"> () </span><span style="color:#F97583">=></span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#6A737D">    // arrange</span></span>
<span class="line"><span style="color:#F97583">    const</span><span style="color:#79B8FF"> verifier</span><span style="color:#F97583"> =</span><span style="color:#B392F0"> getVerifierWithStubAdapter</span><span style="color:#E1E4E8">(</span><span style="color:#79B8FF">true</span><span style="color:#E1E4E8">, </span><span style="color:#9ECBFF">'Some random text'</span><span style="color:#E1E4E8">);</span></span>
<span class="line"><span style="color:#6A737D">    // act</span></span>
<span class="line"><span style="color:#F97583">    const</span><span style="color:#79B8FF"> result</span><span style="color:#F97583"> =</span><span style="color:#F97583"> await</span><span style="color:#E1E4E8"> verifier.</span><span style="color:#B392F0">isWebsiteAlive</span><span style="color:#E1E4E8">();</span></span>
<span class="line"><span style="color:#6A737D">    // assert</span></span>
<span class="line"><span style="color:#B392F0">    expect</span><span style="color:#E1E4E8">(result).</span><span style="color:#B392F0">toEqual</span><span style="color:#E1E4E8">({ success: </span><span style="color:#79B8FF">false</span><span style="color:#E1E4E8">, status: </span><span style="color:#9ECBFF">'missing text'</span><span style="color:#E1E4E8"> });</span></span>
<span class="line"><span style="color:#E1E4E8">  });</span></span>
<span class="line"><span style="color:#B392F0">  it</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">'should throw success: false and status with error text when fetchUrlText return ok: false'</span><span style="color:#E1E4E8">, </span><span style="color:#F97583">async</span><span style="color:#E1E4E8"> () </span><span style="color:#F97583">=></span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#6A737D">    // arrange</span></span>
<span class="line"><span style="color:#F97583">    const</span><span style="color:#79B8FF"> verifier</span><span style="color:#F97583"> =</span><span style="color:#B392F0"> getVerifierWithStubAdapter</span><span style="color:#E1E4E8">(</span><span style="color:#79B8FF">false</span><span style="color:#E1E4E8">, </span><span style="color:#9ECBFF">'Failed to fetch'</span><span style="color:#E1E4E8">);</span></span>
<span class="line"><span style="color:#F97583">    try</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#6A737D">      // act</span></span>
<span class="line"><span style="color:#F97583">      await</span><span style="color:#E1E4E8"> verifier.</span><span style="color:#B392F0">isWebsiteAlive</span><span style="color:#E1E4E8">();</span></span>
<span class="line"><span style="color:#E1E4E8">    } </span><span style="color:#F97583">catch</span><span style="color:#E1E4E8"> (</span><span style="color:#FFAB70">e</span><span style="color:#F97583">:</span><span style="color:#79B8FF"> any</span><span style="color:#E1E4E8">) {</span></span>
<span class="line"><span style="color:#6A737D">      // assert</span></span>
<span class="line"><span style="color:#B392F0">      expect</span><span style="color:#E1E4E8">(e.message).</span><span style="color:#B392F0">toMatch</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">/</span><span style="color:#DBEDFF">Failed to fetch</span><span style="color:#9ECBFF">/</span><span style="color:#E1E4E8">);</span></span>
<span class="line"><span style="color:#E1E4E8">    }</span></span>
<span class="line"><span style="color:#E1E4E8">  });</span></span>
<span class="line"><span style="color:#E1E4E8">});</span></span></code></pre>
<p>æˆ‘å€‘ç”šè‡³ä¸éœ€è¦ jest çš„éš”é›¢ api å°±èƒ½æå®šæ‰€æœ‰é€€å‡ºé»çš„å–®å…ƒæ¸¬è©¦ ğŸ‘</p>
<h2 id="63-dealing-with-timers">6.3 Dealing with timers</h2>
<p>åœ¨çµ¦æœ‰è¨ˆæ™‚å™¨ï¼ˆtimerï¼‰çš„å–®å…ƒå¯«æ¸¬è©¦æ™‚ï¼Œå¯ä»¥è€ƒæ…®ä»¥çŒ´å­è£œä¸ï¼ˆmonkey patchï¼‰æˆ–ç›´æ¥å€Ÿç”¨ jest api ä¾†åŒ–è§£ <code>setTimeout()</code> / <code>setInterval()</code> çš„éåŒæ­¥ç‰¹å¾µã€‚</p>
<h3 id="monkey-patching">Monkey patching</h3>
<p>çŒ´å­è£œä¸ï¼ˆmonkey patchï¼‰æŒ‡çš„æ˜¯å·¥ç¨‹å¸«èƒ½åœ¨åŸ·è¡Œä¸€æ®µç¨‹å¼æ™‚ï¼Œã€Œå‹•æ…‹åœ°ä¿®æ”¹å…¶åŠŸèƒ½ã€çš„è¡Œç‚ºã€‚æ­¤ä¿®æ”¹çš„å½±éŸ¿æ˜¯ä¸€æ™‚è€Œéæ°¸ä¹…ã€‚</p>
<blockquote>
<p>Monkey patching is a way for a program <strong>to extend or modify supporting system software locally</strong> (affecting only the running instance of the program).</p>
</blockquote>
<p>ç•¶æˆ‘å€‘åœ¨çµ¦å‘¼å«è¨ˆæ™‚å™¨çš„å–®å…ƒå¯«æ¸¬è©¦æ™‚ï¼Œå¯ä»¥é‹ç”¨çŒ´å­è£œä¸æŠ€å·§ä¾†æš«æ™‚ä¿®æ”¹ <code>setTimeout()</code> çš„è¡Œç‚ºï¼Œä¸¦ä¸”åœ¨æ¸¬è©¦çµæŸå¾Œå°‡å®ƒå›å¾©åŸç‹€ã€‚</p>
<p>æ¯”å¦‚ä»¥ä¸‹ç¯„ä¾‹ï¼Œæˆ‘å€‘åœ¨æ¸¬è©¦æ™‚æš«æ™‚ç§»é™¤äº† <code>setTimeout()</code> çš„éåŒæ­¥ç‰¹æ€§ï¼Œä¸¦åœ¨æ¸¬è©¦çµæŸå¾ŒåŸ·è¡Œå¾©åŸï¼š</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="js"><code><span class="line"><span style="color:#F97583">const</span><span style="color:#B392F0"> calculate1</span><span style="color:#F97583"> =</span><span style="color:#E1E4E8"> (</span><span style="color:#FFAB70">x</span><span style="color:#E1E4E8">, </span><span style="color:#FFAB70">y</span><span style="color:#E1E4E8">, </span><span style="color:#FFAB70">resultCallback</span><span style="color:#E1E4E8">) </span><span style="color:#F97583">=></span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#B392F0">  setTimeout</span><span style="color:#E1E4E8">(() </span><span style="color:#F97583">=></span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#B392F0">    resultCallback</span><span style="color:#E1E4E8">(x </span><span style="color:#F97583">+</span><span style="color:#E1E4E8"> y);</span></span>
<span class="line"><span style="color:#E1E4E8">  }, </span><span style="color:#79B8FF">1000</span><span style="color:#E1E4E8">);</span></span>
<span class="line"><span style="color:#E1E4E8">};</span></span>
<span class="line"></span>
<span class="line"><span style="color:#B392F0">describe</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">'calculate1'</span><span style="color:#E1E4E8">, () </span><span style="color:#F97583">=></span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#B392F0">  describe</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">'in monkey patching style'</span><span style="color:#E1E4E8">, () </span><span style="color:#F97583">=></span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#6A737D">    // arrange</span></span>
<span class="line"><span style="color:#F97583">    let</span><span style="color:#E1E4E8"> originalTimeOut;</span></span>
<span class="line"><span style="color:#B392F0">    beforeEach</span><span style="color:#E1E4E8">(() </span><span style="color:#F97583">=></span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#E1E4E8">      originalTimeOut </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> setTimeout;</span></span>
<span class="line"><span style="color:#B392F0">      setTimeout</span><span style="color:#F97583"> =</span><span style="color:#E1E4E8"> (</span><span style="color:#FFAB70">cb</span><span style="color:#E1E4E8">) </span><span style="color:#F97583">=></span><span style="color:#B392F0"> cb</span><span style="color:#E1E4E8">();</span></span>
<span class="line"><span style="color:#E1E4E8">    });</span></span>
<span class="line"><span style="color:#B392F0">    afterEach</span><span style="color:#E1E4E8">(() </span><span style="color:#F97583">=></span><span style="color:#E1E4E8"> (setTimeout </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> originalTimeOut));</span></span>
<span class="line"></span>
<span class="line"><span style="color:#B392F0">    it</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">'should return calculate result after 1 second'</span><span style="color:#E1E4E8">, () </span><span style="color:#F97583">=></span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#6A737D">      // act, assert</span></span>
<span class="line"><span style="color:#B392F0">      calculate1</span><span style="color:#E1E4E8">(</span><span style="color:#79B8FF">1</span><span style="color:#E1E4E8">, </span><span style="color:#79B8FF">2</span><span style="color:#E1E4E8">, (</span><span style="color:#FFAB70">result</span><span style="color:#E1E4E8">) </span><span style="color:#F97583">=></span><span style="color:#B392F0"> expect</span><span style="color:#E1E4E8">(result).</span><span style="color:#B392F0">toBe</span><span style="color:#E1E4E8">(</span><span style="color:#79B8FF">3</span><span style="color:#E1E4E8">));</span></span>
<span class="line"><span style="color:#E1E4E8">    });</span></span>
<span class="line"><span style="color:#E1E4E8">  });</span></span>
<span class="line"><span style="color:#E1E4E8">});</span></span></code></pre>
<h3 id="faking-timer-with-jest">Faking timer with Jest</h3>
<p>Jest æä¾›éš”é›¢ api <code>useFakeTimers()</code> / <code>useRealTimers()</code> ä¾†è®“å·¥ç¨‹å¸«æ±ºå®šè¦åœ¨æ¸¬è©¦æ™‚ä½¿ç”¨å‡æˆ–çœŸçš„è¨ˆæ™‚å™¨ã€‚å¦‚æœæˆ‘å€‘æƒ³è®“æ¸¬è©¦å„˜é€ŸåŸ·è¡Œå®Œç•¢ï¼Œå¯é¸æ“‡å‘¼å« <code>useFakeTimers()</code> è®“ Jest ä¾†è¦†è“‹è¨ˆæ™‚å™¨çš„é è¨­è¡Œç‚ºã€‚</p>
<h4 id="for-settimeout">for <code>setTimeout()</code></h4>
<p>ä»¥ä¸‹åˆ— snippet ç‚ºä¾‹ï¼Œæˆ‘å€‘è®“ Jest æ§åˆ¶è¨ˆæ™‚å™¨å¾Œï¼Œä¸éœ€è¦ã€ŒçœŸçš„ç­‰å¾…ä¸€ç§’éå»ã€æ‰èƒ½çœ‹åˆ°å–®å…ƒåŸ·è¡Œå®Œç•¢ã€‚æƒ³é©—è­‰ <code>setTimeout()</code> æ˜¯å¦æœ‰å¦‚æœŸè¢«å‘¼å«ï¼Œä¹Ÿèƒ½æ­é… <code>toHaveBeenCalledTimes()</code> ä¾†é€²è¡Œé©—è­‰ï¼š</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="js"><code><span class="line"><span style="color:#F97583">const</span><span style="color:#E1E4E8"> { </span><span style="color:#79B8FF">calculate1</span><span style="color:#E1E4E8"> } </span><span style="color:#F97583">=</span><span style="color:#B392F0"> require</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">'./index'</span><span style="color:#E1E4E8">);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#B392F0">describe</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">'calculate1'</span><span style="color:#E1E4E8">, () </span><span style="color:#F97583">=></span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#B392F0">  describe</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">'in jest isolation api style'</span><span style="color:#E1E4E8">, () </span><span style="color:#F97583">=></span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#6A737D">    // arrange</span></span>
<span class="line"><span style="color:#B392F0">    beforeEach</span><span style="color:#E1E4E8">(() </span><span style="color:#F97583">=></span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#E1E4E8">      jest.</span><span style="color:#B392F0">clearAllTimers</span><span style="color:#E1E4E8">();</span></span>
<span class="line"><span style="color:#E1E4E8">      jest.</span><span style="color:#B392F0">useFakeTimers</span><span style="color:#E1E4E8">();</span></span>
<span class="line"><span style="color:#E1E4E8">    });</span></span>
<span class="line"><span style="color:#B392F0">    it</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">'should return calculate result'</span><span style="color:#E1E4E8">, () </span><span style="color:#F97583">=></span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#6A737D">      // act, assert</span></span>
<span class="line"><span style="color:#B392F0">      calculate1</span><span style="color:#E1E4E8">(</span><span style="color:#79B8FF">1</span><span style="color:#E1E4E8">, </span><span style="color:#79B8FF">2</span><span style="color:#E1E4E8">, (</span><span style="color:#FFAB70">result</span><span style="color:#E1E4E8">) </span><span style="color:#F97583">=></span><span style="color:#B392F0"> expect</span><span style="color:#E1E4E8">(result).</span><span style="color:#B392F0">toBe</span><span style="color:#E1E4E8">(</span><span style="color:#79B8FF">3</span><span style="color:#E1E4E8">));</span></span>
<span class="line"><span style="color:#E1E4E8">    });</span></span>
<span class="line"><span style="color:#B392F0">    it</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">'should call setTimeout once'</span><span style="color:#E1E4E8">, () </span><span style="color:#F97583">=></span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#6A737D">      // arrange</span></span>
<span class="line"><span style="color:#E1E4E8">      jest.</span><span style="color:#B392F0">spyOn</span><span style="color:#E1E4E8">(global, </span><span style="color:#9ECBFF">'setTimeout'</span><span style="color:#E1E4E8">);</span></span>
<span class="line"><span style="color:#6A737D">      // act</span></span>
<span class="line"><span style="color:#B392F0">      calculate1</span><span style="color:#E1E4E8">(</span><span style="color:#79B8FF">1</span><span style="color:#E1E4E8">, </span><span style="color:#79B8FF">2</span><span style="color:#E1E4E8">);</span></span>
<span class="line"><span style="color:#6A737D">      // assert</span></span>
<span class="line"><span style="color:#B392F0">      expect</span><span style="color:#E1E4E8">(setTimeout).</span><span style="color:#B392F0">toHaveBeenCalledTimes</span><span style="color:#E1E4E8">(</span><span style="color:#79B8FF">1</span><span style="color:#E1E4E8">);</span></span>
<span class="line"><span style="color:#E1E4E8">    });</span></span>
<span class="line"><span style="color:#E1E4E8">  });</span></span>
<span class="line"><span style="color:#E1E4E8">});</span></span></code></pre>
<h4 id="for-setinterval">for <code>setInterval()</code></h4>
<p>ç•¶å–®å…ƒåŒ…å« <code>setInterval()</code> æ™‚ï¼Œå¯æ­é… <code>jest.advanceTimersToNextTimer()</code> ä¾†æ¨é€²è¨ˆæ™‚å™¨ã€‚åœ¨ä¸‹åˆ—ç¯„ä¾‹ä¸­ï¼Œæˆ‘å€‘å° <code>jest.advanceTimersToNextTimer()</code> å‚³å…¥åƒæ•¸ <code>2</code>ï¼Œä»£è¡¨è¨ˆæ™‚å™¨è¦è¢«è§¸ç™¼å…©æ¬¡â€”â€”å› æ­¤ <code>results</code> ä¹Ÿè©²å‡ºç¾å…©çµ„çµæœï¼š</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="js"><code><span class="line"><span style="color:#F97583">const</span><span style="color:#B392F0"> calculate2</span><span style="color:#F97583"> =</span><span style="color:#E1E4E8"> (</span><span style="color:#FFAB70">getInputsFn</span><span style="color:#E1E4E8">, </span><span style="color:#FFAB70">resultFn</span><span style="color:#E1E4E8">) </span><span style="color:#F97583">=></span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#B392F0">  setInterval</span><span style="color:#E1E4E8">(() </span><span style="color:#F97583">=></span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#F97583">    const</span><span style="color:#E1E4E8"> { </span><span style="color:#79B8FF">x</span><span style="color:#E1E4E8">, </span><span style="color:#79B8FF">y</span><span style="color:#E1E4E8"> } </span><span style="color:#F97583">=</span><span style="color:#B392F0"> getInputsFn</span><span style="color:#E1E4E8">();</span></span>
<span class="line"><span style="color:#B392F0">    resultFn</span><span style="color:#E1E4E8">(x </span><span style="color:#F97583">+</span><span style="color:#E1E4E8"> y);</span></span>
<span class="line"><span style="color:#E1E4E8">  }, </span><span style="color:#79B8FF">1000</span><span style="color:#E1E4E8">);</span></span>
<span class="line"><span style="color:#E1E4E8">};</span></span>
<span class="line"></span>
<span class="line"><span style="color:#B392F0">describe</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">'calculate2'</span><span style="color:#E1E4E8">, () </span><span style="color:#F97583">=></span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#B392F0">  beforeEach</span><span style="color:#E1E4E8">(() </span><span style="color:#F97583">=></span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#E1E4E8">    jest.</span><span style="color:#B392F0">clearAllTimers</span><span style="color:#E1E4E8">();</span></span>
<span class="line"><span style="color:#E1E4E8">    jest.</span><span style="color:#B392F0">useFakeTimers</span><span style="color:#E1E4E8">();</span></span>
<span class="line"><span style="color:#E1E4E8">  });</span></span>
<span class="line"><span style="color:#B392F0">  it</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">'should execute getInputsFn/resultFn at interval'</span><span style="color:#E1E4E8">, () </span><span style="color:#F97583">=></span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#6A737D">    // arrange</span></span>
<span class="line"><span style="color:#F97583">    let</span><span style="color:#E1E4E8"> xInput </span><span style="color:#F97583">=</span><span style="color:#79B8FF"> 1</span><span style="color:#E1E4E8">;</span></span>
<span class="line"><span style="color:#F97583">    let</span><span style="color:#E1E4E8"> yInput </span><span style="color:#F97583">=</span><span style="color:#79B8FF"> 2</span><span style="color:#E1E4E8">;</span></span>
<span class="line"><span style="color:#F97583">    const</span><span style="color:#79B8FF"> results</span><span style="color:#F97583"> =</span><span style="color:#E1E4E8"> [];</span></span>
<span class="line"><span style="color:#F97583">    const</span><span style="color:#B392F0"> resultFn</span><span style="color:#F97583"> =</span><span style="color:#E1E4E8"> (</span><span style="color:#FFAB70">r</span><span style="color:#E1E4E8">) </span><span style="color:#F97583">=></span><span style="color:#E1E4E8"> results.</span><span style="color:#B392F0">push</span><span style="color:#E1E4E8">(r);</span></span>
<span class="line"><span style="color:#F97583">    const</span><span style="color:#B392F0"> inputFn</span><span style="color:#F97583"> =</span><span style="color:#E1E4E8"> () </span><span style="color:#F97583">=></span><span style="color:#E1E4E8"> ({ x: xInput</span><span style="color:#F97583">++</span><span style="color:#E1E4E8">, y: yInput</span><span style="color:#F97583">++</span><span style="color:#E1E4E8"> });</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D">    // act</span></span>
<span class="line"><span style="color:#B392F0">    calculate2</span><span style="color:#E1E4E8">(inputFn, resultFn);</span></span>
<span class="line"><span style="color:#E1E4E8">    jest.</span><span style="color:#B392F0">advanceTimersToNextTimer</span><span style="color:#E1E4E8">(</span><span style="color:#79B8FF">2</span><span style="color:#E1E4E8">);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D">    // assert</span></span>
<span class="line"><span style="color:#B392F0">    expect</span><span style="color:#E1E4E8">(results[</span><span style="color:#79B8FF">0</span><span style="color:#E1E4E8">]).</span><span style="color:#B392F0">toBe</span><span style="color:#E1E4E8">(</span><span style="color:#79B8FF">3</span><span style="color:#E1E4E8">);</span></span>
<span class="line"><span style="color:#B392F0">    expect</span><span style="color:#E1E4E8">(results[</span><span style="color:#79B8FF">1</span><span style="color:#E1E4E8">]).</span><span style="color:#B392F0">toBe</span><span style="color:#E1E4E8">(</span><span style="color:#79B8FF">5</span><span style="color:#E1E4E8">);</span></span>
<span class="line"><span style="color:#E1E4E8">  });</span></span>
<span class="line"><span style="color:#E1E4E8">});</span></span></code></pre>
<h2 id="64-dealing-with-common-events">6.4 Dealing with common events</h2>
<p>ğŸ“¢ æº«é¦¨æç¤ºï¼šç‚ºäº†é †åˆ©åŸ·è¡Œä¸‹åˆ—æ¸¬è©¦ï¼Œè«‹è¨˜å¾—å®‰è£ <code>jest-environment-jsdom</code>ï¼Œå› ç‚ºæ­¤å¥—ä»¶<a href="https://jestjs.io/blog/2022/04/25/jest-28#jsdom-19">åœ¨ Jest 28 ä»¥å¾Œä¸å†æ˜¯é è¨­å®‰è£å…§å®¹</a>ã€‚</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="bash"><code><span class="line"><span style="color:#B392F0">Error:</span><span style="color:#9ECBFF"> ...</span></span>
<span class="line"><span style="color:#B392F0">As</span><span style="color:#9ECBFF"> of</span><span style="color:#9ECBFF"> Jest</span><span style="color:#79B8FF"> 28</span><span style="color:#9ECBFF"> "jsdom"</span><span style="color:#9ECBFF"> is</span><span style="color:#9ECBFF"> no</span><span style="color:#9ECBFF"> longer</span><span style="color:#9ECBFF"> shipped</span><span style="color:#9ECBFF"> by</span><span style="color:#9ECBFF"> default,</span><span style="color:#9ECBFF"> make</span><span style="color:#9ECBFF"> sure</span><span style="color:#9ECBFF"> to</span><span style="color:#9ECBFF"> install</span><span style="color:#9ECBFF"> it</span><span style="color:#9ECBFF"> separately.</span></span></code></pre>
<p>å¦å¤–ï¼Œåœ¨ Jest 28 ä»¥å¾Œä¹Ÿæ”¯æ´ã€Œ<a href="https://jestjs.io/blog/2022/04/25/jest-28#inline-testenvironmentoptions">æŒ‡å®šå€‹åˆ¥æ¸¬è©¦æª”æ¡ˆçš„ç’°å¢ƒ</a>ã€ã€‚éå»åªèƒ½é€é <code>jest.config</code> ä¸­çš„ <code>testEnvironment</code> ç‚ºæ‰€æœ‰çš„æ¸¬è©¦æŒ‡å®šä¸€ç¨®ç’°å¢ƒï¼ˆ<code>node</code> æˆ– <code>jsdom</code>ï¼‰ã€‚è€Œç¾åœ¨ï¼Œæˆ‘å€‘èƒ½åœ¨ã€Œéœ€è¦æ“ä½œ DOM çš„æ¸¬è©¦æª”æ¡ˆã€åŠ å…¥ä¸‹æ–¹è¨»è§£ä¾†æŒ‡å®šè©²æª”æ¡ˆçš„æ¸¬è©¦ç’°å¢ƒï¼š</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="js"><code><span class="line"><span style="color:#6A737D">/**</span></span>
<span class="line"><span style="color:#6A737D"> * @jest-environment jsdom</span></span>
<span class="line"><span style="color:#6A737D"> */</span></span></code></pre>
<h3 id="dealing-with-event-emitters">Dealing with event emitters</h3>
<p>æƒ³æ¸¬è©¦ä¸€å€‹åŒ…å« <code>window.dispatchEvent()</code> çš„å–®å…ƒæ™‚ï¼Œå¯ä»¥åœ¨ <code>beforeEach</code> ä¸­æ›è¼‰äº‹ä»¶ç›£è½å™¨ã€åœ¨ <code>afterEach</code> ç§»é™¤ä¹‹ï¼Œä¸¦æª¢æŸ¥å‡åŠŸèƒ½ <code>handler</code> æ˜¯å¦æœ‰å¦‚æœŸè¢«å‘¼å«ã€‚åƒè€ƒä»¥ä¸‹ç¯„ä¾‹ï¼š</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="ts"><code><span class="line"><span style="color:#6A737D">/**</span></span>
<span class="line"><span style="color:#6A737D"> * @jest-environment jsdom</span></span>
<span class="line"><span style="color:#6A737D"> */</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">const</span><span style="color:#B392F0"> emitMessageEvent</span><span style="color:#F97583"> =</span><span style="color:#E1E4E8"> (</span><span style="color:#FFAB70">detail</span><span style="color:#F97583">:</span><span style="color:#79B8FF"> string</span><span style="color:#E1E4E8">) </span><span style="color:#F97583">=></span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#F97583">  const</span><span style="color:#79B8FF"> event</span><span style="color:#F97583"> =</span><span style="color:#F97583"> new</span><span style="color:#B392F0"> CustomEvent</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">'message'</span><span style="color:#E1E4E8">, { detail });</span></span>
<span class="line"><span style="color:#E1E4E8">  window.</span><span style="color:#B392F0">dispatchEvent</span><span style="color:#E1E4E8">(event);</span></span>
<span class="line"><span style="color:#E1E4E8">};</span></span>
<span class="line"></span>
<span class="line"><span style="color:#B392F0">describe</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">'emitMessageEvent'</span><span style="color:#E1E4E8">, () </span><span style="color:#F97583">=></span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#F97583">  let</span><span style="color:#E1E4E8"> handler</span><span style="color:#F97583">:</span><span style="color:#B392F0"> jest</span><span style="color:#E1E4E8">.</span><span style="color:#B392F0">Mock</span><span style="color:#E1E4E8">;</span></span>
<span class="line"><span style="color:#B392F0">  beforeEach</span><span style="color:#E1E4E8">(() </span><span style="color:#F97583">=></span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#E1E4E8">    handler </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> jest.</span><span style="color:#B392F0">fn</span><span style="color:#E1E4E8">();</span></span>
<span class="line"><span style="color:#E1E4E8">    window.</span><span style="color:#B392F0">addEventListener</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">'message'</span><span style="color:#E1E4E8">, handler);</span></span>
<span class="line"><span style="color:#E1E4E8">  });</span></span>
<span class="line"><span style="color:#B392F0">  afterEach</span><span style="color:#E1E4E8">(() </span><span style="color:#F97583">=></span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#E1E4E8">    window.</span><span style="color:#B392F0">removeEventListener</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">'message'</span><span style="color:#E1E4E8">, handler);</span></span>
<span class="line"><span style="color:#E1E4E8">    handler.</span><span style="color:#B392F0">mockReset</span><span style="color:#E1E4E8">();</span></span>
<span class="line"><span style="color:#E1E4E8">  });</span></span>
<span class="line"><span style="color:#B392F0">  it</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">'should dispatch a custom event with the correct detail'</span><span style="color:#E1E4E8">, () </span><span style="color:#F97583">=></span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#6A737D">    // arrange</span></span>
<span class="line"><span style="color:#F97583">    const</span><span style="color:#79B8FF"> detail</span><span style="color:#F97583"> =</span><span style="color:#9ECBFF"> 'Test message'</span><span style="color:#E1E4E8">;</span></span>
<span class="line"><span style="color:#6A737D">    // act</span></span>
<span class="line"><span style="color:#B392F0">    emitMessageEvent</span><span style="color:#E1E4E8">(detail);</span></span>
<span class="line"><span style="color:#6A737D">    // assert</span></span>
<span class="line"><span style="color:#F97583">    const</span><span style="color:#E1E4E8"> [</span><span style="color:#79B8FF">event</span><span style="color:#E1E4E8">] </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> handler.mock.calls[</span><span style="color:#79B8FF">0</span><span style="color:#E1E4E8">];</span></span>
<span class="line"><span style="color:#B392F0">    expect</span><span style="color:#E1E4E8">((event </span><span style="color:#F97583">as</span><span style="color:#B392F0"> CustomEvent</span><span style="color:#E1E4E8">).detail).</span><span style="color:#B392F0">toBe</span><span style="color:#E1E4E8">(detail);</span></span>
<span class="line"><span style="color:#E1E4E8">  });</span></span>
<span class="line"><span style="color:#E1E4E8">});</span></span></code></pre>
<h3 id="dealing-with-click-events">Dealing with click events</h3>
<p>ç•¶æˆ‘å€‘æƒ³æ¸¬è©¦ã€Œä¸€å€‹ DOM çš„é»æ“Šäº‹ä»¶æ˜¯å¦æœ‰æ­£å¸¸é‹ä½œã€æ™‚ï¼Œå¯ä»¥æŠŠé‡é»æ”¾åœ¨ã€Œäº‹ä»¶æ´¾é€å¾Œï¼Œæª¢æŸ¥é æœŸçµæœæ˜¯å¦å‡ºç¾ã€ã€‚</p>
<p>ä»¥ä¸‹æ–¹ <code>index.html</code> èˆ‡ <code>index.js</code> ç‚ºä¾‹ï¼Œå…©è€…æ­é…èµ·ä¾†çš„è¡Œç‚ºæ˜¯ã€Œç•¶ä½¿ç”¨è€…é»æ“Š <code>id="myButton"</code> æŒ‰éˆ•å¾Œï¼Œç•«é¢ä¸Šçš„ <code>id="myResult"</code> è¦å‡ºç¾ <code>Clicked!</code> å­—æ¨£ã€ï¼š</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="html"><code><span class="line"><span style="color:#6A737D">&#x3C;!-- index.html --></span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8">&#x3C;!</span><span style="color:#85E89D">DOCTYPE</span><span style="color:#B392F0"> html</span><span style="color:#E1E4E8">></span></span>
<span class="line"><span style="color:#E1E4E8">&#x3C;</span><span style="color:#85E89D">html</span><span style="color:#B392F0"> lang</span><span style="color:#E1E4E8">=</span><span style="color:#9ECBFF">"en"</span><span style="color:#E1E4E8">></span></span>
<span class="line"><span style="color:#E1E4E8">  &#x3C;</span><span style="color:#85E89D">head</span><span style="color:#E1E4E8">></span></span>
<span class="line"><span style="color:#E1E4E8">    &#x3C;</span><span style="color:#85E89D">meta</span><span style="color:#B392F0"> charset</span><span style="color:#E1E4E8">=</span><span style="color:#9ECBFF">"UTF-8"</span><span style="color:#E1E4E8"> /></span></span>
<span class="line"><span style="color:#E1E4E8">    &#x3C;</span><span style="color:#85E89D">title</span><span style="color:#E1E4E8">>File to Be Tested&#x3C;/</span><span style="color:#85E89D">title</span><span style="color:#E1E4E8">></span></span>
<span class="line"><span style="color:#E1E4E8">    &#x3C;</span><span style="color:#85E89D">script</span><span style="color:#B392F0"> src</span><span style="color:#E1E4E8">=</span><span style="color:#9ECBFF">"./index.js"</span><span style="color:#E1E4E8">>&#x3C;/</span><span style="color:#85E89D">script</span><span style="color:#E1E4E8">></span></span>
<span class="line"><span style="color:#E1E4E8">  &#x3C;/</span><span style="color:#85E89D">head</span><span style="color:#E1E4E8">></span></span>
<span class="line"><span style="color:#E1E4E8">  &#x3C;</span><span style="color:#85E89D">body</span><span style="color:#E1E4E8">></span></span>
<span class="line"><span style="color:#E1E4E8">    &#x3C;</span><span style="color:#85E89D">div</span><span style="color:#E1E4E8">></span></span>
<span class="line"><span style="color:#E1E4E8">      &#x3C;</span><span style="color:#85E89D">h1</span><span style="color:#E1E4E8">>A simple button&#x3C;/</span><span style="color:#85E89D">h1</span><span style="color:#E1E4E8">></span></span>
<span class="line"><span style="color:#E1E4E8">      &#x3C;</span><span style="color:#85E89D">button</span><span style="color:#B392F0"> id</span><span style="color:#E1E4E8">=</span><span style="color:#9ECBFF">"myButton"</span><span style="color:#E1E4E8">>Click Me&#x3C;/</span><span style="color:#85E89D">button</span><span style="color:#E1E4E8">></span></span>
<span class="line"><span style="color:#E1E4E8">      &#x3C;</span><span style="color:#85E89D">div</span><span style="color:#B392F0"> id</span><span style="color:#E1E4E8">=</span><span style="color:#9ECBFF">"myResult"</span><span style="color:#E1E4E8">>Waiting...&#x3C;/</span><span style="color:#85E89D">div</span><span style="color:#E1E4E8">></span></span>
<span class="line"><span style="color:#E1E4E8">    &#x3C;/</span><span style="color:#85E89D">div</span><span style="color:#E1E4E8">></span></span>
<span class="line"><span style="color:#E1E4E8">  &#x3C;/</span><span style="color:#85E89D">body</span><span style="color:#E1E4E8">></span></span>
<span class="line"><span style="color:#E1E4E8">&#x3C;/</span><span style="color:#85E89D">html</span><span style="color:#E1E4E8">></span></span></code></pre>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="js"><code><span class="line"><span style="color:#6A737D">// index.js</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">function</span><span style="color:#B392F0"> onMyButtonClick</span><span style="color:#E1E4E8">() {</span></span>
<span class="line"><span style="color:#F97583">  const</span><span style="color:#79B8FF"> resultDiv</span><span style="color:#F97583"> =</span><span style="color:#E1E4E8"> document.</span><span style="color:#B392F0">getElementById</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">'myResult'</span><span style="color:#E1E4E8">);</span></span>
<span class="line"><span style="color:#E1E4E8">  resultDiv.innerText </span><span style="color:#F97583">=</span><span style="color:#9ECBFF"> 'Clicked!'</span><span style="color:#E1E4E8">;</span></span>
<span class="line"><span style="color:#E1E4E8">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8">window.</span><span style="color:#B392F0">addEventListener</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">'load'</span><span style="color:#E1E4E8">, () </span><span style="color:#F97583">=></span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#E1E4E8">  document</span></span>
<span class="line"><span style="color:#E1E4E8">    .</span><span style="color:#B392F0">getElementById</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">'myButton'</span><span style="color:#E1E4E8">)</span></span>
<span class="line"><span style="color:#E1E4E8">    .</span><span style="color:#B392F0">addEventListener</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">'click'</span><span style="color:#E1E4E8">, onMyButtonClick);</span></span>
<span class="line"><span style="color:#E1E4E8">});</span></span>
<span class="line"></span>
<span class="line"><span style="color:#79B8FF">module</span><span style="color:#E1E4E8">.</span><span style="color:#79B8FF">exports</span><span style="color:#F97583"> =</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#E1E4E8">  onMyButtonClick,</span></span>
<span class="line"><span style="color:#E1E4E8">};</span></span></code></pre>
<p>åœ¨æ’°å¯«æ¸¬è©¦æ™‚ï¼Œæˆ‘å€‘å¯ç›´æ¥åŸ·è¡Œ <code>onMyButtonClick()</code>ï¼Œå†æª¢æŸ¥å…ƒç´  <code>id="myResult"</code> çš„ <code>innerText</code> æ˜¯å¦æœ‰è®Šç‚ºé æœŸå…§å®¹ï¼š</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="js"><code><span class="line"><span style="color:#6A737D">/**</span></span>
<span class="line"><span style="color:#6A737D"> * @jest-environment jsdom</span></span>
<span class="line"><span style="color:#6A737D"> */</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">const</span><span style="color:#79B8FF"> fs</span><span style="color:#F97583"> =</span><span style="color:#B392F0"> require</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">'fs'</span><span style="color:#E1E4E8">);</span></span>
<span class="line"><span style="color:#F97583">const</span><span style="color:#79B8FF"> path</span><span style="color:#F97583"> =</span><span style="color:#B392F0"> require</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">'path'</span><span style="color:#E1E4E8">);</span></span>
<span class="line"><span style="color:#F97583">const</span><span style="color:#E1E4E8"> { </span><span style="color:#79B8FF">onMyButtonClick</span><span style="color:#E1E4E8"> } </span><span style="color:#F97583">=</span><span style="color:#B392F0"> require</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">'./index'</span><span style="color:#E1E4E8">);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">const</span><span style="color:#B392F0"> setHtmlContent</span><span style="color:#F97583"> =</span><span style="color:#E1E4E8"> () </span><span style="color:#F97583">=></span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#F97583">  const</span><span style="color:#79B8FF"> html</span><span style="color:#F97583"> =</span><span style="color:#E1E4E8"> fs.</span><span style="color:#B392F0">readFileSync</span><span style="color:#E1E4E8">(path.</span><span style="color:#B392F0">resolve</span><span style="color:#E1E4E8">(__dirname, </span><span style="color:#9ECBFF">'./index.html'</span><span style="color:#E1E4E8">), </span><span style="color:#9ECBFF">'utf8'</span><span style="color:#E1E4E8">);</span></span>
<span class="line"><span style="color:#E1E4E8">  document.documentElement.innerHTML </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> html;</span></span>
<span class="line"><span style="color:#E1E4E8">};</span></span>
<span class="line"><span style="color:#F97583">const</span><span style="color:#B392F0"> getTargetDiv</span><span style="color:#F97583"> =</span><span style="color:#E1E4E8"> () </span><span style="color:#F97583">=></span><span style="color:#E1E4E8"> document.</span><span style="color:#B392F0">getElementById</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">'myResult'</span><span style="color:#E1E4E8">);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#B392F0">describe</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">'Button click behavior'</span><span style="color:#E1E4E8">, () </span><span style="color:#F97583">=></span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#B392F0">  test</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">'myButton innerText should change after clicking'</span><span style="color:#E1E4E8">, () </span><span style="color:#F97583">=></span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#6A737D">    // arrange</span></span>
<span class="line"><span style="color:#B392F0">    setHtmlContent</span><span style="color:#E1E4E8">();</span></span>
<span class="line"><span style="color:#F97583">    const</span><span style="color:#79B8FF"> target</span><span style="color:#F97583"> =</span><span style="color:#B392F0"> getTargetDiv</span><span style="color:#E1E4E8">();</span></span>
<span class="line"><span style="color:#6A737D">    // act</span></span>
<span class="line"><span style="color:#B392F0">    onMyButtonClick</span><span style="color:#E1E4E8">();</span></span>
<span class="line"><span style="color:#6A737D">    // assert</span></span>
<span class="line"><span style="color:#B392F0">    expect</span><span style="color:#E1E4E8">(target.innerText).</span><span style="color:#B392F0">toBe</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">'Clicked!'</span><span style="color:#E1E4E8">);</span></span>
<span class="line"><span style="color:#E1E4E8">  });</span></span>
<span class="line"><span style="color:#E1E4E8">});</span></span></code></pre>
<p>æ­¤æ¦‚å¿µé¡ä¼¼ä¸Šæ–¹æéçš„ã€Œåˆ†é›¢é€²å…¥é»ï¼ˆextracting and entry pointï¼‰ã€ï¼Œæˆ‘å€‘ä¸ä¸€å®šè¦åœ¨æ¸¬è©¦ä¸­é‰…ç´°é¡éºåœ°é‡ç¾ä½¿ç”¨è€…çš„è¡Œç‚ºï¼Œé‡é»æ˜¯<strong>æŸå€‹åŠŸèƒ½è¢«è§¸ç™¼å¾Œï¼Œæ˜¯å¦æœ‰ç”¢ç”Ÿé æœŸçµæœ</strong>ã€‚</p>
<blockquote>
<p>What we care about is that the click has actually done something useful other than triggering.</p>
</blockquote>
<p>ä»¥ä¸Šä¾¿æ˜¯æœ¬æ›¸ç¬¬å…­ç« çš„ç­†è¨˜å…§å®¹ï¼Œæ­å–œä½ ææ‡‚å¦‚ä½•æ¸¬è©¦é‚£äº›å¸¶æœ‰éåŒæ­¥åŠŸèƒ½çš„å–®å…ƒäº†ã€‚</p>
<h2 id="åƒè€ƒæ–‡ä»¶">åƒè€ƒæ–‡ä»¶</h2>
<ul>
<li><a href="https://www.manning.com/books/the-art-of-unit-testing-third-edition">Manning: The Art of Unit Testing, Third Edition</a></li>
</ul> </div>   <footer class="footer" data-astro-cid-qlgq3onj>
Tzu Yin (Charlie) ğŸ¦Š Made in Taiwan
</footer>  </section>  </body></html> 